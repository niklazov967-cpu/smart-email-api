<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏ - Smart Email API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .queries-list {
            margin-top: 20px;
        }

        .query-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .query-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .query-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .query-item.main-topic {
            border-color: #4facfe;
            background: #e8f7ff;
        }

        .query-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .query-content {
            flex: 1;
        }

        .query-cn {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .query-ru {
            font-size: 14px;
            color: #666;
        }

        .query-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-main {
            background: #4facfe;
            color: white;
        }

        .badge-relevance {
            background: #e0e0e0;
            color: #666;
        }

        .badge-high {
            background: #4caf50;
            color: white;
        }

        .badge-medium {
            background: #ff9800;
            color: white;
        }

        .badge-low {
            background: #f44336;
            color: white;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Credits Display */
        .credits-display {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: #2d3436;
        }

        .credits-display h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .credit-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .credit-value {
            font-weight: 700;
            font-size: 16px;
        }

        .cost-highlight {
            font-size: 24px;
            font-weight: 700;
            color: #d63031;
        }

        /* Progress Bar */
        .progress-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Button loading state */
        .button.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }

        .button.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Instructions */
        .instructions {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .instructions h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #333;
        }

        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .instructions .highlight {
            background: #fff59d;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .next-step {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
        }

        .next-step strong {
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

        <div class="header">
            <h1>üîç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏</h1>
            <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤—ã–±–æ—Ä –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–µ–º—ã –ø–æ–∏—Å–∫–∞</p>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h3>üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h3>
            <ol>
                <li><span class="highlight">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É</span> –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‰∏çÈîàÈí¢Êï∞ÊéßËΩ¶Èì£Âä†Â∑•)</li>
                <li>–£–∫–∞–∂–∏—Ç–µ <span class="highlight">–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤</span> (–æ—Ç 5 –¥–æ 50)</li>
                <li>–ù–∞–∂–º–∏—Ç–µ <span class="highlight">"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã"</span> –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥)</li>
                <li><span class="highlight">–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</span> –≥–∞–ª–æ—á–∫–∞–º–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"</li>
                <li>–ù–∞–∂–º–∏—Ç–µ <span class="highlight">"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä"</span></li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ <span class="highlight">Session ID</span> –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
                <li>–ù–∞ –≥–ª–∞–≤–Ω–æ–π –≤—Å—Ç–∞–≤—å—Ç–µ Session ID –∏ –Ω–∞–∂–º–∏—Ç–µ <span class="highlight">"–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"</span></li>
            </ol>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <h3>‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <!-- Credits Display -->
        <div class="credits-display" id="creditsDisplay" style="display: none;">
            <h3>üí∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)</h3>
            <div class="credit-item">
                <span>–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤:</span>
                <span class="credit-value" id="totalRequests">0</span>
            </div>
            <div class="credit-item">
                <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤:</span>
                <span class="credit-value" id="totalTokens">0</span>
            </div>
            <div class="credit-item">
                <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                <span class="cost-highlight" id="totalCost">$0.0000</span>
            </div>
        </div>

        <!-- Step 1: Generate Queries -->
        <div class="card" id="generateCard">
            <h2>–®–∞–≥ 1Ô∏è‚É£: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã</h2>
            
            <div class="input-group">
                <label>–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ (–Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º):</label>
                <input type="text" id="mainTopic" placeholder="‰∏çÈîàÈí¢Êï∞ÊéßËΩ¶Èì£Âä†Â∑•">
            </div>

            <div class="input-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤:</label>
                <input type="number" id="queryCount" value="10" min="5" max="50">
                <small style="color: #666; display: block; margin-top: 5px;">
                    ‚ö†Ô∏è –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (30+) –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30-40 —Å–µ–∫—É–Ω–¥
                </small>
            </div>

            <div class="input-group">
                <label>Session ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="sessionId" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏">
            </div>

            <button class="button" id="generateBtn">
                ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
            </button>
        </div>

        <!-- Step 2: View and Select Queries -->
        <div class="card" id="queriesCard" style="display: none;">
            <h2>–®–∞–≥ 2Ô∏è‚É£: –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –≤—ã–±–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤</h2>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalQueriesCount">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="selectedCount">0</div>
                    <div class="stat-label">–í—ã–±—Ä–∞–Ω–æ</div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <button class="button secondary" id="selectAllBtn">‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button class="button secondary" id="deselectAllBtn">‚úó –°–Ω—è—Ç—å –≤—Å–µ</button>
                <button class="button success" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä</button>
            </div>

            <div class="queries-list" id="queriesList"></div>

            <!-- Next Step Instructions -->
            <div class="next-step" id="nextStepInstructions" style="display: none;">
                <h3>‚úÖ –ó–∞–ø—Ä–æ—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</h3>
                <p><strong>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:</strong></p>
                <ol>
                    <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ Session ID: <code id="displaySessionId" style="background: #fff; padding: 3px 8px; border-radius: 4px;"></code></li>
                    <li>–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ <a href="/" style="color: #f57c00; font-weight: 600;">–≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a></li>
                    <li>–í—Å—Ç–∞–≤—å—Ç–µ Session ID –≤ –ø–æ–ª–µ "Session ID"</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"</li>
                    <li>–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="/progress.html" style="color: #f57c00; font-weight: 600;">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</a></li>
                </ol>
            </div>
        </div>

        <!-- Message area -->
        <div id="messageArea"></div>
    </div>

    <script>
        let currentSessionId = null;
        let allQueries = [];
        let creditsUpdateInterval = null;

        // Generate queries
        async function generateQueries() {
            console.log('=== generateQueries START ===');
            
            const mainTopic = document.getElementById('mainTopic').value.trim();
            const queryCount = parseInt(document.getElementById('queryCount').value);
            const sessionId = document.getElementById('sessionId').value.trim();
            const generateBtn = document.getElementById('generateBtn');

            console.log('Input values:', { mainTopic, queryCount, sessionId });

            if (!mainTopic) {
                console.warn('No main topic provided');
                showMessage('–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º—É', 'error');
                return;
            }

            try {
                console.log('Starting generation process...');
                
                // Show progress and disable button
                generateBtn.classList.add('loading');
                generateBtn.disabled = true;
                console.log('Button disabled, showing progress');
                
                showProgress('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DeepSeek API...');

                let response;
                if (sessionId) {
                    console.log('Using existing session:', sessionId);
                    updateProgress(20, '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–µ—Å—Å–∏–∏...');
                    
                    response = await fetch(`/api/topics/${sessionId}/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target_count: queryCount })
                    });
                    
                    console.log('Response status:', response.status);
                    currentSessionId = sessionId;
                } else {
                    console.log('Creating new session');
                    updateProgress(20, `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ${queryCount} –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤...`);
                    
                    response = await fetch('/api/topics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            main_topic: mainTopic,
                            target_count: queryCount
                        })
                    });
                    
                    console.log('Response status:', response.status);
                }

                updateProgress(60, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç DeepSeek...');

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    console.log('Success! Processing results...');
                    updateProgress(80, '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤...');
                    
                    allQueries = data.data.queries;
                    currentSessionId = data.data.session_id;
                    
                    console.log('Queries:', allQueries.length, 'Session ID:', currentSessionId);
                    
                    updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                    
                    setTimeout(() => {
                        displayQueries(allQueries);
                        hideProgress();
                        showMessage(`‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${allQueries.length} –∑–∞–ø—Ä–æ—Å–æ–≤! Session ID: ${currentSessionId}`, 'success');
                        
                        // Start credits monitoring if we have a session
                        if (currentSessionId) {
                            console.log('Starting credits monitoring');
                            startCreditsMonitoring(currentSessionId);
                        }
                    }, 500);
                } else {
                    console.error('API returned error:', data.error);
                    hideProgress();
                    showMessage('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('Exception in generateQueries:', error);
                hideProgress();
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            } finally {
                console.log('Cleaning up...');
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
                console.log('=== generateQueries END ===');
            }
        }

        // Display queries
        function displayQueries(queries) {
            document.getElementById('queriesCard').style.display = 'block';
            document.getElementById('totalQueriesCount').textContent = queries.length;
            
            const queriesList = document.getElementById('queriesList');
            queriesList.innerHTML = '';

            queries.forEach((query, index) => {
                const item = document.createElement('div');
                item.className = 'query-item';
                if (query.is_selected || query.is_main) {
                    item.classList.add('selected');
                }
                if (query.is_main) {
                    item.classList.add('main-topic');
                }

                const relevanceBadge = getRelevanceBadge(query.relevance);

                item.innerHTML = `
                    <input type="checkbox" 
                           class="query-checkbox" 
                           id="query-${index}"
                           ${query.is_selected || query.is_main ? 'checked' : ''}
                           ${query.is_main ? 'disabled' : ''}
                           onchange="updateSelection()">
                    <div class="query-content">
                        <div class="query-cn">${query.query_cn}</div>
                        <div class="query-ru">${query.query_ru}</div>
                    </div>
                    ${query.is_main ? '<span class="query-badge badge-main">–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞</span>' : ''}
                    <span class="query-badge ${relevanceBadge.class}">${relevanceBadge.text}</span>
                `;

                item.dataset.queryId = query.query_id;
                queriesList.appendChild(item);
            });

            updateSelection();
        }

        function getRelevanceBadge(relevance) {
            if (relevance >= 80) {
                return { class: 'badge-high', text: `${relevance}% —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å` };
            } else if (relevance >= 50) {
                return { class: 'badge-medium', text: `${relevance}% —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å` };
            } else {
                return { class: 'badge-low', text: `${relevance}% —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å` };
            }
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.query-checkbox:not(:disabled)');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            // +1 for main topic (always selected)
            document.getElementById('selectedCount').textContent = checkedCount + 1;

            // Update visual state
            checkboxes.forEach(checkbox => {
                const item = checkbox.closest('.query-item');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('.query-checkbox:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelection();
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('.query-checkbox:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelection();
        }

        async function saveSelection() {
            console.log('=== saveSelection START ===');
            console.log('Current session ID:', currentSessionId);
            
            if (!currentSessionId) {
                console.error('No session ID available');
                showMessage('Session ID –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const checkboxes = document.querySelectorAll('.query-checkbox');
            const selectedIds = [];
            const saveBtn = document.getElementById('saveBtn');

            console.log('Found checkboxes:', checkboxes.length);

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const item = checkbox.closest('.query-item');
                    const queryId = item.dataset.queryId;
                    if (queryId) {
                        selectedIds.push(queryId);
                    }
                }
            });

            console.log('Selected IDs:', selectedIds);

            if (selectedIds.length === 0) {
                console.warn('No queries selected');
                showMessage('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å', 'error');
                return;
            }

            try {
                console.log('Saving selection...');
                saveBtn.classList.add('loading');
                saveBtn.disabled = true;
                
                const url = `/api/topics/${currentSessionId}/select`;
                const body = { selected_query_ids: selectedIds };
                
                console.log('POST', url, body);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    console.log('Selection saved successfully');
                    showMessage(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${selectedIds.length} –∑–∞–ø—Ä–æ—Å–æ–≤!`, 'success');
                    
                    // Show next step instructions
                    const nextStepDiv = document.getElementById('nextStepInstructions');
                    const displaySessionIdEl = document.getElementById('displaySessionId');
                    displaySessionIdEl.textContent = currentSessionId;
                    nextStepDiv.style.display = 'block';
                    
                    console.log('Scrolling to instructions');
                    // Scroll to instructions
                    nextStepDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    console.error('Save failed:', data.error);
                    showMessage('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('Exception in saveSelection:', error);
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            } finally {
                console.log('Cleaning up...');
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
                console.log('=== saveSelection END ===');
            }
        }

        // Credits monitoring
        function startCreditsMonitoring(sessionId) {
            const creditsDisplay = document.getElementById('creditsDisplay');
            creditsDisplay.style.display = 'block';

            // Clear previous interval if exists
            if (creditsUpdateInterval) {
                clearInterval(creditsUpdateInterval);
            }

            // Update immediately
            updateCredits(sessionId);

            // Update every 2 seconds
            creditsUpdateInterval = setInterval(() => {
                updateCredits(sessionId);
            }, 2000);
        }

        async function updateCredits(sessionId) {
            try {
                const response = await fetch(`/api/credits/${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    const credits = data.data;
                    document.getElementById('totalRequests').textContent = credits.total_requests;
                    document.getElementById('totalTokens').textContent = credits.total_tokens.toLocaleString();
                    document.getElementById('totalCost').textContent = credits.formatted_cost;
                }
            } catch (error) {
                console.error('Failed to update credits:', error);
            }
        }

        // Utility functions
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error' : 'success-message';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function showLoading(message) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="loading">${message}</div>`;
        }

        function hideLoading() {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
        }

        // Progress Bar Functions
        function showProgress(message) {
            const container = document.getElementById('progressContainer');
            container.classList.add('active');
            updateProgress(0, message);
        }

        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
            text.textContent = message;
        }

        function hideProgress() {
            const container = document.getElementById('progressContainer');
            container.classList.remove('active');
        }

        // Load queries if session ID is in URL
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            
            if (sessionId) {
                document.getElementById('sessionId').value = sessionId;
                currentSessionId = sessionId;
                loadExistingQueries(sessionId);
            }
        });

        async function loadExistingQueries(sessionId) {
            try {
                showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤...');

                const response = await fetch(`/api/topics/${sessionId}/queries`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    allQueries = data.data;
                    displayQueries(allQueries);
                    startCreditsMonitoring(sessionId);
                }

            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (creditsUpdateInterval) {
                clearInterval(creditsUpdateInterval);
            }
        });

        // Event Listeners for buttons
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, attaching event listeners...');
            
            // Generate button
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', async () => {
                    console.log('Generate button clicked');
                    await generateQueries();
                });
                console.log('Generate button listener attached');
            }

            // Select All button
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => {
                    console.log('Select All clicked');
                    selectAll();
                });
            }

            // Deselect All button
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', () => {
                    console.log('Deselect All clicked');
                    deselectAll();
                });
            }

            // Save button
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    console.log('Save button clicked');
                    await saveSelection();
                });
                console.log('Save button listener attached');
            }

            console.log('All event listeners attached successfully');
        });
    </script>
</body>
</html>

