<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ—à–∞–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - Smart Email API</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      width: 0%;
    }

    .stage-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      opacity: 0.5;
      transition: all 0.3s ease;
    }

    .stage-card.active {
      opacity: 1;
      border: 2px solid #667eea;
    }

    .stage-card.completed {
      opacity: 1;
      background: #f0f7ff;
    }

    .stage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .stage-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    .stage-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: #e0e0e0;
    }

    .stage-card.active .stage-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      animation: pulse 2s infinite;
    }

    .stage-card.completed .stage-icon {
      background: #10b981;
      color: white;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .stage-status {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #e0e0e0;
      color: #666;
    }

    .status-active {
      background: #667eea;
      color: white;
      animation: blink 2s infinite;
    }

    .status-completed {
      background: #10b981;
      color: white;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stage-content {
      display: none;
    }

    .stage-card.active .stage-content,
    .stage-card.completed .stage-content {
      display: block;
    }

    .results-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .result-item:last-child {
      margin-bottom: 0;
    }

    .result-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-detail {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .result-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #e0e0e0;
      color: #666;
    }

    .result-badge.high { background: #10b981; color: white; }
    .result-badge.medium { background: #f59e0b; color: white; }
    .result-badge.low { background: #6b7280; color: white; }

    .loading {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: #f0f7ff;
      border-radius: 8px;
      margin: 20px 0;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #667eea;
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #f0f7ff;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .session-selector {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .info-box {
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .info-box p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
      <h1>
        <span>üë£</span>
        –ü–æ—à–∞–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
      </h1>
      <p>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞. –í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –ø–æ—Å–ª–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.</p>
      <div class="progress-bar">
        <div class="progress-fill" id="overallProgress"></div>
      </div>
    </div>

    <!-- –í—ã–±–æ—Ä —Å–µ—Å—Å–∏–∏ -->
    <div class="session-selector" id="sessionSelector">
      <h2 style="margin-bottom: 15px;">üìã –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é</h2>
      <select id="sessionSelect">
        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π...</option>
      </select>
      <div class="info-box">
        <p><strong>üí° –°–æ–≤–µ—Ç:</strong> –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–µ—Å—Å–∏—é –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.</p>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="startBtn" disabled>
          <span>‚ñ∂Ô∏è</span>
          –ù–∞—á–∞—Ç—å –ø–æ—à–∞–≥–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/'">
          <span>üè†</span>
          –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </button>
      </div>
    </div>

    <!-- –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
    <div id="stagesContainer" style="display: none;">
      <!-- Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π -->
      <div class="stage-card" id="stage1" data-stage="1">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üè¢</div>
            <span>–≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</span>
          </div>
          <div class="stage-status status-pending" id="status1">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading1" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ò—â—É –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º...</div>
          </div>
          <div id="results1" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat1-queries">0</div>
                <div class="stat-label">–ó–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat1-companies">0</div>
                <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList1"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue1">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ -->
      <div class="stage-card" id="stage2" data-stage="2">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üåê</div>
            <span>–≠—Ç–∞–ø 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤</span>
          </div>
          <div class="stage-status status-pending" id="status2">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading2" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ò—â—É –≤–µ–±-—Å–∞–π—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π...</div>
          </div>
          <div id="results2" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat2-companies">0</div>
                <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat2-websites">0</div>
                <div class="stat-label">–°–∞–π—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList2"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue2">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 3: –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
      <div class="stage-card" id="stage3" data-stage="3">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üìß</div>
            <span>–≠—Ç–∞–ø 3: –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</span>
          </div>
          <div class="stage-status status-pending" id="status3">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading3" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–µ–±-—Å–∞–π—Ç—ã –∏ –∏—â—É –∫–æ–Ω—Ç–∞–∫—Ç—ã...</div>
          </div>
          <div id="results3" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat3-websites">0</div>
                <div class="stat-label">–°–∞–π—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat3-contacts">0</div>
                <div class="stat-label">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList3"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue3">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 4: –ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ -->
      <div class="stage-card" id="stage4" data-stage="4">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üîç</div>
            <span>–≠—Ç–∞–ø 4: –ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤</span>
          </div>
          <div class="stage-status status-pending" id="status4">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading4" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã...</div>
          </div>
          <div id="results4" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat4-companies">0</div>
                <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat4-services">0</div>
                <div class="stat-label">–°–µ—Ä–≤–∏—Å–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList4"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue4">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ -->
      <div class="stage-card" id="stage5" data-stage="5">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üè∑Ô∏è</div>
            <span>–≠—Ç–∞–ø 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤</span>
          </div>
          <div class="stage-status status-pending" id="status5">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading5" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ–≥–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...</div>
          </div>
          <div id="results5" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat5-companies">0</div>
                <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat5-tags">0</div>
                <div class="stat-label">–¢–µ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList5"></div>
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="window.location.href='/companies.html'">
                <span>üìä</span>
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏
              </button>
              <button class="btn btn-secondary" onclick="window.location.href='/'">
                <span>üè†</span>
                –ù–∞ –≥–ª–∞–≤–Ω—É—é
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentSessionId = null;
    let currentStage = 0;

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏–∏
    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const data = await response.json();
        
        const select = document.getElementById('sessionSelect');
        
        if (data.data && data.data.length > 0) {
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é...</option>';
          data.data.forEach(session => {
            const option = document.createElement('option');
            option.value = session.session_id;
            option.textContent = `${session.topic_description} (${new Date(session.created_at).toLocaleDateString()})`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Å—Å–∏–π</option>';
        }
      } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('sessionSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–µ—Å—Å–∏–∏
    document.getElementById('sessionSelect').addEventListener('change', (e) => {
      currentSessionId = e.target.value;
      document.getElementById('startBtn').disabled = !currentSessionId;
    });

    // –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
    document.getElementById('startBtn').addEventListener('click', async () => {
      if (!currentSessionId) return;
      
      document.getElementById('sessionSelector').style.display = 'none';
      document.getElementById('stagesContainer').style.display = 'block';
      
      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–µ—Å—Å–∏–∏
      try {
        const progressResponse = await fetch(`/api/sessions/${currentSessionId}/stage-progress`);
        const progressData = await progressResponse.json();
        
        if (progressData.success) {
          const lastCompleted = progressData.lastCompletedStage;
          const nextStage = progressData.nextStage;
          
          if (lastCompleted > 0) {
            // –ï—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã - –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –∫–∞–∫ completed
            for (let i = 1; i <= lastCompleted; i++) {
              const stageCard = document.getElementById(`stage${i}`);
              const statusEl = document.getElementById(`status${i}`);
              stageCard.classList.add('completed');
              statusEl.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
              statusEl.className = 'stage-status status-completed';
              
              // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
              await loadCachedStageResults(i, currentSessionId);
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏
            if (nextStage) {
              if (confirm(`–≠—Ç–∞–ø—ã 1-${lastCompleted} —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —ç—Ç–∞–ø–∞ ${nextStage}?`)) {
                runStage(nextStage);
              } else {
                runStage(1);
              }
            } else {
              alert('–í—Å–µ —ç—Ç–∞–ø—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! ‚úÖ');
            }
          } else {
            // –ù–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
            runStage(1);
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –Ω–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ
          runStage(1);
        }
      } catch (error) {
        console.error('Error checking progress:', error);
        runStage(1);
      }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–∞–ø–∞
    async function loadCachedStageResults(stageNum, sessionId) {
      try {
        const response = await fetch(`/api/sessions/${sessionId}/process-stage/${stageNum}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success && data.cached) {
          await displayStageResults(stageNum, data.data);
          
          const resultsEl = document.getElementById(`results${stageNum}`);
          resultsEl.style.display = 'block';
          
          // –î–æ–±–∞–≤–∏—Ç—å –±–µ–π–¥–∂ "–ö—ç—à–∏—Ä–æ–≤–∞–Ω–æ"
          const cachedBadge = document.createElement('div');
          cachedBadge.className = 'info-box';
          cachedBadge.style.marginTop = '10px';
          cachedBadge.innerHTML = `
            <p>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${new Date(data.completedAt).toLocaleString('ru-RU')})</p>
          `;
          resultsEl.insertBefore(cachedBadge, resultsEl.firstChild);
        }
      } catch (error) {
        console.error(`Error loading cached results for stage ${stageNum}:`, error);
      }
    }

    // –ó–∞–ø—É—Å–∫ —ç—Ç–∞–ø–∞
    async function runStage(stageNum) {
      currentStage = stageNum;
      updateProgress();
      
      const stageCard = document.getElementById(`stage${stageNum}`);
      const statusEl = document.getElementById(`status${stageNum}`);
      const loadingEl = document.getElementById(`loading${stageNum}`);
      const resultsEl = document.getElementById(`results${stageNum}`);
      
      // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
      stageCard.classList.add('active');
      statusEl.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
      statusEl.className = 'stage-status status-active';
      loadingEl.style.display = 'flex';
      resultsEl.style.display = 'none';
      
      try {
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–∞–ø–∞
        const response = await fetch(`/api/sessions/${currentSessionId}/process-stage/${stageNum}`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('Stage processing failed');
        
        const data = await response.json();
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        await displayStageResults(stageNum, data.data);
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        loadingEl.style.display = 'none';
        resultsEl.style.display = 'block';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—ç—à–µ –µ—Å–ª–∏ —ç—Ç–∞–ø –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ
        if (data.cached) {
          const cachedInfo = document.createElement('div');
          cachedInfo.className = 'info-box';
          cachedInfo.style.marginBottom = '15px';
          cachedInfo.innerHTML = `
            <p><strong>‚ö° –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞</strong></p>
            <p style="font-size: 12px; margin-top: 5px;">
              –≠—Ç–∞–ø –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ: ${new Date(data.completedAt).toLocaleString('ru-RU')}<br>
              –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${data.duration?.toFixed(2) || 'N/A'} —Å–µ–∫
            </p>
          `;
          resultsEl.insertBefore(cachedInfo, resultsEl.firstChild);
        }
        
        statusEl.textContent = data.cached ? '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫—ç—à–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
        statusEl.className = 'stage-status status-completed';
        stageCard.classList.remove('active');
        stageCard.classList.add('completed');
        
        // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
        const continueBtn = document.getElementById(`continue${stageNum}`);
        if (continueBtn && stageNum < 5) {
          continueBtn.onclick = () => runStage(stageNum + 1);
        }
        
      } catch (error) {
        console.error(`Error in stage ${stageNum}:`, error);
        loadingEl.style.display = 'none';
        resultsEl.innerHTML = `<div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <p>–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Ç–∞–ø–∞</p>
        </div>`;
        resultsEl.style.display = 'block';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–∞–ø–∞
    async function displayStageResults(stageNum, data) {
      const listEl = document.getElementById(`resultsList${stageNum}`);
      
      if (stageNum === 1) {
        // Stage 1: –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
        const companies = data.companies || [];
        document.getElementById('stat1-queries').textContent = data.queriesProcessed || 0;
        document.getElementById('stat1-companies').textContent = companies.length;
        
        if (companies.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = companies.map(company => `
            <div class="result-item">
              <div class="result-title">
                <span>üè¢</span>
                <span>${company.name || company.company_name}</span>
                ${company.relevance ? `<span class="result-badge ${getRelevanceClass(company.relevance)}">${company.relevance}%</span>` : ''}
              </div>
              ${company.query_text ? `<div class="result-detail">üìù –ó–∞–ø—Ä–æ—Å: ${company.query_text}</div>` : ''}
              ${company.domain_extension ? `<div class="result-detail">üåê –î–æ–º–µ–Ω: ${company.domain_extension}</div>` : ''}
            </div>
          `).join('');
        }
        
      } else if (stageNum === 2) {
        // Stage 2: –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã
        const websites = data.websites || [];
        document.getElementById('stat2-companies').textContent = data.companiesProcessed || 0;
        document.getElementById('stat2-websites').textContent = websites.length;
        
        if (websites.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–°–∞–π—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = websites.map(site => `
            <div class="result-item">
              <div class="result-title">
                <span>üåê</span>
                <span>${site.company_name}</span>
              </div>
              <div class="result-detail">üîó <a href="${site.website}" target="_blank">${site.website}</a></div>
              ${site.confidence ? `<div class="result-detail">‚úÖ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${site.confidence}%</div>` : ''}
            </div>
          `).join('');
        }
        
      } else if (stageNum === 3) {
        // Stage 3: –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
        const contacts = data.contacts || [];
        document.getElementById('stat3-websites').textContent = data.websitesProcessed || 0;
        document.getElementById('stat3-contacts').textContent = contacts.length;
        
        if (contacts.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = contacts.map(contact => `
            <div class="result-item">
              <div class="result-title">
                <span>üìß</span>
                <span>${contact.company_name}</span>
              </div>
              ${contact.email ? `<div class="result-detail">‚úâÔ∏è Email: ${contact.email}</div>` : ''}
              ${contact.phone ? `<div class="result-detail">üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${contact.phone}</div>` : ''}
              ${contact.contact_page ? `<div class="result-detail">üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: <a href="${contact.contact_page}" target="_blank">${contact.contact_page}</a></div>` : ''}
            </div>
          `).join('');
        }
        
      } else if (stageNum === 4) {
        // Stage 4: –°–µ—Ä–≤–∏—Å—ã
        const services = data.services || [];
        document.getElementById('stat4-companies').textContent = data.companiesProcessed || 0;
        document.getElementById('stat4-services').textContent = services.reduce((sum, s) => sum + (s.services?.length || 0), 0);
        
        if (services.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–°–µ—Ä–≤–∏—Å—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = services.map(item => `
            <div class="result-item">
              <div class="result-title">
                <span>üîç</span>
                <span>${item.company_name}</span>
              </div>
              ${item.services && item.services.length > 0 ? 
                `<div class="result-detail">üõ†Ô∏è –°–µ—Ä–≤–∏—Å—ã: ${item.services.join(', ')}</div>` : 
                '<div class="result-detail">‚ö†Ô∏è –°–µ—Ä–≤–∏—Å—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã</div>'
              }
            </div>
          `).join('');
        }
        
      } else if (stageNum === 5) {
        // Stage 5: –¢–µ–≥–∏
        const tags = data.tags || [];
        document.getElementById('stat5-companies').textContent = data.companiesProcessed || 0;
        document.getElementById('stat5-tags').textContent = tags.reduce((sum, t) => sum + (t.tags?.length || 0), 0);
        
        if (tags.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–¢–µ–≥–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = tags.map(item => `
            <div class="result-item">
              <div class="result-title">
                <span>üè∑Ô∏è</span>
                <span>${item.company_name}</span>
              </div>
              ${item.tags && item.tags.length > 0 ? 
                `<div class="result-detail">üè∑Ô∏è ${item.tags.map(tag => `<span class="result-badge">${tag}</span>`).join(' ')}</div>` : 
                '<div class="result-detail">‚ö†Ô∏è –¢–µ–≥–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</div>'
              }
            </div>
          `).join('');
        }
      }
    }

    function getRelevanceClass(relevance) {
      if (relevance >= 80) return 'high';
      if (relevance >= 50) return 'medium';
      return 'low';
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    function updateProgress() {
      const progress = (currentStage / 5) * 100;
      document.getElementById('overallProgress').style.width = `${progress}%`;
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadSessions();
  </script>
</body>
</html>

