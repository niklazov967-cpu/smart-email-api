<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ—à–∞–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - Smart Email API</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      width: 0%;
    }

    .stage-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      opacity: 0.5;
      transition: all 0.3s ease;
    }

    .stage-card.active {
      opacity: 1;
      border: 2px solid #667eea;
    }

    .stage-card.completed {
      opacity: 1;
      background: #f0f7ff;
    }

    .stage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .stage-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    .stage-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: #e0e0e0;
    }

    .stage-card.active .stage-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      animation: pulse 2s infinite;
    }

    .stage-card.completed .stage-icon {
      background: #10b981;
      color: white;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .stage-status {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #e0e0e0;
      color: #666;
    }

    .status-active {
      background: #667eea;
      color: white;
      animation: blink 2s infinite;
    }

    .status-completed {
      background: #10b981;
      color: white;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stage-content {
      display: none;
    }

    .stage-card.active .stage-content,
    .stage-card.completed .stage-content {
      display: block;
    }

    .results-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .result-item:last-child {
      margin-bottom: 0;
    }

    .result-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-detail {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .result-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #e0e0e0;
      color: #666;
    }

    .result-badge.high { background: #10b981; color: white; }
    .result-badge.medium { background: #f59e0b; color: white; }
    .result-badge.low { background: #6b7280; color: white; }

    .badge-new {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: 8px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      background: #f0f7ff;
      border-radius: 8px;
      margin: 20px 0;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #667eea;
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #f0f7ff;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .session-selector {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .info-box {
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .info-box p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
      <h1>
        <span>üë£</span>
        –ü–æ—à–∞–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
      </h1>
      <p>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞. –í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –ø–æ—Å–ª–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.</p>
      <div style="margin-top: 10px; margin-bottom: 10px;">
        <button onclick="clearDatabase()" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
          üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        </button>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="overallProgress"></div>
      </div>
    </div>

    <!-- –í—ã–±–æ—Ä —Å–µ—Å—Å–∏–∏ -->
    <div class="session-selector" id="sessionSelector">
      <h2 style="margin-bottom: 15px;">üìã –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é</h2>
      <select id="sessionSelect">
        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π...</option>
      </select>
      
      <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ -->
      <div id="sessionInfo" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h3 style="margin: 0 0 15px 0; color: #667eea;">üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏</h3>
        <p style="margin-bottom: 8px;"><strong>–ó–∞–ø—Ä–æ—Å:</strong> <span id="sessionQuery" style="color: #667eea;"></span></p>
        <p style="margin-bottom: 8px;"><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> <span id="sessionDate"></span></p>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º -->
        <div id="companiesStats" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
          <h4 style="margin: 0 0 10px 0; color: #667eea;">üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏:</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
            <div style="padding: 10px; background: #f0f9ff; border-radius: 5px;">
              <div style="font-size: 24px; font-weight: bold; color: #0284c7;" id="totalCompanies">0</div>
              <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</div>
            </div>
            <div style="padding: 10px; background: #fef3c7; border-radius: 5px;">
              <div style="font-size: 24px; font-weight: bold; color: #d97706;" id="unprocessedCompanies">0</div>
              <div style="font-size: 12px; color: #666;">–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
            </div>
            <div style="padding: 10px; background: #dcfce7; border-radius: 5px;">
              <div style="font-size: 24px; font-weight: bold; color: #16a34a;" id="completedCompanies">0</div>
              <div style="font-size: 12px; color: #666;">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
            </div>
          </div>
          
          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —ç—Ç–∞–ø–∞–º -->
          <div id="stageReadiness" style="display: none; padding: 15px; background: #f0f9ff; border-radius: 5px; border-left: 4px solid #0284c7; margin-top: 10px;">
            <p id="readinessMessage" style="margin: 0; color: #0c4a6e; font-size: 14px;"></p>
          </div>
          
          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —ç—Ç–∞–ø–æ–≤ -->
          <div id="stageProgress" style="display: none; padding: 15px; background: #fef3c7; border-radius: 5px; border-left: 4px solid #f59e0b; margin-top: 10px;">
            <h5 style="margin: 0 0 8px 0; color: #92400e;">‚ö†Ô∏è –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</h5>
            <p id="progressMessage" style="margin: 0; color: #92400e; font-size: 14px;"></p>
            <button id="clearProgressBtn" style="margin-top: 10px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
              üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
            </button>
          </div>
        </div>
      </div>
      
      <div class="info-box">
        <p><strong>üí° –°–æ–≤–µ—Ç:</strong> –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–µ—Å—Å–∏—é –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.</p>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="startBtn" disabled>
          <span>‚ñ∂Ô∏è</span>
          –ù–∞—á–∞—Ç—å –ø–æ—à–∞–≥–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/'">
          <span>üè†</span>
          –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </button>
      </div>
    </div>

    <!-- –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
    <div id="stagesContainer" style="display: none;">
      <!-- Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π -->
      <div class="stage-card" id="stage1" data-stage="1">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üè¢</div>
            <span>–≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</span>
          </div>
          <div class="stage-status status-pending" id="status1">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading1" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ò—â—É –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º...</div>
          </div>
          <div id="results1" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat1-queries">0</div>
                <div class="stat-label">–ó–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat1-companies">0</div>
                <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList1"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue1">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ -->
      <div class="stage-card" id="stage2" data-stage="2">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üåê</div>
            <span>–≠—Ç–∞–ø 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤</span>
          </div>
          <div class="stage-status status-pending" id="status2">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading2" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ò—â—É –≤–µ–±-—Å–∞–π—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π...</div>
          </div>
          <div id="results2" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat2-companies">0</div>
                <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat2-websites">0</div>
                <div class="stat-label">–°–∞–π—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList2"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue2">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 3: –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
      <div class="stage-card" id="stage3" data-stage="3">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">üìß</div>
            <span>–≠—Ç–∞–ø 3: –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</span>
          </div>
          <div class="stage-status status-pending" id="status3">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading3" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–µ–±-—Å–∞–π—Ç—ã –∏ –∏—â—É –∫–æ–Ω—Ç–∞–∫—Ç—ã...</div>
          </div>
          <div id="results3" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat3-websites">0</div>
                <div class="stat-label">–°–∞–π—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat3-contacts">0</div>
                <div class="stat-label">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
            <div class="results-list" id="resultsList3"></div>
            <div class="action-buttons">
              <button class="btn btn-success" id="continue3">
                <span>‚úÖ</span>
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è -->
      <div class="stage-card" id="stage4" data-stage="4">
        <div class="stage-header">
          <div class="stage-title">
            <div class="stage-icon">ü§ñ</div>
            <span>–≠—Ç–∞–ø 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è</span>
          </div>
          <div class="stage-status status-pending" id="status4">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        </div>
        <div class="stage-content">
          <div id="loading4" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">AI –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–º–ø–∞–Ω–∏–π —Ç–µ–º–µ –ø–æ–∏—Å–∫–∞...</div>
          </div>
          <div id="results4" style="display: none;">
            <div class="stats">
              <div class="stat-card">
                <div class="stat-value" id="stat4-total">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #00C851 0%, #007E33 100%);">
                <div class="stat-value" id="stat4-validated">0</div>
                <div class="stat-label">‚úÖ –ü—Ä–æ—à–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #ffbb33 0%, #ff8800 100%);">
                <div class="stat-value" id="stat4-review">0</div>
                <div class="stat-label">‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);">
                <div class="stat-value" id="stat4-rejected">0</div>
                <div class="stat-label">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω—ã</div>
              </div>
            </div>
            <div class="results-list" id="resultsList4"></div>
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="window.location.href='/companies.html'">
                <span>üìä</span>
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏
              </button>
              <button class="btn btn-secondary" onclick="window.location.href='/'">
                <span>üè†</span>
                –ù–∞ –≥–ª–∞–≤–Ω—É—é
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentSessionId = null;
    let currentStage = 0;

    // Clear Database
    async function clearDatabase() {
      const confirmed = confirm(
        '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n' +
        '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ:\n' +
        '‚Ä¢ –í—Å–µ —Å–µ—Å—Å–∏–∏\n' +
        '‚Ä¢ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã\n' +
        '‚Ä¢ –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏\n' +
        '‚Ä¢ –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏\n' +
        '‚Ä¢ –í–µ—Å—å –∫–µ—à API\n\n' +
        '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n' +
        '–í—ã —É–≤–µ—Ä–µ–Ω—ã?'
      );

      if (!confirmed) return;

      const doubleConfirmed = confirm(
        'üî¥ –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!\n\n' +
        '–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã.\n\n' +
        '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
      );

      if (!doubleConfirmed) return;

      try {
        const response = await fetch('/api/sessions/clear-all', {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞!\n\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏–∏
    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const data = await response.json();
        
        const select = document.getElementById('sessionSelect');
        
        if (!data.data || data.data.length === 0) {
          select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Å—Å–∏–π</option>';
          return;
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏
        const sessionsWithStats = await Promise.all(
          data.data.map(async (session) => {
            try {
              const companiesRes = await fetch(`/api/debug/companies`);
              const companiesData = await companiesRes.json();
              
              // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
              const sessionCompanies = companiesData.companies?.filter(
                c => c.session_id === session.session_id
              ) || [];
              
              // –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ (–±–µ–∑ stage 'completed')
              const unprocessed = sessionCompanies.filter(
                c => !c.stage || c.stage !== 'completed'
              ).length;
              
              return {
                ...session,
                totalCompanies: sessionCompanies.length,
                unprocessedCount: unprocessed,
                processedCount: sessionCompanies.length - unprocessed
              };
            } catch (err) {
              console.error('Failed to load stats for session:', session.session_id, err);
              return { ...session, totalCompanies: 0, unprocessedCount: 0, processedCount: 0 };
            }
          })
        );
        
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é...</option>';
        sessionsWithStats.forEach(session => {
          const option = document.createElement('option');
          option.value = session.session_id;
          
          let displayText = `${session.topic_description} (${new Date(session.created_at).toLocaleDateString()})`;
          if (session.totalCompanies > 0) {
            displayText += ` | ${session.unprocessedCount} –Ω–µ–æ–±—Ä–∞–±.`;
          }
          
          option.textContent = displayText;
          option.dataset.query = session.search_query || session.topic_description;
          option.dataset.date = session.created_at;
          option.dataset.totalCompanies = session.totalCompanies;
          option.dataset.unprocessedCount = session.unprocessedCount;
          option.dataset.processedCount = session.processedCount;
          
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('sessionSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–µ—Å—Å–∏–∏
    document.getElementById('sessionSelect').addEventListener('change', async (e) => {
      currentSessionId = e.target.value;
      document.getElementById('startBtn').disabled = !currentSessionId;
      
      if (currentSessionId) {
        await updateSessionInfo();
      } else {
        document.getElementById('sessionInfo').style.display = 'none';
      }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏–∏
    async function updateSessionInfo() {
      const select = document.getElementById('sessionSelect');
      const sessionInfo = document.getElementById('sessionInfo');
      const companiesStats = document.getElementById('companiesStats');
      const selectedOption = select.options[select.selectedIndex];
      
      if (!selectedOption || !selectedOption.value) {
        sessionInfo.style.display = 'none';
        return;
      }
      
      const sessionId = selectedOption.value;
      
      // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      document.getElementById('sessionQuery').textContent = selectedOption.dataset.query || 'N/A';
      const date = new Date(selectedOption.dataset.date);
      document.getElementById('sessionDate').textContent = date.toLocaleString('ru-RU');
      
      sessionInfo.style.display = 'block';
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏
      const totalCompanies = parseInt(selectedOption.dataset.totalCompanies) || 0;
      
      if (totalCompanies > 0) {
        companiesStats.style.display = 'block';
        
        const unprocessed = parseInt(selectedOption.dataset.unprocessedCount) || 0;
        const processed = parseInt(selectedOption.dataset.processedCount) || 0;
        
        document.getElementById('totalCompanies').textContent = totalCompanies;
        document.getElementById('unprocessedCompanies').textContent = unprocessed;
        document.getElementById('completedCompanies').textContent = processed;
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ç–∞–ø–æ–≤
        try {
          const progressResponse = await fetch(`/api/sessions/${sessionId}/stage-progress`);
          const progressData = await progressResponse.json();
          
          if (progressData.success && progressData.lastCompletedStage > 0) {
            // –ï—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã - –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const lastCompleted = progressData.lastCompletedStage;
            const nextStage = progressData.nextStage;
            
            const stageProgress = document.getElementById('stageProgress');
            const progressMessage = document.getElementById('progressMessage');
            
            stageProgress.style.display = 'block';
            
            if (nextStage) {
              progressMessage.innerHTML = `
                <strong>–≠—Ç–∞–ø—ã 1-${lastCompleted} —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.</strong><br>
                –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —ç—Ç–∞–ø–∞ ${nextStage}.
              `;
            } else {
              progressMessage.innerHTML = `
                <strong>–í—Å–µ —ç—Ç–∞–ø—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</strong><br>
                –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –æ—á–∏—Å—Ç–∏–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å.
              `;
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            document.getElementById('clearProgressBtn').onclick = async () => {
              if (confirm('‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏?\n\n–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å —ç—Ç–∞–ø–∞ 1.')) {
                try {
                  // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
                  const response = await fetch(`/api/sessions/${sessionId}/clear-progress`, {
                    method: 'DELETE'
                  });
                  
                  if (response.ok) {
                    alert('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—á–∏—â–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.');
                    // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    await updateSessionInfo();
                  } else {
                    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É.');
                  }
                } catch (error) {
                  alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                }
              }
            };
          } else {
            document.getElementById('stageProgress').style.display = 'none';
          }
        } catch (error) {
          console.error('Error checking progress:', error);
          document.getElementById('stageProgress').style.display = 'none';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        const stageReadiness = document.getElementById('stageReadiness');
        const readinessMessage = document.getElementById('readinessMessage');
        
        if (totalCompanies > 0 && unprocessed === 0) {
          stageReadiness.style.display = 'block';
          stageReadiness.style.background = '#dcfce7';
          stageReadiness.style.borderColor = '#16a34a';
          readinessMessage.style.color = '#166534';
          readinessMessage.innerHTML = '‚úÖ <strong>–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!</strong> –í—Å–µ ' + totalCompanies + ' –∫–æ–º–ø–∞–Ω–∏–π –ø—Ä–æ—à–ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏.';
        } else if (unprocessed > 0) {
          stageReadiness.style.display = 'block';
          stageReadiness.style.background = '#fef3c7';
          stageReadiness.style.borderColor = '#f59e0b';
          readinessMessage.style.color = '#92400e';
          readinessMessage.innerHTML = '‚è≥ <strong>' + unprocessed + ' –∫–æ–º–ø–∞–Ω–∏–π —Ç—Ä–µ–±—É—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏.</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ—à–∞–≥–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏.';
        } else {
          stageReadiness.style.display = 'none';
        }
      } else {
        companiesStats.style.display = 'none';
      }
    }

    // –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
    document.getElementById('startBtn').addEventListener('click', async () => {
      if (!currentSessionId) return;
      
      document.getElementById('sessionSelector').style.display = 'none';
      document.getElementById('stagesContainer').style.display = 'block';
      
      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–µ—Å—Å–∏–∏
      try {
        const progressResponse = await fetch(`/api/sessions/${currentSessionId}/stage-progress`);
        const progressData = await progressResponse.json();
        
        if (progressData.success) {
          const lastCompleted = progressData.lastCompletedStage;
          const nextStage = progressData.nextStage;
          
          if (lastCompleted > 0) {
            // –ï—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã - –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –∫–∞–∫ completed
            for (let i = 1; i <= lastCompleted; i++) {
              const stageCard = document.getElementById(`stage${i}`);
              const statusEl = document.getElementById(`status${i}`);
              stageCard.classList.add('completed');
              statusEl.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
              statusEl.className = 'stage-status status-completed';
              
              // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
              await loadCachedStageResults(i, currentSessionId);
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏
            if (nextStage) {
              if (confirm(`–≠—Ç–∞–ø—ã 1-${lastCompleted} —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —ç—Ç–∞–ø–∞ ${nextStage}?`)) {
                runStage(nextStage);
              } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è - –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Å–µ—Å—Å–∏–∏
                document.getElementById('sessionSelector').style.display = 'block';
                document.getElementById('stagesContainer').style.display = 'none';
                alert('‚ÑπÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.\n\n–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –æ—á–∏—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏–∏.');
              }
            } else {
              alert('–í—Å–µ —ç—Ç–∞–ø—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! ‚úÖ');
              // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Å–µ—Å—Å–∏–∏
              document.getElementById('sessionSelector').style.display = 'block';
              document.getElementById('stagesContainer').style.display = 'none';
            }
          } else {
            // –ù–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
            runStage(1);
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –Ω–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ
          runStage(1);
        }
      } catch (error) {
        console.error('Error checking progress:', error);
        runStage(1);
      }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–∞–ø–∞
    async function loadCachedStageResults(stageNum, sessionId) {
      try {
        const response = await fetch(`/api/sessions/${sessionId}/process-stage/${stageNum}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success && data.cached) {
          await displayStageResults(stageNum, data.data);
          
          const resultsEl = document.getElementById(`results${stageNum}`);
          resultsEl.style.display = 'block';
          
          // –î–æ–±–∞–≤–∏—Ç—å –±–µ–π–¥–∂ "–ö—ç—à–∏—Ä–æ–≤–∞–Ω–æ"
          const cachedBadge = document.createElement('div');
          cachedBadge.className = 'info-box';
          cachedBadge.style.marginTop = '10px';
          cachedBadge.innerHTML = `
            <p>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${new Date(data.completedAt).toLocaleString('ru-RU')})</p>
          `;
          resultsEl.insertBefore(cachedBadge, resultsEl.firstChild);
        }
      } catch (error) {
        console.error(`Error loading cached results for stage ${stageNum}:`, error);
      }
    }

    // –ó–∞–ø—É—Å–∫ —ç—Ç–∞–ø–∞
    async function runStage(stageNum) {
      currentStage = stageNum;
      updateProgress();
      
      const stageCard = document.getElementById(`stage${stageNum}`);
      const statusEl = document.getElementById(`status${stageNum}`);
      const loadingEl = document.getElementById(`loading${stageNum}`);
      const resultsEl = document.getElementById(`results${stageNum}`);
      
      // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
      stageCard.classList.add('active');
      statusEl.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
      statusEl.className = 'stage-status status-active';
      loadingEl.style.display = 'flex';
      resultsEl.style.display = 'none';
      
      try {
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–∞–ø–∞
        const response = await fetch(`/api/sessions/${currentSessionId}/process-stage/${stageNum}`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('Stage processing failed');
        
        const data = await response.json();
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        await displayStageResults(stageNum, data.data);
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        loadingEl.style.display = 'none';
        resultsEl.style.display = 'block';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—ç—à–µ –µ—Å–ª–∏ —ç—Ç–∞–ø –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ
        if (data.cached) {
          const cachedInfo = document.createElement('div');
          cachedInfo.className = 'info-box';
          cachedInfo.style.marginBottom = '15px';
          cachedInfo.innerHTML = `
            <p><strong>‚ö° –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞</strong></p>
            <p style="font-size: 12px; margin-top: 5px;">
              –≠—Ç–∞–ø –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ: ${new Date(data.completedAt).toLocaleString('ru-RU')}<br>
              –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${data.duration?.toFixed(2) || 'N/A'} —Å–µ–∫
            </p>
          `;
          resultsEl.insertBefore(cachedInfo, resultsEl.firstChild);
        }
        
        statusEl.textContent = data.cached ? '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫—ç—à–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
        statusEl.className = 'stage-status status-completed';
        stageCard.classList.remove('active');
        stageCard.classList.add('completed');
        
        // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
        const continueBtn = document.getElementById(`continue${stageNum}`);
        if (continueBtn && stageNum < 4) {
          continueBtn.onclick = () => runStage(stageNum + 1);
        }
        
      } catch (error) {
        console.error(`Error in stage ${stageNum}:`, error);
        loadingEl.style.display = 'none';
        resultsEl.innerHTML = `<div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <p>–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Ç–∞–ø–∞</p>
        </div>`;
        resultsEl.style.display = 'block';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–∞–ø–∞
    async function displayStageResults(stageNum, data) {
      const listEl = document.getElementById(`resultsList${stageNum}`);
      
      if (stageNum === 1) {
        // Stage 1: –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
        const companies = data.companies || [];
        document.getElementById('stat1-queries').textContent = data.queriesProcessed || 0;
        document.getElementById('stat1-companies').textContent = companies.length;
        
        if (companies.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = companies.map(company => `
            <div class="result-item">
              <div class="result-title">
                <span>üè¢</span>
                <span>${company.name || company.company_name}</span>
                ${company.relevance ? `<span class="result-badge ${getRelevanceClass(company.relevance)}">${company.relevance}%</span>` : ''}
              </div>
              ${company.website ? `<div class="result-detail">üåê <a href="${company.website}" target="_blank">${company.website}</a> <span class="badge-new">‚ú® –ù–∞–π–¥–µ–Ω —Å—Ä–∞–∑—É!</span></div>` : ''}
              ${company.email ? `<div class="result-detail">‚úâÔ∏è Email: ${company.email} <span class="badge-new">‚ú® –ù–∞–π–¥–µ–Ω —Å—Ä–∞–∑—É!</span></div>` : ''}
              ${company.phone ? `<div class="result-detail">üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${company.phone} <span class="badge-new">‚ú® –ù–∞–π–¥–µ–Ω —Å—Ä–∞–∑—É!</span></div>` : ''}
              ${company.description ? `<div class="result-detail">üìù ${company.description}</div>` : ''}
              ${company.query_text ? `<div class="result-detail" style="opacity:0.7">üîç –ó–∞–ø—Ä–æ—Å: ${company.query_text}</div>` : ''}
              ${company.domain_extension ? `<div class="result-detail" style="opacity:0.7">üåê –î–æ–º–µ–Ω: ${company.domain_extension}</div>` : ''}
            </div>
          `).join('');
        }
        
      } else if (stageNum === 2) {
        // Stage 2: –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã
        const websites = data.websites || [];
        document.getElementById('stat2-companies').textContent = data.companiesProcessed || 0;
        document.getElementById('stat2-websites').textContent = websites.length;
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ Stage 2 –±—ã–ª –ø—Ä–æ–ø—É—â–µ–Ω
        if (data.skipped) {
          listEl.innerHTML = `
            <div class="info-box" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 10px 0;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span style="font-size: 24px;">‚ú®</span>
                <strong style="color: #1976d2;">Stage 2 –ø—Ä–æ–ø—É—â–µ–Ω</strong>
              </div>
              <p style="margin: 0 0 15px 0; color: #555;">${data.reason} - Stage 2 –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è!</p>
            </div>
            ${websites.map(site => `
              <div class="result-item">
                <div class="result-title">
                  <span>üåê</span>
                  <span>${site.company_name}</span>
                  <span class="result-badge found-immediately">‚ú® Stage 1</span>
                </div>
                <div class="result-detail">üîó <a href="${site.website}" target="_blank">${site.website}</a></div>
                ${site.email ? `<div class="result-detail">‚úâÔ∏è Email: ${site.email}</div>` : ''}
                ${site.confidence ? `<div class="result-detail">‚úÖ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${site.confidence}%</div>` : ''}
              </div>
            `).join('')}
          `;
        } else if (websites.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–°–∞–π—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = websites.map(site => `
            <div class="result-item">
              <div class="result-title">
                <span>üåê</span>
                <span>${site.company_name}</span>
              </div>
              <div class="result-detail">üîó <a href="${site.website}" target="_blank">${site.website}</a></div>
              ${site.confidence ? `<div class="result-detail">‚úÖ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${site.confidence}%</div>` : ''}
            </div>
          `).join('');
        }
        
      } else if (stageNum === 3) {
        // Stage 3: –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
        const contacts = data.contacts || [];
        document.getElementById('stat3-websites').textContent = data.websitesProcessed || 0;
        document.getElementById('stat3-contacts').textContent = contacts.length;
        
        if (contacts.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        } else {
          listEl.innerHTML = contacts.map(contact => `
            <div class="result-item">
              <div class="result-title">
                <span>üìß</span>
                <span>${contact.company_name}</span>
              </div>
              ${contact.email ? `<div class="result-detail">‚úâÔ∏è Email: ${contact.email}</div>` : ''}
              ${contact.phone ? `<div class="result-detail">üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${contact.phone}</div>` : ''}
              ${contact.contact_page ? `<div class="result-detail">üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: <a href="${contact.contact_page}" target="_blank">${contact.contact_page}</a></div>` : ''}
            </div>
          `).join('');
        }
        
      } else if (stageNum === 4) {
        // Stage 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è
        const companies = data.companies || [];
        document.getElementById('stat4-total').textContent = data.total || 0;
        document.getElementById('stat4-validated').textContent = data.validated || 0;
        document.getElementById('stat4-review').textContent = data.needsReview || 0;
        document.getElementById('stat4-rejected').textContent = data.rejected || 0;
        
        if (companies.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        } else {
          listEl.innerHTML = companies.map(company => {
            let icon = '‚ö†Ô∏è';
            let statusText = '–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏';
            let statusColor = '#ffbb33';
            
            if (company.stage === 'completed') {
              icon = '‚úÖ';
              statusText = '–ü—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é';
              statusColor = '#00C851';
            } else if (company.stage === 'rejected') {
              icon = '‚ùå';
              statusText = '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞';
              statusColor = '#ff4444';
            }
            
            return `
              <div class="result-item">
                <div class="result-title">
                  <span>${icon}</span>
                  <span>${company.company_name}</span>
                  <span class="result-badge" style="background: ${statusColor}">
                    ${company.validation_score || 0}%
                  </span>
                </div>
                <div class="result-detail">
                  <strong style="color: ${statusColor}">${statusText}</strong>
                </div>
                ${company.validation_reason ? `
                  <div class="result-detail" style="opacity: 0.8">
                    üí¨ ${company.validation_reason}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');
        }
      }
    }

    function getRelevanceClass(relevance) {
      if (relevance >= 80) return 'high';
      if (relevance >= 50) return 'medium';
      return 'low';
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    function updateProgress() {
      const progress = (currentStage / 4) * 100;
      document.getElementById('overallProgress').style.width = `${progress}%`;
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadSessions();
  </script>
</body>
</html>

