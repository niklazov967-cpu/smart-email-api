<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API –†–∞—Å—Ö–æ–¥—ã –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        /* –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .summary-card h3 {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .summary-card .value {
            color: #2d3748;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card .subtext {
            color: #a0aec0;
            font-size: 13px;
        }

        .summary-card.cost .value {
            color: #16a34a;
        }

        .summary-card.tokens .value {
            color: #2563eb;
        }

        .summary-card.calls .value {
            color: #9333ea;
        }

        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .filters h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .table-header {
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
        }

        .table-header h2 {
            color: #2d3748;
            font-size: 20px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #4a5568;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            color: #2d3748;
            font-size: 14px;
            border-bottom: 1px solid #f1f5f9;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-perplexity {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-deepseek {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge-stage1 {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-stage2 {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .badge-stage3 {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge-stage4 {
            background: #fed7aa;
            color: #9a3412;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #a0aec0;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* –ì—Ä–∞—Ñ–∏–∫–∏ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chart-card h3 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            min-width: 120px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .bar-container {
            flex: 1;
            height: 30px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: #4a5568;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1>
                üìä API –†–∞—Å—Ö–æ–¥—ã –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </h1>
            <p>–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –Ω–∞ API –≤—ã–∑–æ–≤—ã, —Ç–æ–∫–µ–Ω—ã –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ —ç—Ç–∞–ø–∞–º</p>
        </div>

        <!-- –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        <div class="summary-cards">
            <div class="summary-card cost">
                <h3>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                <div class="value" id="totalCost">$0.00</div>
                <div class="subtext">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
            </div>
            <div class="summary-card tokens">
                <h3>–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤</h3>
                <div class="value" id="totalTokens">0</div>
                <div class="subtext">–ó–∞–ø—Ä–æ—Å + –û—Ç–≤–µ—Ç</div>
            </div>
            <div class="summary-card calls">
                <h3>API –≤—ã–∑–æ–≤–æ–≤</h3>
                <div class="value" id="totalCalls">0</div>
                <div class="subtext">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            </div>
            <div class="summary-card">
                <h3>–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                <div class="value" id="avgCost">$0.00</div>
                <div class="subtext">–ù–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤</div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>–†–∞—Å—Ö–æ–¥—ã –ø–æ —ç—Ç–∞–ø–∞–º</h3>
                <div class="bar-chart" id="stageChart"></div>
            </div>
            <div class="chart-card">
                <h3>–†–∞—Å—Ö–æ–¥—ã –ø–æ –º–æ–¥–µ–ª—è–º</h3>
                <div class="bar-chart" id="modelChart"></div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters">
            <h2>üîç –§–∏–ª—å—Ç—Ä—ã</h2>
            <div class="filter-grid">
                <div class="filter-group">
                    <label>–≠—Ç–∞–ø</label>
                    <select id="stageFilter">
                        <option value="">–í—Å–µ —ç—Ç–∞–ø—ã</option>
                        <option value="stage1">Stage 1 (–ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π)</option>
                        <option value="stage2">Stage 2 (–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤)</option>
                        <option value="stage3">Stage 3 (–ü–æ–∏—Å–∫ email)</option>
                        <option value="stage4">Stage 4 (AI –≤–∞–ª–∏–¥–∞—Ü–∏—è)</option>
                        <option value="query_generation">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–ú–æ–¥–µ–ª—å AI</label>
                    <select id="modelFilter">
                        <option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
                        <option value="sonar">Sonar (Basic)</option>
                        <option value="sonar-pro">Sonar Pro</option>
                        <option value="deepseek-chat">DeepSeek Chat</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –æ—Ç</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –¥–æ</label>
                    <input type="date" id="dateTo">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="exportToCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
        <div class="table-container">
            <div class="table-header">
                <h2>üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤</h2>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                            <th>–≠—Ç–∞–ø</th>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–¢–æ–∫–µ–Ω—ã (–ó–∞–ø—Ä–æ—Å)</th>
                            <th>–¢–æ–∫–µ–Ω—ã (–û—Ç–≤–µ—Ç)</th>
                            <th>–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤</th>
                            <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (USD)</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable">
                        <tr>
                            <td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="prevPage" onclick="changePage(-1)">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                <span class="page-info">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span id="currentPage">1</span> –∏–∑ <span id="totalPages">1</span>
                </span>
                <button id="nextPage" onclick="changePage(1)">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        let allLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        const logsPerPage = 50;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadLogs() {
            try {
                const response = await fetch('/api/credits/logs');
                const data = await response.json();
                
                if (data.success) {
                    allLogs = data.logs || [];
                    applyFilters();
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        function applyFilters() {
            const stageFilter = document.getElementById('stageFilter').value;
            const modelFilter = document.getElementById('modelFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredLogs = allLogs.filter(log => {
                // –§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–ø—É
                if (stageFilter && !log.stage?.includes(stageFilter)) return false;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏
                if (modelFilter && !log.model_name?.includes(modelFilter)) return false;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                const logDate = new Date(log.timestamp);
                if (dateFrom && logDate < new Date(dateFrom)) return false;
                if (dateTo && logDate > new Date(dateTo + 'T23:59:59')) return false;
                
                return true;
            });

            currentPage = 1;
            updateSummary();
            updateCharts();
            renderTable();
        }

        // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        function resetFilters() {
            document.getElementById('stageFilter').value = '';
            document.getElementById('modelFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            applyFilters();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        function updateSummary() {
            const totalCost = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.cost_usd) || 0), 0);
            const totalTokens = filteredLogs.reduce((sum, log) => sum + (parseInt(log.total_tokens) || 0), 0);
            const totalCalls = filteredLogs.length;
            const avgCost = totalCalls > 0 ? totalCost / totalCalls : 0;

            document.getElementById('totalCost').textContent = '$' + totalCost.toFixed(4);
            document.getElementById('totalTokens').textContent = totalTokens.toLocaleString();
            document.getElementById('totalCalls').textContent = totalCalls.toLocaleString();
            document.getElementById('avgCost').textContent = '$' + avgCost.toFixed(4);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏
        function updateCharts() {
            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —ç—Ç–∞–ø–∞–º
            const stageStats = {};
            filteredLogs.forEach(log => {
                const stage = log.stage || 'unknown';
                if (!stageStats[stage]) {
                    stageStats[stage] = 0;
                }
                stageStats[stage] += parseFloat(log.cost_usd) || 0;
            });

            const maxStageCost = Math.max(...Object.values(stageStats), 0.0001);
            const stageChart = document.getElementById('stageChart');
            stageChart.innerHTML = Object.entries(stageStats)
                .sort((a, b) => b[1] - a[1])
                .map(([stage, cost]) => {
                    const percentage = (cost / maxStageCost) * 100;
                    const label = stage.replace('stage', 'Stage ').replace('_', ' ');
                    return `
                        <div class="bar-item">
                            <div class="bar-label">${label}</div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percentage}%">
                                    $${cost.toFixed(4)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–æ–¥–µ–ª—è–º
            const modelStats = {};
            filteredLogs.forEach(log => {
                const model = log.model_name || 'unknown';
                if (!modelStats[model]) {
                    modelStats[model] = 0;
                }
                modelStats[model] += parseFloat(log.cost_usd) || 0;
            });

            const maxModelCost = Math.max(...Object.values(modelStats), 0.0001);
            const modelChart = document.getElementById('modelChart');
            modelChart.innerHTML = Object.entries(modelStats)
                .sort((a, b) => b[1] - a[1])
                .map(([model, cost]) => {
                    const percentage = (cost / maxModelCost) * 100;
                    return `
                        <div class="bar-item">
                            <div class="bar-label">${model}</div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percentage}%">
                                    $${cost.toFixed(4)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
        function renderTable() {
            const tableBody = document.getElementById('logsTable');
            
            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                            <p>–ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</p>
                        </td>
                    </tr>
                `;
                updatePagination();
                return;
            }

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const startIndex = (currentPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const pageData = filteredLogs.slice(startIndex, endIndex);

            tableBody.innerHTML = pageData.map(log => {
                const date = new Date(log.timestamp);
                const formattedDate = date.toLocaleString('ru-RU');
                
                let stageBadge = getStageBadge(log.stage);
                let modelBadge = getModelBadge(log.model_name);

                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${stageBadge}</td>
                        <td>${modelBadge}</td>
                        <td>${(log.request_tokens || 0).toLocaleString()}</td>
                        <td>${(log.response_tokens || 0).toLocaleString()}</td>
                        <td><strong>${(log.total_tokens || 0).toLocaleString()}</strong></td>
                        <td><strong style="color: #16a34a;">$${(log.cost_usd || 0).toFixed(4)}</strong></td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        // –ü–æ–ª—É—á–∏—Ç—å –±–µ–π–¥–∂ –¥–ª—è —ç—Ç–∞–ø–∞
        function getStageBadge(stage) {
            if (!stage) return '<span class="badge">Unknown</span>';
            
            const stageMap = {
                'stage1': { label: 'Stage 1', class: 'badge-stage1' },
                'stage2': { label: 'Stage 2', class: 'badge-stage2' },
                'stage3': { label: 'Stage 3', class: 'badge-stage3' },
                'stage4': { label: 'Stage 4', class: 'badge-stage4' },
                'query': { label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è', class: 'badge-stage1' }
            };

            for (const [key, value] of Object.entries(stageMap)) {
                if (stage.includes(key)) {
                    return `<span class="badge ${value.class}">${value.label}</span>`;
                }
            }

            return `<span class="badge">${stage}</span>`;
        }

        // –ü–æ–ª—É—á–∏—Ç—å –±–µ–π–¥–∂ –¥–ª—è –º–æ–¥–µ–ª–∏
        function getModelBadge(model) {
            if (!model) return '<span class="badge">Unknown</span>';
            
            if (model.includes('sonar')) {
                return `<span class="badge badge-perplexity">${model}</span>`;
            } else if (model.includes('deepseek')) {
                return `<span class="badge badge-deepseek">${model}</span>`;
            }
            
            return `<span class="badge">${model}</span>`;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        function updatePagination() {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        }

        // –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        function changePage(delta) {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        function exportToCSV() {
            const headers = ['–î–∞—Ç–∞/–í—Ä–µ–º—è', '–≠—Ç–∞–ø', '–ú–æ–¥–µ–ª—å', '–¢–æ–∫–µ–Ω—ã (–ó–∞–ø—Ä–æ—Å)', '–¢–æ–∫–µ–Ω—ã (–û—Ç–≤–µ—Ç)', '–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤', '–°—Ç–æ–∏–º–æ—Å—Ç—å (USD)'];
            const rows = filteredLogs.map(log => [
                new Date(log.timestamp).toLocaleString('ru-RU'),
                log.stage || '',
                log.model_name || '',
                log.request_tokens || 0,
                log.response_tokens || 0,
                log.total_tokens || 0,
                (log.cost_usd || 0).toFixed(4)
            ]);

            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `api-stats-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const tableBody = document.getElementById('logsTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <h3>‚ùå –û—à–∏–±–∫–∞</h3>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadLogs();
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('dateTo').valueAsDate = today;
            document.getElementById('dateFrom').valueAsDate = weekAgo;
        });
    </script>
</body>
</html>

