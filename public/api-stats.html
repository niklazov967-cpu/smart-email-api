<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Расходы и Статистика</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Сводные карточки */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .summary-card h3 {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .summary-card .value {
            color: #2d3748;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card .subtext {
            color: #a0aec0;
            font-size: 13px;
        }

        .summary-card.cost .value {
            color: #16a34a;
        }

        .summary-card.tokens .value {
            color: #2563eb;
        }

        .summary-card.calls .value {
            color: #9333ea;
        }

        /* Фильтры */
        .filters {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .filters h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Графики */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chart-card h3 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            min-width: 120px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .bar-container {
            flex: 1;
            height: 30px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        /* Таблица */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .table-header {
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
        }

        .table-header h2 {
            color: #2d3748;
            font-size: 20px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #4a5568;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            color: #2d3748;
            font-size: 14px;
            border-bottom: 1px solid #f1f5f9;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-perplexity {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-deepseek {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge-stage1 {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-stage2 {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .badge-stage3 {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge-stage4 {
            background: #fed7aa;
            color: #9a3412;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #a0aec0;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: #4a5568;
            font-size: 14px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.9;
        }

        .back-link:hover {
            opacity: 1;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">← Вернуться на главную</a>
        
        <!-- Заголовок -->
        <div class="header">
            <h1>
                API Расходы и Статистика
                <span class="version-badge">v3.0.0</span>
            </h1>
            <p>Детальная информация о расходах на API вызовы DeepSeek и Perplexity</p>
        </div>

        <!-- Сводные карточки -->
        <div class="summary-cards">
            <div class="summary-card cost">
                <h3>Общая стоимость</h3>
                <div class="value" id="totalCost">$0.00</div>
                <div class="subtext">За весь период</div>
            </div>
            <div class="summary-card tokens">
                <h3>Всего токенов</h3>
                <div class="value" id="totalTokens">0</div>
                <div class="subtext">DeepSeek + Perplexity</div>
            </div>
            <div class="summary-card calls">
                <h3>API вызовов</h3>
                <div class="value" id="totalCalls">0</div>
                <div class="subtext">Всего запросов</div>
            </div>
            <div class="summary-card">
                <h3>По сервисам</h3>
                <div class="value" id="serviceBreakdown" style="font-size: 14px; line-height: 1.6;">-</div>
                <div class="subtext">DeepSeek / Perplexity</div>
            </div>
        </div>

        <!-- Графики -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Расходы по этапам</h3>
                <div class="bar-chart" id="stageChart"></div>
            </div>
            <div class="chart-card">
                <h3>Расходы по моделям</h3>
                <div class="bar-chart" id="modelChart"></div>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="filters">
            <h2>Фильтры</h2>
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Этап</label>
                    <select id="stageFilter">
                        <option value="">Все этапы</option>
                        <option value="query">Генерация запросов</option>
                        <option value="stage1">Этап 1: Поиск компаний</option>
                        <option value="stage2">Этап 2: Поиск сайтов</option>
                        <option value="stage3">Этап 3: Поиск email</option>
                        <option value="stage4">Этап 4: AI валидация</option>
                        <option value="stage5">Этап 5: Теги</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Модель/Сервис</label>
                    <select id="modelFilter">
                        <option value="">Все модели</option>
                        <option value="deepseek-chat">DeepSeek Chat</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                        <option value="sonar">Perplexity Sonar</option>
                        <option value="sonar-pro">Perplexity Sonar Pro</option>
                        <option value="llama-3.1-sonar">Perplexity Llama (Legacy)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Дата от</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>Дата до</label>
                    <input type="date" id="dateTo">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Применить фильтры</button>
                <button class="btn btn-secondary" onclick="showLastHour()">Последний час</button>
                <button class="btn btn-secondary" onclick="showAllLogs()">Показать все</button>
                <button class="btn btn-secondary" onclick="exportToCSV()">Экспорт CSV</button>
            </div>
        </div>

        <!-- Таблица -->
        <div class="table-container">
            <div class="table-header">
                <h2>Детальная история вызовов</h2>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Дата/Время</th>
                            <th>Этап</th>
                            <th>Модель</th>
                            <th>Токены (Запрос)</th>
                            <th>Токены (Ответ)</th>
                            <th>Всего токенов</th>
                            <th>Стоимость (USD)</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable">
                        <tr>
                            <td colspan="7" class="loading">Загрузка данных...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="prevPage" onclick="changePage(-1)">Предыдущая</button>
                <span class="page-info">
                    Страница <span id="currentPage">1</span> из <span id="totalPages">1</span>
                </span>
                <button id="nextPage" onclick="changePage(1)">Следующая</button>
            </div>
        </div>
    </div>

    <script>
        let allLogs = [];
        let filteredLogs = [];
        let globalStats = null;
        let currentPage = 1;
        const logsPerPage = 50;

        // Загрузка данных при открытии страницы
        async function loadData() {
            try {
                // 1. Загрузить глобальную статистику
                const summaryResponse = await fetch('/api/credits/summary');
                const summaryData = await summaryResponse.json();
                
                if (summaryData.success) {
                    globalStats = summaryData.stats;
                    updateGlobalSummary();
                }

                // 2. Загрузить логи
                const logsResponse = await fetch('/api/credits/logs');
                const logsData = await logsResponse.json();
                
                if (logsData.success) {
                    allLogs = logsData.logs || [];
                    showLastHour();
                } else {
                    showError('Ошибка загрузки данных: ' + logsData.error);
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Ошибка подключения к серверу');
            }
        }

        // Обновить глобальную сводку
        function updateGlobalSummary() {
            if (!globalStats) return;

            const g = globalStats;
            const deepseekTokens = g.deepseek?.tokens || 0;
            const perplexityTokens = g.perplexity?.tokens || 0;
            
            const totalCostEl = document.getElementById('totalCost');
            if (totalCostEl) totalCostEl.textContent = '$' + (g.total?.cost || 0).toFixed(4);
            
            const totalTokensEl = document.getElementById('totalTokens');
            if (totalTokensEl) totalTokensEl.textContent = (deepseekTokens + perplexityTokens).toLocaleString();
            
            const totalCallsEl = document.getElementById('totalCalls');
            if (totalCallsEl) totalCallsEl.textContent = (g.total?.calls || 0).toLocaleString();
            
            // Разбивка по сервисам
            const serviceBreakdownEl = document.getElementById('serviceBreakdown');
            if (serviceBreakdownEl) {
                serviceBreakdownEl.innerHTML = `
                    DeepSeek: $${(g.deepseek?.cost || 0).toFixed(4)}<br>
                    Perplexity: $${(g.perplexity?.cost || 0).toFixed(4)}
                `;
            }
        }

        // Показать только последний час
        function showLastHour() {
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            
            const dateFromEl = document.getElementById('dateFrom');
            const dateToEl = document.getElementById('dateTo');
            const stageFilterEl = document.getElementById('stageFilter');
            const modelFilterEl = document.getElementById('modelFilter');
            
            if (dateFromEl) dateFromEl.value = oneHourAgo.toISOString().split('T')[0];
            if (dateToEl) dateToEl.value = new Date().toISOString().split('T')[0];
            if (stageFilterEl) stageFilterEl.value = '';
            if (modelFilterEl) modelFilterEl.value = '';
            
            applyFilters();
        }

        // Показать все логи
        function showAllLogs() {
            filteredLogs = [...allLogs];
            
            currentPage = 1;
            updateCharts();
            renderTable();
            
            document.querySelector('.table-header h2').textContent = 
                `Все вызовы (${filteredLogs.length} записей)`;
        }

        // Применить фильтры
        function applyFilters() {
            const stageFilterEl = document.getElementById('stageFilter');
            const modelFilterEl = document.getElementById('modelFilter');
            const dateFromEl = document.getElementById('dateFrom');
            const dateToEl = document.getElementById('dateTo');
            
            if (!stageFilterEl || !modelFilterEl || !dateFromEl || !dateToEl) {
                console.error('Filter elements not found');
                return;
            }
            
            const stageFilter = stageFilterEl.value;
            const modelFilter = modelFilterEl.value;
            const dateFrom = dateFromEl.value;
            const dateTo = dateToEl.value;

            filteredLogs = allLogs.filter(log => {
                if (stageFilter && !log.stage?.includes(stageFilter)) return false;
                if (modelFilter && !log.model_name?.includes(modelFilter)) return false;
                
                const logDate = new Date(log.timestamp);
                if (dateFrom && logDate < new Date(dateFrom)) return false;
                if (dateTo && logDate > new Date(dateTo + 'T23:59:59')) return false;
                
                return true;
            });

            currentPage = 1;
            updateCharts();
            renderTable();
        }

        // Отрисовать графики
        function updateCharts() {
            // График по этапам
            const stageStats = {};
            
            filteredLogs.forEach(log => {
                const stageKey = log.stage || 'unknown';
                const label = stageLabels[stageKey] || stageKey;
                if (!stageStats[label]) stageStats[label] = 0;
                stageStats[label] += parseFloat(log.cost_usd) || 0;
            });

            const maxStageCost = Math.max(...Object.values(stageStats), 0.0001);
            const stageChartEl = document.getElementById('stageChart');
            
            if (stageChartEl) {
                if (Object.keys(stageStats).length === 0) {
                    stageChartEl.innerHTML = '<div style="color: #718096; text-align: center; padding: 20px;">Нет данных</div>';
                } else {
                    stageChartEl.innerHTML = Object.entries(stageStats)
                        .sort((a, b) => b[1] - a[1])
                        .map(([label, cost]) => {
                            const percentage = (cost / maxStageCost) * 100;
                            return `
                                <div class="bar-item">
                                    <div class="bar-label">${label}</div>
                                    <div class="bar-container">
                                        <div class="bar-fill" style="width: ${percentage}%">
                                            $${cost.toFixed(4)}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                }
            }
            
            // График по моделям
            const modelStats = {};
            
            filteredLogs.forEach(log => {
                const modelKey = log.model_name || 'unknown';
                const label = modelLabels[modelKey] || modelKey;
                if (!modelStats[label]) modelStats[label] = 0;
                modelStats[label] += parseFloat(log.cost_usd) || 0;
            });

            const maxModelCost = Math.max(...Object.values(modelStats), 0.0001);
            const modelChartEl = document.getElementById('modelChart');
            
            if (modelChartEl) {
                if (Object.keys(modelStats).length === 0) {
                    modelChartEl.innerHTML = '<div style="color: #718096; text-align: center; padding: 20px;">Нет данных</div>';
                } else {
                    modelChartEl.innerHTML = Object.entries(modelStats)
                        .sort((a, b) => b[1] - a[1])
                        .map(([label, cost]) => {
                            const percentage = (cost / maxModelCost) * 100;
                            return `
                                <div class="bar-item">
                                    <div class="bar-label">${label}</div>
                                    <div class="bar-container">
                                        <div class="bar-fill" style="width: ${percentage}%">
                                            $${cost.toFixed(4)}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                }
            }
        }

        // Отрисовать таблицу
        function renderTable() {
            const tableBodyEl = document.getElementById('logsTable');
            if (!tableBodyEl) {
                console.error('logsTable element not found');
                return;
            }
            
            if (filteredLogs.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h3>Нет данных</h3>
                            <p>Измените фильтры или запустите этапы обработки</p>
                        </td>
                    </tr>
                `;
                updatePagination();
                return;
            }

            const startIndex = (currentPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const pageLogs = filteredLogs.slice(startIndex, endIndex);

            tableBodyEl.innerHTML = pageLogs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString('ru-RU')}</td>
                    <td>${log.service || '-'}</td>
                    <td>${getModelBadge(log.model_name || '-')}</td>
                    <td>${getStageLabel(log.stage || '-')}</td>
                    <td>${log.request_tokens || 0}</td>
                    <td>${log.response_tokens || 0}</td>
                    <td>$${parseFloat(log.cost_usd || 0).toFixed(6)}</td>
                </tr>
            `).join('');

            updatePagination();
        }

        // Маппинг этапов
        const stageLabels = {
            'query_expansion': 'Генерация запросов',
            'stage1_find_companies': 'Этап 1: Поиск компаний',
            'stage2_find_websites': 'Этап 2: Поиск сайтов',
            'stage3_find_emails': 'Этап 3: Поиск email',
            'stage4_ai_validation': 'Этап 4: AI валидация',
            'stage5_tags': 'Этап 5: Теги'
        };

        const modelLabels = {
            'deepseek-chat': 'DeepSeek Chat',
            'deepseek-reasoner': 'DeepSeek Reasoner',
            'sonar': 'Perplexity Sonar',
            'sonar-pro': 'Perplexity Sonar Pro',
            'llama-3.1-sonar-small-128k-online': 'Perplexity Llama (Small)',
            'llama-3.1-sonar-large-128k-online': 'Perplexity Llama (Large)',
            'llama-3.1-sonar-huge-128k-online': 'Perplexity Llama (Huge)'
        };

        function getStageLabel(stage) {
            if (!stage) return 'Прочее';
            for (const [key, label] of Object.entries(stageLabels)) {
                if (stage.includes(key)) return label;
            }
            return stage;
        }

        function getStageBadge(stage) {
            if (!stage) return '<span class="badge">Unknown</span>';
            
            const stageMap = {
                'stage1': { label: 'Этап 1', class: 'badge-stage1' },
                'stage2': { label: 'Этап 2', class: 'badge-stage2' },
                'stage3': { label: 'Этап 3', class: 'badge-stage3' },
                'stage4': { label: 'Этап 4', class: 'badge-stage4' },
                'query': { label: 'Генерация', class: 'badge-stage1' }
            };

            for (const [key, value] of Object.entries(stageMap)) {
                if (stage.includes(key)) {
                    return `<span class="badge ${value.class}">${value.label}</span>`;
                }
            }

            return `<span class="badge">${stage}</span>`;
        }

        function getModelBadge(model) {
            if (!model) return '<span class="badge">Unknown</span>';
            
            if (model.includes('sonar') || model.includes('llama')) {
                return `<span class="badge badge-perplexity">${model}</span>`;
            } else if (model.includes('deepseek')) {
                return `<span class="badge badge-deepseek">${model}</span>`;
            }
            
            return `<span class="badge">${model}</span>`;
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage) || 1;
            
            const currentPageEl = document.getElementById('currentPage');
            if (currentPageEl) currentPageEl.textContent = currentPage;
            
            const totalPagesEl = document.getElementById('totalPages');
            if (totalPagesEl) totalPagesEl.textContent = totalPages;
            
            const prevPageEl = document.getElementById('prevPage');
            if (prevPageEl) prevPageEl.disabled = currentPage === 1;
            
            const nextPageEl = document.getElementById('nextPage');
            if (nextPageEl) nextPageEl.disabled = currentPage === totalPages;
        }

        function changePage(delta) {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // Экспорт в CSV
        function exportToCSV() {
            if (filteredLogs.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }

            const headers = ['Дата', 'Сервис', 'Модель', 'Этап', 'Request токены', 'Response токены', 'Стоимость (USD)'];
            const rows = filteredLogs.map(log => [
                new Date(log.timestamp).toLocaleString('ru-RU'),
                log.service || '',
                log.model_name || '',
                log.stage || '',
                log.request_tokens || 0,
                log.response_tokens || 0,
                parseFloat(log.cost_usd || 0).toFixed(6)
            ]);

            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.join(';'))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `api-stats-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showError(message) {
            const tableBodyEl = document.getElementById('logsTable');
            if (!tableBodyEl) {
                console.error('logsTable element not found for error display');
                return;
            }
            
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <h3>Ошибка</h3>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        // Загрузить данные при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('dateFrom').valueAsDate = today;
            document.getElementById('dateTo').valueAsDate = today;
            loadData();
        });

        // Автообновление каждые 30 секунд
        setInterval(async () => {
            try {
                const summaryResponse = await fetch('/api/credits/summary');
                const summaryData = await summaryResponse.json();
                if (summaryData.success) {
                    globalStats = summaryData.stats;
                    updateGlobalSummary();
                }
            } catch (e) {
                console.error('Auto-refresh failed:', e);
            }
        }, 30000);
    </script>
</body>
</html>
