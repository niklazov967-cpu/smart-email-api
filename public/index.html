<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Email API - –ü–æ—Ä—Ç–∞–ª —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
    }

    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .header p {
      color: #666;
      font-size: 1.1em;
    }

    .status {
      display: inline-block;
      padding: 5px 15px;
      background: #10b981;
      color: white;
      border-radius: 20px;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .version {
      margin-top: 15px;
      color: #999;
      font-size: 0.9em;
    }

    .header-buttons {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    .stage-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .stage-title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    .stage-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .badge-ready {
      background: #d4edda;
      color: #155724;
    }

    .badge-empty {
      background: #f8f9fa;
      color: #6c757d;
    }

    .badge-running {
      background: #fff3cd;
      color: #856404;
    }

    .companies-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-box {
      padding: 15px;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .companies-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .company-item {
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 6px;
      font-size: 14px;
    }

    .company-name {
      font-weight: 600;
      color: #333;
    }

    .company-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .button-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .button-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .input-group input, .input-group textarea, .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .queries-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .query-item {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      transition: all 0.2s;
    }

    .query-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .query-item.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .query-checkbox {
      width: 20px;
      height: 20px;
      margin-right: 15px;
      cursor: pointer;
    }

    .query-content {
      flex: 1;
    }

    .query-cn {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .query-ru {
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button onclick="logout()" class="logout-btn">üö™ –í—ã–π—Ç–∏</button>
      <h1>üöÄ Smart Email API</h1>
      <p>–ü–æ—Ä—Ç–∞–ª —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π</p>
      <span class="status">‚óè –†–∞–±–æ—Ç–∞–µ—Ç</span>
      <p class="version">–í–µ—Ä—Å–∏—è 1.3.0 | DeepSeek + Perplexity Integration (48% —ç–∫–æ–Ω–æ–º–∏–∏)</p>
      <div class="header-buttons">
        <button onclick="clearDatabase()" class="button button-danger">
          üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        </button>
        <a href="/results.html" style="text-decoration: none;">
          <button class="button button-success">
            üìß –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          </button>
        </a>
      </div>
    </div>

    <!-- –≠—Ç–∞–ø 0: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <div class="stage-card">
      <div class="stage-header">
        <div class="stage-title">üîç –®–∞–≥ 0: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</div>
      </div>

      <div class="input-group">
        <label>–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤:</label>
        <textarea id="mainTopic" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ—Ç–∞–ª–ª–∞ –≤ –ö–∏—Ç–∞–µ"></textarea>
      </div>

      <div class="input-group">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤ (10-50):</label>
        <input type="number" id="numQueries" value="10" min="10" max="50">
      </div>

      <button class="button button-primary" onclick="generateQueries()">
        ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
      </button>

      <div id="generationStatus" style="display: none;"></div>

      <!-- –°–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ -->
      <div id="queriesSection" style="display: none;">
        <h3 style="margin: 20px 0 10px; color: #667eea;">üìù –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h3>
        <div style="margin-bottom: 15px;">
          <button class="button button-success" onclick="selectAllQueries(true)">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
          <button class="button button-danger" onclick="selectAllQueries(false)">‚ùå –°–Ω—è—Ç—å –≤—Å–µ</button>
          <span style="margin-left: 15px; color: #666;">
            –í—ã–±—Ä–∞–Ω–æ: <strong id="selectedCount">0</strong> –∑–∞–ø—Ä–æ—Å–æ–≤
          </span>
        </div>
        <div id="queriesList" class="queries-list"></div>
        
        <button class="button button-success" id="saveQueriesBtn" onclick="saveSelectedQueries()" style="margin-top: 20px;">
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Å–æ–∑–¥–∞—Ç—å —Ç–µ–º—É
        </button>
      </div>
    </div>

    <!-- Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π -->
    <div class="stage-card" id="stage1Card">
      <div class="stage-header">
        <div class="stage-title">üè¢ Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</div>
        <div class="stage-badge badge-ready" id="stage1Badge">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É</div>
      </div>

      <div class="input-group">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –º—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–ª–∏ –ø–æ–∏—Å–∫:</label>
        <select id="stage1SessionSelect">
          <option value="">-- –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ–º—É –≤—ã—à–µ --</option>
        </select>
      </div>

      <div id="stage1SessionInfo" style="display: none; padding: 15px; background: #f0f4ff; border-radius: 8px; margin: 15px 0;">
        <p style="margin-bottom: 8px;"><strong>–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ç–µ–º–µ:</strong> <span id="stage1QueriesCount">0</span></p>
        <p style="margin-bottom: 8px;"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="stage1SessionStatus"></span></p>
      </div>

      <button class="button button-primary" id="stage1Btn" onclick="runStage1()" disabled>
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1
      </button>

      <div id="stage1Status" style="display: none;"></div>
    </div>

    <!-- Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ -->
    <div class="stage-card" id="stage2Card">
      <div class="stage-header">
        <div class="stage-title">üåê Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤</div>
        <div class="stage-badge badge-ready" id="stage2Badge">–ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="stage2Count">-</div>
          <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –±–µ–∑ —Å–∞–π—Ç–∞</div>
        </div>
      </div>

      <div id="stage2Companies" class="companies-list" style="display: none;"></div>

      <button class="button button-primary" id="stage2Btn" onclick="runStage(2)">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 2
      </button>

      <div id="stage2Status" style="display: none;"></div>
    </div>

    <!-- Stage 3: –ü–æ–∏—Å–∫ email -->
    <div class="stage-card" id="stage3Card">
      <div class="stage-header">
        <div class="stage-title">üìß Stage 3: –ü–æ–∏—Å–∫ email</div>
        <div class="stage-badge badge-ready" id="stage3Badge">–ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="stage3Count">-</div>
          <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –±–µ–∑ email</div>
        </div>
      </div>

      <div id="stage3Companies" class="companies-list" style="display: none;"></div>

      <button class="button button-primary" id="stage3Btn" onclick="runStage(3)">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 3
      </button>

      <div id="stage3Status" style="display: none;"></div>
    </div>

    <!-- Stage 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è -->
    <div class="stage-card" id="stage4Card">
      <div class="stage-header">
        <div class="stage-title">ü§ñ Stage 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è</div>
        <div class="stage-badge badge-ready" id="stage4Badge">–ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="stage4Count">-</div>
          <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏</div>
        </div>
      </div>

      <div id="stage4Companies" class="companies-list" style="display: none;"></div>

      <button class="button button-primary" id="stage4Btn" onclick="runStage(4)">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 4
      </button>

      <div id="stage4Status" style="display: none;"></div>
    </div>

    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stage-card">
      <div class="stage-header">
        <div class="stage-title">‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="completedCount">-</div>
          <div class="stat-label">–ü—Ä–æ—à–ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalInDb">-</div>
          <div class="stat-label">–í—Å–µ–≥–æ –≤ –±–∞–∑–µ</div>
        </div>
      </div>

      <p style="color: #666; margin-top: 15px;">
        –ö–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –≤—Å–µ —ç—Ç–∞–ø—ã –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ 
        <a href="/results.html" style="color: #667eea; font-weight: 600;">—Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</a>.
      </p>
    </div>

    <!-- Footer -->
    <div style="text-align: center; color: white; margin-top: 30px; opacity: 0.9;">
      <p>Smart Email API ¬© 2025 | Powered by DeepSeek + Perplexity Sonar</p>
    </div>
  </div>

  <script>
    let isProcessing = false;
    let generatedQueries = [];
    let createdSessionId = null;

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      loadStatistics();
      loadSessions();
      
      // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
      setInterval(() => {
        if (!isProcessing) {
          loadStatistics();
        }
      }, 10000);
    });

    async function generateQueries() {
      const topic = document.getElementById('mainTopic').value.trim();
      const numQueries = parseInt(document.getElementById('numQueries').value);
      const statusDiv = document.getElementById('generationStatus');

      if (!topic) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤');
        return;
      }

      if (numQueries < 10 || numQueries > 50) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 10 –¥–æ 50');
        return;
      }

      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã...</div>';

      try {
        const response = await fetch('/api/queries/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic, numQueries })
        });

        const result = await response.json();

        if (result.success) {
          generatedQueries = result.queries || [];
          displayQueries(generatedQueries);
          statusDiv.innerHTML = '<div class="status-message status-success">‚úÖ –ó–∞–ø—Ä–æ—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!</div>';
          document.getElementById('queriesSection').style.display = 'block';
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Generation error:', error);
        statusDiv.innerHTML = `<div class="status-message status-error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
      }
    }

    function displayQueries(queries) {
      const container = document.getElementById('queriesList');
      container.innerHTML = queries.map((q, idx) => {
        const relevance = q.relevance || q.relevance_score || 0;
        const relevanceColor = relevance >= 80 ? '#10b981' : relevance >= 60 ? '#f59e0b' : '#ef4444';
        const relevanceLabel = relevance >= 80 ? '–í—ã—Å–æ–∫–∞—è' : relevance >= 60 ? '–°—Ä–µ–¥–Ω—è—è' : '–ù–∏–∑–∫–∞—è';
        
        return `
        <div class="query-item" id="query-${idx}">
          <input type="checkbox" class="query-checkbox" id="checkbox-${idx}" 
                 onchange="updateSelectedCount()" checked>
          <div class="query-content">
            <div class="query-cn">${q.query_cn || q.chinese_query || q.query}</div>
            <div class="query-ru">${q.query_ru || q.russian_query || q.translation || ''}</div>
          </div>
          <div style="margin-left: 15px; text-align: right; min-width: 100px;">
            <div style="font-size: 20px; font-weight: bold; color: ${relevanceColor};">${relevance}</div>
            <div style="font-size: 11px; color: ${relevanceColor}; font-weight: 600;">${relevanceLabel}</div>
          </div>
        </div>
      `;
      }).join('');
      updateSelectedCount();
    }

    function selectAllQueries(checked) {
      const checkboxes = document.querySelectorAll('.query-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checked;
        const item = cb.closest('.query-item');
        if (checked) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const checked = document.querySelectorAll('.query-checkbox:checked').length;
      document.getElementById('selectedCount').textContent = checked;
    }

    async function saveSelectedQueries() {
      const topic = document.getElementById('mainTopic').value.trim();
      const checkboxes = document.querySelectorAll('.query-checkbox:checked');
      const saveBtn = document.getElementById('saveQueriesBtn'); // –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ ID
      
      if (checkboxes.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å');
        return;
      }

      // –ë–õ–û–ö–ò–†–û–í–ö–ê: –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É
      saveBtn.disabled = true;
      saveBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
      saveBtn.style.opacity = '0.6';
      saveBtn.style.cursor = 'not-allowed';

      const selectedQueries = Array.from(checkboxes).map(cb => {
        const idx = parseInt(cb.id.replace('checkbox-', ''));
        return generatedQueries[idx];
      });

      const statusDiv = document.getElementById('generationStatus');
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å—ã...</div>';

      try {
        const response = await fetch('/api/queries/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            mainTopic: topic,
            queries: selectedQueries 
          })
        });

        const result = await response.json();

        if (result.success) {
          createdSessionId = result.sessionId;
          statusDiv.innerHTML = `<div class="status-message status-success">
            ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${selectedQueries.length} –∑–∞–ø—Ä–æ—Å–æ–≤! –¢–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∞: ${result.sessionId}
          </div>`;
          
          // –ë–õ–û–ö–ò–†–û–í–ö–ê: –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
          document.querySelectorAll('.query-checkbox').forEach(cb => {
            cb.disabled = true;
            cb.style.cursor = 'not-allowed';
          });
          
          // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –∏ "–°–Ω—è—Ç—å –≤—Å–µ"
          document.querySelectorAll('#queriesSection .button-success, #queriesSection .button-danger').forEach(btn => {
            if (btn.id !== 'saveQueriesBtn') { // –ù–µ —Ç—Ä–æ–≥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              btn.disabled = true;
              btn.style.opacity = '0.5';
              btn.style.cursor = 'not-allowed';
            }
          });
          
          // –í–∏–∑—É–∞–ª—å–Ω–æ –∑–∞—Ç–µ–º–Ω–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
          document.getElementById('queriesList').style.opacity = '0.6';
          document.getElementById('queriesList').style.pointerEvents = 'none';
          
          // –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∏ —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –Ω–∞ "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
          saveBtn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          saveBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
          saveBtn.style.opacity = '1';
          
          // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–º –∏ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –≤—ã–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ç–µ–º—É
          await loadSessions();
          
          // –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—ã–±—Ä–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ–º–∞
          const select = document.getElementById('stage1SessionSelect');
          select.value = createdSessionId;
          
          // –í–ê–ñ–ù–û: –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
          await updateStage1SessionInfo();
          
          // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ Stage 1
          setTimeout(() => {
            document.getElementById('stage1Card').scrollIntoView({ 
              behavior: 'smooth', 
              block: 'start' 
            });
          }, 500);
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Save error:', error);
        statusDiv.innerHTML = `<div class="status-message status-error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ - —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Å–æ–∑–¥–∞—Ç—å —Ç–µ–º—É';
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
        saveBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      }
    }

    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const result = await response.json();
        
        if (result.success) {
          const select = document.getElementById('stage1SessionSelect');
          const currentValue = select.value;
          
          select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>';
          
          // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 'data', –∞ –Ω–µ 'sessions'
          const sessions = result.data || result.sessions || [];
          
          sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.session_id;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º topic_description –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ search_query
            const topicName = session.topic_description || session.main_topic || session.search_query;
            option.textContent = `${topicName} (${new Date(session.created_at).toLocaleDateString()})`;
            select.appendChild(option);
          });
          
          // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–æ
          if (currentValue) {
            select.value = currentValue;
          } else if (createdSessionId) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Ç–µ–º–∞ - –≤—ã–±—Ä–∞—Ç—å –µ—ë
            select.value = createdSessionId;
          }
          
          // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –≤—ã–±—Ä–∞–Ω–æ
          if (select.value) {
            await updateStage1SessionInfo();
          }
        }
      } catch (error) {
        console.error('Error loading sessions:', error);
      }
    }

    async function updateStage1SessionInfo() {
      const sessionId = document.getElementById('stage1SessionSelect').value;
      const infoDiv = document.getElementById('stage1SessionInfo');
      const btn = document.getElementById('stage1Btn');

      if (!sessionId) {
        infoDiv.style.display = 'none';
        btn.disabled = true;
        return;
      }

      try {
        const response = await fetch(`/api/sessions/${sessionId}`);
        const result = await response.json();

        if (result.success) {
          const session = result.data || result.session;
          
          // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ target_count –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
          const queriesCount = session.target_count || 0;
          
          document.getElementById('stage1QueriesCount').textContent = queriesCount;
          document.getElementById('stage1SessionStatus').textContent = session.status || '–Ω–æ–≤–∞—è';
          infoDiv.style.display = 'block';
          btn.disabled = false;
        }
      } catch (error) {
        console.error('Error loading session info:', error);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
    document.getElementById('stage1SessionSelect')?.addEventListener('change', updateStage1SessionInfo);

    async function runStage1() {
      const sessionId = document.getElementById('stage1SessionSelect').value;
      
      if (!sessionId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É');
        return;
      }

      if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1 –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã?`)) {
        return;
      }

      const btn = document.getElementById('stage1Btn');
      const statusDiv = document.getElementById('stage1Status');
      const badge = document.getElementById('stage1Badge');

      isProcessing = true;
      btn.disabled = true;
      btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.className = 'stage-badge badge-running';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –ò—â–µ–º –∫–æ–º–ø–∞–Ω–∏–∏...</div>';

      try {
        const response = await fetch(`/api/sessions/${sessionId}/stage1`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `
            <div class="status-message status-success">
              ‚úÖ <strong>Stage 1 –∑–∞–≤–µ—Ä—à–µ–Ω!</strong><br>
              –ù–∞–π–¥–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π: ${result.total || 0}
            </div>
          `;
          
          // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          setTimeout(() => loadStatistics(), 1000);
        } else {
          throw new Error(result.error || 'Unknown error');
        }

      } catch (error) {
        console.error('Stage 1 error:', error);
        statusDiv.innerHTML = `
          <div class="status-message status-error">
            ‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
          </div>
        `;
      } finally {
        isProcessing = false;
        btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1';
        btn.disabled = false;
        setTimeout(() => {
          loadStatistics();
          badge.className = 'stage-badge badge-ready';
          badge.textContent = '–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É';
        }, 2000);
      }
    }

    async function loadStatistics() {
      try {
        const response = await fetch('/api/debug/data');
        const data = await response.json();
        
        if (!data.success) {
          throw new Error('Failed to load data');
        }

        const companies = data.data.pending_companies?.items || [];
        
        // Stage 2: –∫–æ–º–ø–∞–Ω–∏–∏ –±–µ–∑ —Å–∞–π—Ç–∞, current_stage >= 1, stage2_status = NULL
        const stage2Ready = companies.filter(c => 
          (!c.website || c.website === '') &&
          c.stage2_status === null &&
          c.current_stage >= 1
        );

        // Stage 3: –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Å–∞–π—Ç–æ–º, –±–µ–∑ email, current_stage >= 2, stage3_status = NULL
        const stage3Ready = companies.filter(c =>
          c.website &&
          (!c.email || c.email === '') &&
          c.stage3_status === null &&
          c.current_stage >= 2
        );

        // Stage 4: –∫–æ–º–ø–∞–Ω–∏–∏ —Å email, current_stage >= 3, stage4_status = NULL
        const stage4Ready = companies.filter(c =>
          c.current_stage >= 3 &&
          c.stage4_status === null
        );

        // –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏: current_stage = 4 –∏ stage4_status != NULL
        const completed = companies.filter(c =>
          c.current_stage === 4 &&
          c.stage4_status !== null
        );

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏
        document.getElementById('stage2Count').textContent = stage2Ready.length;
        document.getElementById('stage3Count').textContent = stage3Ready.length;
        document.getElementById('stage4Count').textContent = stage4Ready.length;
        document.getElementById('completedCount').textContent = completed.length;
        document.getElementById('totalInDb').textContent = companies.length;

        // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂–∏ –∏ –∫–Ω–æ–ø–∫–∏
        updateStageBadge(2, stage2Ready.length);
        updateStageBadge(3, stage3Ready.length);
        updateStageBadge(4, stage4Ready.length);

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π
        displayCompanies(2, stage2Ready);
        displayCompanies(3, stage3Ready);
        displayCompanies(4, stage4Ready);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    function updateStageBadge(stage, count) {
      const badge = document.getElementById(`stage${stage}Badge`);
      const btn = document.getElementById(`stage${stage}Btn`);
      
      if (count === 0) {
        badge.textContent = '–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π';
        badge.className = 'stage-badge badge-empty';
        btn.disabled = true;
      } else {
        badge.textContent = `${count} ${getCompanyWord(count)}`;
        badge.className = 'stage-badge badge-ready';
        btn.disabled = false;
      }
    }

    function displayCompanies(stage, companies) {
      const container = document.getElementById(`stage${stage}Companies`);
      
      if (companies.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      container.innerHTML = companies.slice(0, 10).map(c => `
        <div class="company-item">
          <div class="company-name">${c.company_name}</div>
          <div class="company-info">
            ${c.website ? `üåê ${c.website}` : '‚ùå –ù–µ—Ç —Å–∞–π—Ç–∞'} | 
            ${c.email ? `üìß ${c.email}` : '‚ùå –ù–µ—Ç email'}
          </div>
        </div>
      `).join('');

      if (companies.length > 10) {
        container.innerHTML += `<div class="company-item" style="text-align: center; color: #999;">
          –ò –µ—â–µ ${companies.length - 10} –∫–æ–º–ø–∞–Ω–∏–π...
        </div>`;
      }
    }

    async function runStage(stageNum) {
      if (isProcessing) {
        alert('–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.');
        return;
      }

      const btn = document.getElementById(`stage${stageNum}Btn`);
      const statusDiv = document.getElementById(`stage${stageNum}Status`);
      const badge = document.getElementById(`stage${stageNum}Badge`);

      if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å Stage ${stageNum} –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ç–æ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π?`)) {
        return;
      }

      isProcessing = true;
      btn.disabled = true;
      btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.className = 'stage-badge badge-running';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...</div>';

      try {
        let endpoint;
        if (stageNum === 2) endpoint = '/api/sessions/global/stage2';
        else if (stageNum === 3) endpoint = '/api/sessions/global/stage3';
        else if (stageNum === 4) endpoint = '/api/sessions/global/stage4';

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `
            <div class="status-message status-success">
              ‚úÖ <strong>Stage ${stageNum} –∑–∞–≤–µ—Ä—à–µ–Ω!</strong><br>
              ${getStageResultMessage(stageNum, result)}
            </div>
          `;
          
          // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          setTimeout(() => loadStatistics(), 1000);
        } else {
          throw new Error(result.error || 'Unknown error');
        }

      } catch (error) {
        console.error(`Stage ${stageNum} error:`, error);
        statusDiv.innerHTML = `
          <div class="status-message status-error">
            ‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
          </div>
        `;
      } finally {
        isProcessing = false;
        btn.textContent = `üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage ${stageNum}`;
        setTimeout(() => loadStatistics(), 2000);
      }
    }

    function getStageResultMessage(stage, result) {
      if (stage === 2) {
        return `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.total || 0} | –ù–∞–π–¥–µ–Ω–æ —Å–∞–π—Ç–æ–≤: ${result.found || 0}`;
      } else if (stage === 3) {
        return `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.processed || 0} | –ù–∞–π–¥–µ–Ω–æ email: ${result.found || 0}`;
      } else if (stage === 4) {
        return `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.total || 0} | –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–æ: ${result.validated || 0} | –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${result.rejected || 0}`;
      }
      return '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
    }

    function getCompanyWord(count) {
      const lastDigit = count % 10;
      const lastTwoDigits = count % 100;
      
      if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
        return '–∫–æ–º–ø–∞–Ω–∏–π';
      }
      if (lastDigit === 1) {
        return '–∫–æ–º–ø–∞–Ω–∏—è';
      }
      if (lastDigit >= 2 && lastDigit <= 4) {
        return '–∫–æ–º–ø–∞–Ω–∏–∏';
      }
      return '–∫–æ–º–ø–∞–Ω–∏–π';
    }

    async function clearDatabase() {
      if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã:\n\n- –í—Å–µ —Å–µ—Å—Å–∏–∏\n- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã\n- –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏\n- –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
        return;
      }

      if (!confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û! –í—ã —Ç–æ—á–Ω–æ —É–≤–µ—Ä–µ–Ω—ã?')) {
        return;
      }

      try {
        const response = await fetch('/api/sessions/clear-all', {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          alert(`‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞!\n\n–û—á–∏—â–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: ${result.cleared_tables.length}`);
          window.location.reload();
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Clear database error:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±–∞–∑—ã: ${error.message}`);
      }
    }

    async function logout() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
        return;
      }

      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = '/login.html';
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
      }
    }
  </script>
</body>
</html>
