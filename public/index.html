<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Email API - –ü–æ—Ä—Ç–∞–ª —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</title>
  <link rel="stylesheet" href="/queue-monitor.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
    }

    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .header p {
      color: #666;
      font-size: 1.1em;
    }

    .status {
      display: inline-block;
      padding: 5px 15px;
      background: #10b981;
      color: white;
      border-radius: 20px;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .version {
      margin-top: 15px;
      color: #999;
      font-size: 0.9em;
    }

    .commit-info {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
      font-family: 'Courier New', monospace;
    }

    .commit-info code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      color: #667eea;
      font-weight: 600;
    }

    .commit-info span {
      cursor: help;
    }

    .header-buttons {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    .stage-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .stage-title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    .stage-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .badge-ready {
      background: #d4edda;
      color: #155724;
    }

    .badge-empty {
      background: #f8f9fa;
      color: #6c757d;
    }

    .badge-running {
      background: #fff3cd;
      color: #856404;
    }

    .companies-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-box {
      padding: 15px;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .companies-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .company-item {
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 6px;
      font-size: 14px;
    }

    .company-name {
      font-weight: 600;
      color: #333;
    }

    .company-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .button-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .button-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .input-group input, .input-group textarea, .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .queries-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .query-item {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      transition: all 0.2s;
    }

    .query-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .query-item.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .query-checkbox {
      width: 20px;
      height: 20px;
      margin-right: 15px;
      cursor: pointer;
    }

    .query-content {
      flex: 1;
    }

    .query-cn {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .query-ru {
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button onclick="logout()" class="logout-btn">üö™ –í—ã–π—Ç–∏</button>
      <h1>üöÄ Smart Email API</h1>
      <p>–ü–æ—Ä—Ç–∞–ª —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π</p>
      <span class="status">‚óè –†–∞–±–æ—Ç–∞–µ—Ç</span>
      <p class="version" id="appVersion">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏...</p>
      <p class="commit-info" id="commitInfo" style="font-size: 12px; color: #888; margin-top: 5px;"></p>
      
      <!-- API Queue Status Badge -->
      <div class="queue-badge loading queue-badge-fixed-top-right" id="queueBadge">
        <span class="queue-pulse"></span>
        <span>AI Queue:</span>
        <span class="queue-count" id="queueCount">‚Äî</span>
      </div>
      
      <div class="header-buttons">
        <button onclick="clearDatabase()" class="button button-danger">
          üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        </button>
        <a href="/results.html" style="text-decoration: none;">
          <button class="button button-success">
            üìß –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          </button>
        </a>
        <a href="/api-stats.html" style="text-decoration: none;">
          <button class="button button-info">
            üìä API –†–∞—Å—Ö–æ–¥—ã
          </button>
        </a>
        <a href="/backup.html" style="text-decoration: none;">
          <button class="button button-secondary">
            üíæ Backup –ë–î
          </button>
        </a>
      </div>
    </div>

    <!-- –≠—Ç–∞–ø 0: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <div class="stage-card">
      <div class="stage-header">
        <div class="stage-title">üîç –®–∞–≥ 0: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</div>
      </div>

      <div class="input-group">
        <label>–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤:</label>
        <textarea id="mainTopic" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ—Ç–∞–ª–ª–∞ –≤ –ö–∏—Ç–∞–µ"></textarea>
      </div>

      <div style="display: flex; gap: 15px;">
        <div class="input-group" style="flex: 1;">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –ø—Ä–æ—Ö–æ–¥ (10-50):</label>
          <input type="number" id="numQueries" value="50" min="10" max="50">
        </div>

        <div class="input-group" style="flex: 1;">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</label>
          <input type="number" id="numPasses" value="1" min="1" max="100">
        </div>
      </div>

      <button class="button button-primary" onclick="generateQueries()" id="generateBtn">
        ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
      </button>

      <div id="generationStatus" style="display: none;"></div>

      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
      <div id="generationProgressContainer" style="display: none; margin: 15px 0; padding: 15px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong style="color: #667eea;">‚ö° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</strong>
          <span id="generationProgressPercent" style="font-size: 20px; font-weight: bold; color: #667eea;">0%</span>
        </div>
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
          <span id="generationProgressText">–ü—Ä–æ—Ö–æ–¥: 0 –∏–∑ 0</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
          <div id="generationProgressBar" style="width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s ease;"></div>
        </div>
        <div id="generationCurrentStatus" style="margin-top: 10px; font-size: 13px; color: #888; font-style: italic;"></div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ -->
      <div id="queriesSection" style="display: none;">
        <h3 style="margin: 20px 0 10px; color: #667eea;">
          ‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±–∞–∑—É
        </h3>
        <div style="margin-bottom: 15px; padding: 12px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
          <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong>
          <div style="margin-top: 8px;">
            <div>–í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: <strong id="totalGenerated">0</strong> –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            <div>–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ (‚â•70%): <strong id="relevantCount">0</strong> –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            <div>–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É: <strong id="savedCount">0</strong> –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            <div>–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: <strong id="duplicatesCount">0</strong> –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #c3e6cb; font-size: 16px;">
              üéØ <strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ:</strong> <span style="color: #10b981; font-size: 20px; font-weight: bold;" id="uniqueSavedCount">0</span>
            </div>
          </div>
        </div>
        
        <h4 style="margin: 15px 0 10px; color: #667eea;">üìù –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º:</h4>
        <div id="queriesList" class="queries-list"></div>
      </div>
    </div>

    <!-- Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π -->
    <div class="stage-card" id="stage1Card">
      <div class="stage-header">
        <div class="stage-title">üè¢ Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</div>
        <div class="stage-badge badge-ready" id="stage1Badge">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É</div>
      </div>

      <div class="input-group">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –º—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–ª–∏ –ø–æ–∏—Å–∫:</label>
        <select id="stage1SessionSelect">
          <option value="">-- –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ–º—É –≤—ã—à–µ --</option>
        </select>
      </div>

      <div id="stage1SessionInfo" style="display: none; padding: 15px; background: #f0f4ff; border-radius: 8px; margin: 15px 0;">
        <p style="margin-bottom: 8px;"><strong>–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ç–µ–º–µ:</strong> <span id="stage1QueriesCount">0</span></p>
        <p style="margin-bottom: 8px;"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="stage1SessionStatus"></span></p>
        
        <!-- Real-time Progress Counter -->
        <div id="stage1ProgressContainer" style="display: none; margin-top: 12px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #667eea;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong style="color: #667eea;">‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</strong>
            <span id="stage1ProgressPercent" style="font-size: 20px; font-weight: bold; color: #667eea;">0%</span>
          </div>
          <div style="font-size: 14px; color: #666; margin-bottom: 6px;">
            <span id="stage1ProgressText">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 –∏–∑ 0</span>
          </div>
          <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
            <div id="stage1ProgressBar" style="width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s ease;"></div>
          </div>
          <div id="stage1CurrentQuery" style="margin-top: 8px; font-size: 12px; color: #888; font-style: italic; display: none;"></div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="button button-primary" id="stage1Btn" onclick="runStage1()" disabled>
          üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
        </button>
        
        <button class="button button-secondary" id="stage1AllBtn" onclick="runAllStage1Topics()" 
                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–°–ï —Ç–µ–º—ã
        </button>
      </div>

      <div id="stage1Status" style="display: none;"></div>
      
      <!-- Progress for batch processing all topics -->
      <div id="stage1AllProgress" style="display: none; margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #ffeef8 0%, #fff5f7 100%); border-radius: 8px; border-left: 4px solid #f5576c;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong style="color: #f5576c; font-size: 16px;">‚ö° –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ–º</strong>
          <span id="stage1AllProgressPercent" style="font-size: 24px; font-weight: bold; color: #f5576c;">0%</span>
        </div>
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
          <span id="stage1AllProgressText">–¢–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 –∏–∑ 0</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden; margin-bottom: 10px;">
          <div id="stage1AllProgressBar" style="width: 0%; background: linear-gradient(90deg, #f093fb, #f5576c); height: 100%; transition: width 0.3s ease;"></div>
        </div>
        <div id="stage1AllCurrentTopic" style="font-size: 13px; color: #333; font-weight: 500;"></div>
        <div id="stage1AllStats" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ffd4e5; font-size: 13px; color: #666;">
          üìä –í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ: <strong id="stage1AllTotalCompanies" style="color: #f5576c;">0</strong>
        </div>
      </div>
    </div>

    <!-- Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ -->
    <div class="stage-card" id="stage2Card">
      <div class="stage-header">
        <div class="stage-title">üåê Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤</div>
        <div class="stage-badge badge-ready" id="stage2Badge">–ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="stage2Count">-</div>
          <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –±–µ–∑ —Å–∞–π—Ç–∞</div>
        </div>
      </div>

      <!-- Real-time Progress Counter -->
      <div id="stage2ProgressContainer" style="display: none; margin: 15px 0; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #10b981;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <strong style="color: #10b981;">‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π</strong>
          <span id="stage2ProgressPercent" style="font-size: 20px; font-weight: bold; color: #10b981;">0%</span>
        </div>
        <div style="font-size: 14px; color: #666; margin-bottom: 6px;">
          <span id="stage2ProgressText">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 –∏–∑ 0</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
          <div id="stage2ProgressBar" style="width: 0%; background: linear-gradient(90deg, #10b981, #059669); height: 100%; transition: width 0.3s ease;"></div>
        </div>
        <div id="stage2CurrentCompany" style="margin-top: 8px; font-size: 12px; color: #888; font-style: italic; display: none;"></div>
      </div>

      <div id="stage2Companies" class="companies-list" style="display: none;"></div>

      <button class="button button-primary" id="stage2Btn" onclick="runStage(2)">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 2
      </button>

      <div id="stage2Status" style="display: none;"></div>
    </div>

    <!-- Stage 3: –ü–æ–∏—Å–∫ email -->
    <div class="stage-card" id="stage3Card">
      <div class="stage-header">
        <div class="stage-title">üìß Stage 3: –ü–æ–∏—Å–∫ email</div>
        <div class="stage-badge badge-ready" id="stage3Badge">–ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="stage3Count">-</div>
          <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –±–µ–∑ email</div>
        </div>
      </div>

      <!-- Real-time Progress Counter -->
      <div id="stage3ProgressContainer" style="display: none; margin: 15px 0; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #3b82f6;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <strong style="color: #3b82f6;">‚ö° –ü–æ–∏—Å–∫ email</strong>
          <span id="stage3ProgressPercent" style="font-size: 20px; font-weight: bold; color: #3b82f6;">0%</span>
        </div>
        <div style="font-size: 14px; color: #666; margin-bottom: 6px;">
          <span id="stage3ProgressText">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 –∏–∑ 0</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
          <div id="stage3ProgressBar" style="width: 0%; background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; transition: width 0.3s ease;"></div>
        </div>
        <div id="stage3CurrentCompany" style="margin-top: 8px; font-size: 12px; color: #888; font-style: italic; display: none;"></div>
      </div>

      <div id="stage3Companies" class="companies-list" style="display: none;"></div>

      <button class="button button-primary" id="stage3Btn" onclick="runStage(3)">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 3
      </button>

      <div id="stage3Status" style="display: none;"></div>
    </div>

    <!-- Stage 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è -->
    <div class="stage-card" id="stage4Card">
      <div class="stage-header">
        <div class="stage-title">ü§ñ Stage 4: AI –í–∞–ª–∏–¥–∞—Ü–∏—è</div>
        <div class="stage-badge badge-ready" id="stage4Badge">–ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="stage4Count">-</div>
          <div class="stat-label">–ö–æ–º–ø–∞–Ω–∏–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏</div>
        </div>
      </div>

      <!-- Real-time Progress Counter -->
      <div id="stage4ProgressContainer" style="display: none; margin: 15px 0; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #8b5cf6;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <strong style="color: #8b5cf6;">‚ö° AI –í–∞–ª–∏–¥–∞—Ü–∏—è</strong>
          <span id="stage4ProgressPercent" style="font-size: 20px; font-weight: bold; color: #8b5cf6;">0%</span>
        </div>
        <div style="font-size: 14px; color: #666; margin-bottom: 6px;">
          <span id="stage4ProgressText">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 –∏–∑ 0</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
          <div id="stage4ProgressBar" style="width: 0%; background: linear-gradient(90deg, #8b5cf6, #7c3aed); height: 100%; transition: width 0.3s ease;"></div>
        </div>
        <div id="stage4CurrentCompany" style="margin-top: 8px; font-size: 12px; color: #888; font-style: italic; display: none;"></div>
      </div>

      <div id="stage4Companies" class="companies-list" style="display: none;"></div>

      <button class="button button-primary" id="stage4Btn" onclick="runStage(4)">
        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 4
      </button>

      <div id="stage4Status" style="display: none;"></div>
    </div>

    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stage-card">
      <div class="stage-header">
        <div class="stage-title">‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
      </div>

      <div class="companies-stats">
        <div class="stat-box">
          <div class="stat-value" id="completedCount">-</div>
          <div class="stat-label">–ü—Ä–æ—à–ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalInDb">-</div>
          <div class="stat-label">–í—Å–µ–≥–æ –≤ –±–∞–∑–µ</div>
        </div>
      </div>

      <p style="color: #666; margin-top: 15px;">
        –ö–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –≤—Å–µ —ç—Ç–∞–ø—ã –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ 
        <a href="/results.html" style="color: #667eea; font-weight: 600;">—Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</a>.
      </p>
    </div>

    <!-- Footer -->
    <div style="text-align: center; color: white; margin-top: 30px; opacity: 0.9;">
      <p>Smart Email API ¬© 2025 | Powered by DeepSeek + Perplexity Sonar</p>
    </div>
  </div>

  <script>
    let isProcessing = false;
    let generatedQueries = [];
    let createdSessionId = null;

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      loadVersion();
      loadStatistics();
      loadSessions();
      
      // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
      setInterval(() => {
        if (!isProcessing) {
          loadStatistics();
        }
      }, 10000);
    });

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function loadVersion() {
      try {
        // Try to load version from API endpoint (always available)
        const versionResponse = await fetch('/api/version');
        if (versionResponse.ok) {
          const versionData = await versionResponse.json();
          const versionTag = versionData.tag || versionData.packageVersion || '3.0.0';
          document.getElementById('appVersion').textContent = 
            `${versionTag} | DeepSeek + Perplexity Integration`;
          
          // Show commit info (if git available)
          if (versionData.commitShort && versionData.commitDate && !versionData.error) {
            const commitDate = new Date(versionData.commitDate).toLocaleString('ru-RU', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            document.getElementById('commitInfo').innerHTML = 
              `<span title="${versionData.commitMessage || 'No commit message'}">` +
              `üì¶ Commit: <code>${versionData.commitShort}</code> ` +
              `| üåø ${versionData.branch} ` +
              `| üìÖ ${commitDate}` +
              `</span>`;
          } else {
            // Git not available (Railway deployment)
            const buildDate = versionData.buildDate ? 
              new Date(versionData.buildDate).toLocaleString('ru-RU', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) : 'Production';
            
            document.getElementById('commitInfo').innerHTML = 
              `<span>üöÄ Railway Deployment | üìÖ ${buildDate}</span>`;
          }
        } else {
          // Fallback if API fails
          document.getElementById('appVersion').textContent = 'v3.0.0 | DeepSeek + Perplexity Integration';
        }
      } catch (error) {
        console.error('Failed to load version info:', error);
        document.getElementById('appVersion').textContent = 'v3.0.0 | DeepSeek + Perplexity Integration';
      }
    }

    async function generateQueries() {
      const topic = document.getElementById('mainTopic').value.trim();
      const numQueries = parseInt(document.getElementById('numQueries').value);
      const numPasses = parseInt(document.getElementById('numPasses').value);
      const statusDiv = document.getElementById('generationStatus');
      const progressContainer = document.getElementById('generationProgressContainer');
      const generateBtn = document.getElementById('generateBtn');

      if (!topic) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤');
        return;
      }

      if (numQueries < 10 || numQueries > 50) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 10 –¥–æ 50');
        return;
      }

      if (numPasses < 1 || numPasses > 100) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100');
        return;
      }

      // Disable button and show progress
      generateBtn.disabled = true;
      statusDiv.style.display = 'none';
      progressContainer.style.display = 'block';
      generatedQueries = [];
      let allSavedQueries = [];
      let totalGenerated = 0;
      let totalRelevant = 0;
      let totalSaved = 0;
      let totalDuplicates = 0;

      try {
        for (let pass = 1; pass <= numPasses; pass++) {
          // Update progress
          const progressPercent = Math.round(((pass - 1) / numPasses) * 100);
          document.getElementById('generationProgressPercent').textContent = progressPercent + '%';
          document.getElementById('generationProgressText').textContent = `–ü—Ä–æ—Ö–æ–¥: ${pass} –∏–∑ ${numPasses}`;
          document.getElementById('generationProgressBar').style.width = progressPercent + '%';
          document.getElementById('generationCurrentStatus').textContent = `‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ${numQueries} –∑–∞–ø—Ä–æ—Å–æ–≤...`;

          // Generate queries
          const response = await fetch('/api/queries/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, numQueries })
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || 'Unknown error');
          }

          const queries = result.queries || [];
          totalGenerated += queries.length;
          
          // Filter relevant queries (‚â•70%)
          const relevantQueries = queries.filter(q => {
            const relevance = q.relevance || q.relevance_score || 0;
            return relevance >= 70;
          });
          totalRelevant += relevantQueries.length;

          document.getElementById('generationCurrentStatus').textContent = `üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ${relevantQueries.length} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...`;

          // Save relevant queries automatically
          if (relevantQueries.length > 0) {
            const saveResponse = await fetch('/api/queries/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                mainTopic: topic,
                queries: relevantQueries,
                sessionId: createdSessionId  // –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π sessionId –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
              })
            });

            const saveResult = await saveResponse.json();

            if (saveResult.success) {
              const saved = saveResult.count || 0;
              const duplicates = 0;
              totalSaved += saved;
              totalDuplicates += duplicates;
              
              // Collect saved queries for display
              allSavedQueries.push(...relevantQueries.slice(0, saved));
              
              // –ó–∞–ø–æ–º–Ω–∏—Ç—å sessionId –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø—Ä–æ—Ö–æ–¥–µ
              if (!createdSessionId && saveResult.sessionId) {
                createdSessionId = saveResult.sessionId;
              }
            }
          }

          // Small delay between passes
          if (pass < numPasses) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        }

        // Complete progress
        document.getElementById('generationProgressPercent').textContent = '100%';
        document.getElementById('generationProgressText').textContent = `–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${numPasses} –∏–∑ ${numPasses}`;
        document.getElementById('generationProgressBar').style.width = '100%';
        document.getElementById('generationCurrentStatus').textContent = '‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';

        // Display results
        generatedQueries = allSavedQueries;
        displaySavedQueries(allSavedQueries, totalGenerated, totalRelevant, totalSaved, totalDuplicates);
        
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `<div class="status-message status-success">‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±–∞–≤–ª–µ–Ω–æ ${totalSaved} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑—É.</div>`;
        document.getElementById('queriesSection').style.display = 'block';

        // Reload sessions to show new topic
        loadSessions();

        // Auto-select created session in Stage 1
        setTimeout(async () => {
          if (createdSessionId) {
            const select = document.getElementById('stage1SessionSelect');
            select.value = createdSessionId;
            await updateStage1SessionInfo();
            
            // Scroll to Stage 1
            document.getElementById('stage1Card').scrollIntoView({ 
              behavior: 'smooth', 
              block: 'start' 
            });
          }
        }, 1000);

      } catch (error) {
        console.error('Generation error:', error);
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `<div class="status-message status-error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        progressContainer.style.display = 'none';
      } finally {
        generateBtn.disabled = false;
      }
    }

    function displaySavedQueries(queries, totalGenerated, totalRelevant, totalSaved, totalDuplicates) {
      // Calculate unique saved queries
      const uniqueQueries = new Set();
      queries.forEach(q => {
        const queryCn = q.query_cn || q.chinese_query || q.query;
        uniqueQueries.add(queryCn.toLowerCase().trim());
      });
      const uniqueSavedCount = uniqueQueries.size;

      // Update statistics
      document.getElementById('totalGenerated').textContent = totalGenerated;
      document.getElementById('relevantCount').textContent = totalRelevant;
      document.getElementById('savedCount').textContent = totalSaved;
      document.getElementById('duplicatesCount').textContent = totalDuplicates;
      document.getElementById('uniqueSavedCount').textContent = uniqueSavedCount;

      // Display queries list with relevance scores
      const container = document.getElementById('queriesList');
      container.innerHTML = queries.map((q, idx) => {
        const relevance = q.relevance || q.relevance_score || 0;
        const relevanceColor = relevance >= 80 ? '#10b981' : relevance >= 70 ? '#f59e0b' : '#ef4444';
        const relevanceLabel = relevance >= 80 ? '–í—ã—Å–æ–∫–∞—è' : relevance >= 70 ? '–°—Ä–µ–¥–Ω—è—è' : '–ù–∏–∑–∫–∞—è';
        
        return `
        <div class="query-item" style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
          <div style="flex: 1;">
            <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${q.query_cn || q.chinese_query || q.query}</div>
            <div style="font-size: 14px; color: #666;">${q.query_ru || q.russian_query || q.translation || ''}</div>
          </div>
          <div style="margin-left: 20px; text-align: center; min-width: 80px; padding: 8px 12px; background: ${relevanceColor}15; border-radius: 6px; border: 2px solid ${relevanceColor};">
            <div style="font-size: 22px; font-weight: bold; color: ${relevanceColor};">${relevance}</div>
            <div style="font-size: 11px; color: ${relevanceColor}; font-weight: 600; margin-top: 2px;">${relevanceLabel}</div>
          </div>
        </div>
      `;
      }).join('');
    }

    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const result = await response.json();
        
        if (result.success) {
          const select = document.getElementById('stage1SessionSelect');
          const currentValue = select.value;
          
          select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É --</option>';
          
          // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 'data', –∞ –Ω–µ 'sessions'
          const sessions = result.data || result.sessions || [];
          
          sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.session_id;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º topic_description –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ search_query
            const topicName = session.topic_description || session.main_topic || session.search_query;
            option.textContent = `${topicName} (${new Date(session.created_at).toLocaleDateString()})`;
            select.appendChild(option);
          });
          
          // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–æ
          if (currentValue) {
            select.value = currentValue;
          } else if (createdSessionId) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Ç–µ–º–∞ - –≤—ã–±—Ä–∞—Ç—å –µ—ë
            select.value = createdSessionId;
          }
          
          // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –≤—ã–±—Ä–∞–Ω–æ
          if (select.value) {
            await updateStage1SessionInfo();
          }
        }
      } catch (error) {
        console.error('Error loading sessions:', error);
      }
    }

    async function updateStage1SessionInfo() {
      const sessionId = document.getElementById('stage1SessionSelect').value;
      const infoDiv = document.getElementById('stage1SessionInfo');
      const btn = document.getElementById('stage1Btn');

      if (!sessionId) {
        infoDiv.style.display = 'none';
        btn.disabled = true;
        return;
      }

      try {
        const response = await fetch(`/api/sessions/${sessionId}`);
        const result = await response.json();

        if (result.success) {
          const session = result.data || result.session;
          
          // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ target_count –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
          const queriesCount = session.target_count || 0;
          
          document.getElementById('stage1QueriesCount').textContent = queriesCount;
          document.getElementById('stage1SessionStatus').textContent = session.status || '–Ω–æ–≤–∞—è';
          infoDiv.style.display = 'block';
          btn.disabled = false;
        }
      } catch (error) {
        console.error('Error loading session info:', error);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
    document.getElementById('stage1SessionSelect')?.addEventListener('change', updateStage1SessionInfo);

    /**
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ Stage 1
     * –û–±–Ω–æ–≤–ª—è–µ—Ç UI –∫–∞–∂–¥—ã–µ 500ms
     */
    function startStage1ProgressMonitor(sessionId) {
      const progressBar = document.getElementById('stage1ProgressBar');
      const progressPercent = document.getElementById('stage1ProgressPercent');
      const progressText = document.getElementById('stage1ProgressText');
      const currentQuery = document.getElementById('stage1CurrentQuery');
      
      async function updateProgress() {
        try {
          const response = await fetch(`/api/sessions/${sessionId}/stage1-progress`);
          const data = await response.json();
          
          if (data.success && data.progress) {
            const { processedQueries, totalQueries, remainingQueries, percentComplete, currentQuery: query } = data.progress;
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            progressBar.style.width = `${percentComplete}%`;
            progressPercent.textContent = `${percentComplete}%`;
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
            progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processedQueries} –∏–∑ ${totalQueries} (–æ—Å—Ç–∞–ª–æ—Å—å: ${remainingQueries})`;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
            if (query) {
              currentQuery.style.display = 'block';
              currentQuery.textContent = `–¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å: ${query}`;
            } else {
              currentQuery.style.display = 'none';
            }
            
            // –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            if (percentComplete >= 100 || remainingQueries === 0) {
              progressText.textContent = `‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${totalQueries} –∑–∞–ø—Ä–æ—Å–æ–≤`;
              currentQuery.style.display = 'none';
            }
          }
        } catch (error) {
          console.error('Failed to update Stage 1 progress:', error);
        }
      }
      
      // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
      updateProgress();
      
      // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 500ms
      return setInterval(updateProgress, 500);
    }

    /**
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ Stage 2
     * –û–±–Ω–æ–≤–ª—è–µ—Ç UI –∫–∞–∂–¥—ã–µ 500ms
     */
    function startStage2ProgressMonitor(sessionId) {
      const progressBar = document.getElementById('stage2ProgressBar');
      const progressPercent = document.getElementById('stage2ProgressPercent');
      const progressText = document.getElementById('stage2ProgressText');
      const currentCompany = document.getElementById('stage2CurrentCompany');
      
      async function updateProgress() {
        try {
          const response = await fetch(`/api/sessions/${sessionId}/stage2-progress`);
          const data = await response.json();
          
          if (data.success && data.progress) {
            const { processedCompanies, totalCompanies, remainingCompanies, percentComplete, currentCompany: company } = data.progress;
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            progressBar.style.width = `${percentComplete}%`;
            progressPercent.textContent = `${percentComplete}%`;
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
            progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processedCompanies} –∏–∑ ${totalCompanies} (–æ—Å—Ç–∞–ª–æ—Å—å: ${remainingCompanies})`;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–º–ø–∞–Ω–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
            if (company) {
              currentCompany.style.display = 'block';
              currentCompany.textContent = `–¢–µ–∫—É—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è: ${company}`;
            } else {
              currentCompany.style.display = 'none';
            }
            
            // –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            if (percentComplete >= 100 || remainingCompanies === 0) {
              progressText.textContent = `‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${totalCompanies} –∫–æ–º–ø–∞–Ω–∏–π`;
              currentCompany.style.display = 'none';
            }
          }
        } catch (error) {
          console.error('Failed to update Stage 2 progress:', error);
        }
      }
      
      // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
      updateProgress();
      
      // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 500ms
      return setInterval(updateProgress, 500);
    }

    async function runStage1() {
      const sessionId = document.getElementById('stage1SessionSelect').value;
      
      if (!sessionId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É');
        return;
      }

      if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1 –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã?`)) {
        return;
      }

      const btn = document.getElementById('stage1Btn');
      const statusDiv = document.getElementById('stage1Status');
      const badge = document.getElementById('stage1Badge');
      const progressContainer = document.getElementById('stage1ProgressContainer');

      isProcessing = true;
      btn.disabled = true;
      btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.className = 'stage-badge badge-running';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –ò—â–µ–º –∫–æ–º–ø–∞–Ω–∏–∏...</div>';

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
      progressContainer.style.display = 'block';
      
      // –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      const progressMonitor = startStage1ProgressMonitor(sessionId);

      try {
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1 –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        const requestPromise = fetch(`/api/sessions/${sessionId}/stage1`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await requestPromise.then(r => r.json());

        if (result.success) {
          statusDiv.innerHTML = `
            <div class="status-message status-success">
              ‚úÖ <strong>Stage 1 –∑–∞–≤–µ—Ä—à–µ–Ω!</strong><br>
              –ù–∞–π–¥–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π: ${result.total || 0}
            </div>
          `;
          
          // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          setTimeout(() => loadStatistics(), 1000);
        } else {
          // –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏
          const error = new Error(result.error || 'Unknown error');
          error.details = result.details;
          throw error;
        }

      } catch (error) {
        console.error('Stage 1 error:', error);
        
        // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–≤–ª–µ—á—å –¥–µ—Ç–∞–ª–∏ –∏–∑ result –µ—Å–ª–∏ –µ—Å—Ç—å
        let errorDetails = '';
        if (error.details) {
          errorDetails = `<br><small style="color: #666;">${error.details}</small>`;
        }
        
        statusDiv.innerHTML = `
          <div class="status-message status-error">
            ‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}${errorDetails}
          </div>
        `;
      } finally {
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        if (progressMonitor) {
          clearInterval(progressMonitor);
        }
        
        // –°–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 2000);
        
        isProcessing = false;
        btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É';
        btn.disabled = false;
        setTimeout(() => {
          loadStatistics();
          badge.className = 'stage-badge badge-ready';
          badge.textContent = '–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É';
        }, 2000);
      }
    }

    /**
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1 –¥–ª—è –í–°–ï–• —Ç–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
     */
    async function runAllStage1Topics() {
      if (!confirm('üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1 –¥–ª—è –í–°–ï–• —Ç–µ–º?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ —Ç–µ–º—ã –ø–æ–¥—Ä—è–¥.')) {
        return;
      }

      const btn = document.getElementById('stage1Btn');
      const btnAll = document.getElementById('stage1AllBtn');
      const statusDiv = document.getElementById('stage1Status');
      const badge = document.getElementById('stage1Badge');
      const progressContainer = document.getElementById('stage1AllProgress');
      const singleProgressContainer = document.getElementById('stage1ProgressContainer');

      isProcessing = true;
      btn.disabled = true;
      btnAll.disabled = true;
      btnAll.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ–º...';
      badge.textContent = '–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.className = 'stage-badge badge-running';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–µ–º...</div>';
      progressContainer.style.display = 'block';
      singleProgressContainer.style.display = 'none';

      let processed = 0;
      let totalCompanies = 0;
      let successCount = 0;
      let failedCount = 0;

      try {
        // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏
        const response = await fetch('/api/sessions');
        const result = await response.json();
        
        if (!result.success) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–º');
        }
        
        const sessions = result.data || [];
        
        // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏–ª–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
        const pendingSessions = sessions.filter(s => {
          // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞—Ö–æ—Ç–µ—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
          return true;
        });
        
        if (pendingSessions.length === 0) {
          statusDiv.innerHTML = '<div class="status-message status-info">‚ÑπÔ∏è –ù–µ—Ç —Ç–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>';
          progressContainer.style.display = 'none';
          return;
        }
        
        const totalSessions = pendingSessions.length;
        
        statusDiv.innerHTML = `<div class="status-message status-info">
          üìã –ù–∞–π–¥–µ–Ω–æ —Ç–µ–º: <strong>${totalSessions}</strong><br>
          ‚è≥ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...
        </div>`;
        
        // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—É—é —Ç–µ–º—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
        for (const session of pendingSessions) {
          const topicName = session.topic_description || session.search_query || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
          const shortTopic = topicName.length > 60 ? topicName.substring(0, 60) + '...' : topicName;
          
          // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
          const percent = Math.round((processed / totalSessions) * 100);
          document.getElementById('stage1AllProgressPercent').textContent = `${percent}%`;
          document.getElementById('stage1AllProgressText').textContent = `–¢–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}/${totalSessions}`;
          document.getElementById('stage1AllProgressBar').style.width = `${percent}%`;
          document.getElementById('stage1AllCurrentTopic').innerHTML = `
            üéØ <strong>–¢–µ–º–∞ ${processed + 1}/${totalSessions}:</strong> ${shortTopic}<br>
            ‚è≥ –ò–¥—ë—Ç –ø–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π...
          `;
          document.getElementById('stage1AllTotalCompanies').textContent = totalCompanies;
          
          statusDiv.innerHTML = `<div class="status-message status-info">
            üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º—ã <strong>${processed + 1}/${totalSessions}</strong><br>
            üéØ ${shortTopic}<br>
            ‚è≥ –ò—â–µ–º –∫–æ–º–ø–∞–Ω–∏–∏...
          </div>`;
          
          try {
            // –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 1 –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã
            const stageResponse = await fetch(`/api/sessions/${session.session_id}/stage1`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            const stageResult = await stageResponse.json();
            
            if (stageResult.success) {
              const foundCompanies = stageResult.total || 0;
              totalCompanies += foundCompanies;
              successCount++;
              
              // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
              processed++;
              const newPercent = Math.round((processed / totalSessions) * 100);
              document.getElementById('stage1AllProgressPercent').textContent = `${newPercent}%`;
              document.getElementById('stage1AllProgressText').textContent = `–¢–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}/${totalSessions}`;
              document.getElementById('stage1AllProgressBar').style.width = `${newPercent}%`;
              document.getElementById('stage1AllCurrentTopic').innerHTML = `
                ‚úÖ <strong>–¢–µ–º–∞ ${processed}/${totalSessions} –∑–∞–≤–µ—Ä—à–µ–Ω–∞:</strong> ${shortTopic}<br>
                üìä –ù–∞–π–¥–µ–Ω–æ: <strong style="color: #10b981;">${foundCompanies}</strong> –∫–æ–º–ø–∞–Ω–∏–π
              `;
              document.getElementById('stage1AllTotalCompanies').textContent = totalCompanies;
              
              statusDiv.innerHTML = `<div class="status-message status-success">
                ‚úÖ –¢–µ–º–∞ <strong>${processed}/${totalSessions}</strong> –∑–∞–≤–µ—Ä—à–µ–Ω–∞<br>
                üìä –ù–∞–π–¥–µ–Ω–æ: ${foundCompanies} –∫–æ–º–ø–∞–Ω–∏–π<br>
                üìà –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: <strong style="color: #10b981;">${totalCompanies}</strong> –∫–æ–º–ø–∞–Ω–∏–π
              </div>`;
              
              // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
              await new Promise(resolve => setTimeout(resolve, 800));
              
            } else {
              throw new Error(stageResult.error || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–º—ã');
            }
            
          } catch (topicError) {
            console.error(`Error processing topic ${session.session_id}:`, topicError);
            failedCount++;
            processed++;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
            const newPercent = Math.round((processed / totalSessions) * 100);
            document.getElementById('stage1AllProgressPercent').textContent = `${newPercent}%`;
            document.getElementById('stage1AllProgressText').textContent = `–¢–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}/${totalSessions}`;
            document.getElementById('stage1AllProgressBar').style.width = `${newPercent}%`;
            document.getElementById('stage1AllCurrentTopic').innerHTML = `
              ‚ö†Ô∏è <strong>–¢–µ–º–∞ ${processed}/${totalSessions} - –æ—à–∏–±–∫–∞:</strong> ${shortTopic}<br>
              ‚ùå ${topicError.message}
            `;
            
            statusDiv.innerHTML = `<div class="status-message status-error">
              ‚ö†Ô∏è –¢–µ–º–∞ <strong>${processed}/${totalSessions}</strong> - –æ—à–∏–±–∫–∞<br>
              ${topicError.message}<br>
              <small>–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...</small>
            </div>`;
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π —Ç–µ–º–æ–π
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
        
        // –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        const finalPercent = 100;
        document.getElementById('stage1AllProgressPercent').textContent = `${finalPercent}%`;
        document.getElementById('stage1AllProgressText').textContent = `–¢–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}/${totalSessions}`;
        document.getElementById('stage1AllProgressBar').style.width = `${finalPercent}%`;
        document.getElementById('stage1AllCurrentTopic').innerHTML = `
          üéâ <strong>–í–°–ï –¢–ï–ú–´ –û–ë–†–ê–ë–û–¢–ê–ù–´!</strong>
        `;
        document.getElementById('stage1AllTotalCompanies').textContent = totalCompanies;
        
        statusDiv.innerHTML = `<div class="status-message status-success">
          üéâ <strong>–ü–ê–ö–ï–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!</strong><br><br>
          üìä <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
          ‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–µ–º: <strong style="color: #10b981;">${successCount}</strong><br>
          ${failedCount > 0 ? `‚ùå –û—à–∏–±–æ–∫: <strong style="color: #ef4444;">${failedCount}</strong><br>` : ''}
          üè¢ –í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ: <strong style="color: #667eea; font-size: 18px;">${totalCompanies}</strong>
        </div>`;
        
        // –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        setTimeout(() => loadStatistics(), 1000);
        
      } catch (error) {
        console.error('Error running all topics:', error);
        statusDiv.innerHTML = `<div class="status-message status-error">
          ‚ùå <strong>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:</strong> ${error.message}
        </div>`;
        progressContainer.style.display = 'none';
      } finally {
        isProcessing = false;
        btn.disabled = false;
        btnAll.disabled = false;
        btnAll.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–°–ï —Ç–µ–º—ã';
        badge.textContent = '–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É';
        badge.className = 'stage-badge badge-ready';
      }
    }

    async function loadStatistics() {
      try {
        const response = await fetch('/api/debug/data');
        const data = await response.json();
        
        if (!data.success) {
          throw new Error('Failed to load data');
        }

        const companies = data.data.pending_companies?.items || [];
        
        // Stage 2: –∫–æ–º–ø–∞–Ω–∏–∏ –±–µ–∑ —Å–∞–π—Ç–∞, current_stage >= 1, stage2_status = NULL
        const stage2Ready = companies.filter(c => 
          (!c.website || c.website === '') &&
          c.stage2_status === null &&
          c.current_stage >= 1
        );

        // Stage 3: –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Å–∞–π—Ç–æ–º, –±–µ–∑ email, current_stage >= 2, stage3_status = NULL
        const stage3Ready = companies.filter(c =>
          c.website &&
          (!c.email || c.email === '') &&
          c.stage3_status === null &&
          c.current_stage >= 2
        );

        // Stage 4: –∫–æ–º–ø–∞–Ω–∏–∏ —Å email, current_stage >= 3, stage4_status = NULL
        const stage4Ready = companies.filter(c =>
          c.current_stage >= 3 &&
          c.stage4_status === null
        );

        // –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏: current_stage = 4 –∏ stage4_status != NULL
        const completed = companies.filter(c =>
          c.current_stage === 4 &&
          c.stage4_status !== null
        );

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏
        document.getElementById('stage2Count').textContent = stage2Ready.length;
        document.getElementById('stage3Count').textContent = stage3Ready.length;
        document.getElementById('stage4Count').textContent = stage4Ready.length;
        document.getElementById('completedCount').textContent = completed.length;
        document.getElementById('totalInDb').textContent = companies.length;

        // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂–∏ –∏ –∫–Ω–æ–ø–∫–∏
        updateStageBadge(2, stage2Ready.length);
        updateStageBadge(3, stage3Ready.length);
        updateStageBadge(4, stage4Ready.length);

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π
        displayCompanies(2, stage2Ready);
        displayCompanies(3, stage3Ready);
        displayCompanies(4, stage4Ready);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    function updateStageBadge(stage, count) {
      const badge = document.getElementById(`stage${stage}Badge`);
      const btn = document.getElementById(`stage${stage}Btn`);
      
      if (count === 0) {
        badge.textContent = '–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π';
        badge.className = 'stage-badge badge-empty';
        btn.disabled = true;
      } else {
        badge.textContent = `${count} ${getCompanyWord(count)}`;
        badge.className = 'stage-badge badge-ready';
        btn.disabled = false;
      }
    }

    function displayCompanies(stage, companies) {
      const container = document.getElementById(`stage${stage}Companies`);
      
      if (companies.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      container.innerHTML = companies.slice(0, 10).map(c => `
        <div class="company-item">
          <div class="company-name">${c.company_name}</div>
          <div class="company-info">
            ${c.website ? `üåê ${c.website}` : '‚ùå –ù–µ—Ç —Å–∞–π—Ç–∞'} | 
            ${c.email ? `üìß ${c.email}` : '‚ùå –ù–µ—Ç email'}
          </div>
        </div>
      `).join('');

      if (companies.length > 10) {
        container.innerHTML += `<div class="company-item" style="text-align: center; color: #999;">
          –ò –µ—â–µ ${companies.length - 10} –∫–æ–º–ø–∞–Ω–∏–π...
        </div>`;
      }
    }

    async function runStage(stageNum) {
      if (isProcessing) {
        alert('–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.');
        return;
      }

      const btn = document.getElementById(`stage${stageNum}Btn`);
      const statusDiv = document.getElementById(`stage${stageNum}Status`);
      const badge = document.getElementById(`stage${stageNum}Badge`);
      const progressContainer = document.getElementById(`stage${stageNum}ProgressContainer`);

      if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å Stage ${stageNum} –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ç–æ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π?`)) {
        return;
      }

      isProcessing = true;
      btn.disabled = true;
      btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      badge.className = 'stage-badge badge-running';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div class="status-message status-info">‚è≥ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...</div>';

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è Stage 2, 3 –∏ 4 —Å SSE
      let eventSource = null;
      if ((stageNum === 2 || stageNum === 3 || stageNum === 4) && progressContainer) {
        progressContainer.style.display = 'block';
        
        // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ SSE stream
        eventSource = new EventSource('/api/sessions/global/progress-stream');
        
        eventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            const stageKey = `stage${stageNum}`;
            const stageProgress = data[stageKey];
            
            if (stageProgress && stageProgress.active) {
              const percent = stageProgress.total > 0 
                ? Math.round((stageProgress.processed / stageProgress.total) * 100)
                : 0;
              
              // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
              const progressBar = document.getElementById(`${stageKey}ProgressBar`);
              const progressPercent = document.getElementById(`${stageKey}ProgressPercent`);
              const progressText = document.getElementById(`${stageKey}ProgressText`);
              const currentItem = document.getElementById(`${stageKey}CurrentCompany`);
              
              if (progressBar) progressBar.style.width = `${percent}%`;
              if (progressPercent) progressPercent.textContent = `${percent}%`;
              if (progressText) {
                progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${stageProgress.processed} –∏–∑ ${stageProgress.total}`;
              }
              if (currentItem && stageProgress.current) {
                currentItem.style.display = 'block';
                currentItem.textContent = `–¢–µ–∫—É—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è: ${stageProgress.current}`;
              } else if (currentItem) {
                currentItem.style.display = 'none';
              }
            }
          } catch (error) {
            console.error('Failed to parse SSE data:', error);
          }
        };
        
        eventSource.onerror = (error) => {
          console.error('SSE connection error:', error);
          eventSource.close();
        };
      }

      try {
        let endpoint;
        if (stageNum === 2) endpoint = '/api/sessions/global/stage2';
        else if (stageNum === 3) endpoint = '/api/sessions/global/stage3';
        else if (stageNum === 4) endpoint = '/api/sessions/global/stage4';

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `
            <div class="status-message status-success">
              ‚úÖ <strong>Stage ${stageNum} –∑–∞–≤–µ—Ä—à–µ–Ω!</strong><br>
              ${getStageResultMessage(stageNum, result)}
            </div>
          `;
          
          // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          setTimeout(() => loadStatistics(), 1000);
        } else {
          throw new Error(result.error || 'Unknown error');
        }

      } catch (error) {
        console.error(`Stage ${stageNum} error:`, error);
        statusDiv.innerHTML = `
          <div class="status-message status-error">
            ‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
          </div>
        `;
      } finally {
        // –ó–∞–∫—Ä—ã—Ç—å SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if (eventSource) {
          eventSource.close();
        }
        
        // –°–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        if (progressContainer) {
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 2000);
        }
        
        isProcessing = false;
        btn.textContent = `üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage ${stageNum}`;
        setTimeout(() => loadStatistics(), 2000);
      }
    }

    function getStageResultMessage(stage, result) {
      if (stage === 2) {
        return `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.total || 0} | –ù–∞–π–¥–µ–Ω–æ —Å–∞–π—Ç–æ–≤: ${result.found || 0}`;
      } else if (stage === 3) {
        return `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.processed || 0} | –ù–∞–π–¥–µ–Ω–æ email: ${result.found || 0}`;
      } else if (stage === 4) {
        return `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.total || 0} | –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–æ: ${result.validated || 0} | –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${result.rejected || 0}`;
      }
      return '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
    }

    function getCompanyWord(count) {
      const lastDigit = count % 10;
      const lastTwoDigits = count % 100;
      
      if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
        return '–∫–æ–º–ø–∞–Ω–∏–π';
      }
      if (lastDigit === 1) {
        return '–∫–æ–º–ø–∞–Ω–∏—è';
      }
      if (lastDigit >= 2 && lastDigit <= 4) {
        return '–∫–æ–º–ø–∞–Ω–∏–∏';
      }
      return '–∫–æ–º–ø–∞–Ω–∏–π';
    }

    async function clearDatabase() {
      if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã:\n\n- –í—Å–µ —Å–µ—Å—Å–∏–∏\n- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã\n- –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏\n- –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
        return;
      }

      if (!confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û! –í—ã —Ç–æ—á–Ω–æ —É–≤–µ—Ä–µ–Ω—ã?')) {
        return;
      }

      try {
        const response = await fetch('/api/sessions/clear-all', {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          alert(`‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞!\n\n–û—á–∏—â–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: ${result.cleared_tables.length}`);
          window.location.reload();
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Clear database error:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±–∞–∑—ã: ${error.message}`);
      }
    }

    async function logout() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
        return;
      }

      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = '/login.html';
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
      }
    }
  </script>
  
  <!-- Queue Monitor Widget -->
  <script src="/queue-monitor.js"></script>
</body>
</html>
