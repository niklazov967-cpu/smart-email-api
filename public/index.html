<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Email API - –ü–æ—Ä—Ç–∞–ª —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
            position: relative;
        }

        .button:hover {
            background: #5568d3;
        }

        .button:active {
            transform: scale(0.98);
        }

        .button.loading {
            background: #9ca3af;
            cursor: wait;
            pointer-events: none;
        }

        .button.loading::after {
            content: "";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spinner 0.6s linear infinite;
        }

        @keyframes spinner {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .button.secondary {
            background: #6b7280;
        }

        .button.secondary:hover {
            background: #4b5563;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
            <h1>üöÄ Smart Email API</h1>
            <p>–ü–æ—Ä—Ç–∞–ª —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π</p>
            <span class="status" id="status">‚óè –†–∞–±–æ—Ç–∞–µ—Ç</span>
            <p style="margin-top: 15px; color: #999;">–í–µ—Ä—Å–∏—è 1.3.0 | DeepSeek + Perplexity Integration (48% —ç–∫–æ–Ω–æ–º–∏–∏)</p>
            <div style="margin-top: 15px;">
                <button onclick="clearDatabase()" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                </button>
            </div>
        </div>

        <!-- Quick Start Instructions -->
        <div class="card" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 5px solid #4caf50;">
            <h2 style="color: #2e7d32;">üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h2>
            <div style="color: #1b5e20; line-height: 1.8;">
                <p style="margin-bottom: 15px; font-weight: 600;">üéØ <strong>–†–ï–ö–û–ú–ï–ù–î–£–ï–ú:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ï–¥–∏–Ω—É—é –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã!</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 20px 0;">
                    <a href="/dashboard.html" style="display: block; text-decoration: none;">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s; height: 100%;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">üìä –ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                            <p style="color: #666; margin-bottom: 10px;">–í—Å–µ —à–∞–≥–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏</p>
                            <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 5px; font-weight: 600; display: inline-block;">‚Üí –û—Ç–∫—Ä—ã—Ç—å Dashboard</span>
                        </div>
                    </a>
                    
                    <a href="/step-by-step.html" style="display: block; text-decoration: none;">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s; height: 100%;">
                            <h3 style="color: #10b981; margin-bottom: 10px;">üë£ –ü–æ—à–∞–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</h3>
                            <p style="color: #666; margin-bottom: 10px;">–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>
                            <span style="background: #10b981; color: white; padding: 8px 16px; border-radius: 5px; font-weight: 600; display: inline-block;">‚Üí –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—à–∞–≥–æ–≤–æ</span>
                        </div>
                    </a>
                </div>

                <p style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 5px;">
                    <strong>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º:</strong>
                </p>

                <ol style="margin-left: 25px;">
                    <li style="margin-bottom: 10px;">
                        <strong>–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã:</strong> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 
                        <a href="/queries.html" style="color: #1565c0; text-decoration: underline;">"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏"</a>, 
                        –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∏ –ø–æ–ª—É—á–∏—Ç–µ 10-50 –ø–æ–¥-–∑–∞–ø—Ä–æ—Å–æ–≤
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>–í—ã–±–µ—Ä–∏—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ:</strong> –û—Ç–º–µ—Ç—å—Ç–µ –Ω—É–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É:</strong> –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å"
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º:</strong> –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    </li>
                </ol>
                
                <p style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 5px;">
                    üí° <strong>–°–æ–≤–µ—Ç:</strong> –û–±—Ä–∞–±–æ—Ç–∫–∞ 10 –∫–æ–º–ø–∞–Ω–∏–π –∑–∞–Ω–∏–º–∞–µ—Ç 5-10 –º–∏–Ω—É—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 
                    <a href="/progress.html" style="color: #1565c0; text-decoration: underline;">"–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏"</a> –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                </p>
            </div>
        </div>

        <!-- Main Action Buttons -->
        <div class="card">
            <h2 style="color: #667eea; margin-bottom: 20px;">üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π</h2>
            
            <div class="input-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="processSessionId" style="flex: 1;">
                        <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π... --</option>
                    </select>
                    <button class="button secondary" onclick="loadSessions()" style="white-space: nowrap;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                
                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ -->
                <div id="sessionInfo" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <p style="margin-bottom: 8px;"><strong>–ó–∞–ø—Ä–æ—Å:</strong> <span id="sessionQuery" style="color: #667eea;"></span></p>
                    <p style="margin-bottom: 8px;"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="sessionStatus"></span></p>
                    <p style="margin-bottom: 8px;"><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> <span id="sessionDate"></span></p>
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º -->
                    <div id="companiesStats" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <h4 style="margin: 0 0 10px 0; color: #667eea;">üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <div style="padding: 10px; background: #f0f9ff; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #0284c7;" id="totalCompanies">0</div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</div>
                            </div>
                            <div style="padding: 10px; background: #fef3c7; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #d97706;" id="unprocessedCompanies">0</div>
                                <div style="font-size: 12px; color: #666;">–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                            </div>
                            <div style="padding: 10px; background: #dcfce7; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #16a34a;" id="completedCompanies">0</div>
                                <div style="font-size: 12px; color: #666;">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                            </div>
                        </div>
                        
                        <!-- –°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π -->
                        <div id="unprocessedList" style="display: none;">
                            <h5 style="margin: 10px 0; color: #d97706;">‚è≥ –ö–æ–º–ø–∞–Ω–∏–∏ –æ–∂–∏–¥–∞—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h5>
                            <div id="unprocessedCompaniesContainer" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #fffbeb; border-radius: 5px;">
                                <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ Stage 2 -->
                        <div id="stage2ButtonContainer" style="display: none; margin-top: 15px;">
                            <button onclick="runStage2()" class="button" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 100%;">
                                üåê –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="processBtn" class="button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
            </button>
            
            <div style="margin-top: 20px;">
                <a href="/dashboard.html" style="display: inline-block; text-decoration: none;">
                    <button class="button" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        üìä –ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å (Dashboard)
                    </button>
                </a>
                
                <a href="/results.html" style="display: inline-block; text-decoration: none;">
                    <button class="button" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        üìß –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    </button>
                </a>
                
                <a href="/queries.html" style="display: inline-block; text-decoration: none;">
                    <button class="button" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        üîç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    </button>
                </a>
                
                <a href="/progress.html" style="display: inline-block; text-decoration: none;">
                    <button class="button" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    </button>
                </a>
            </div>
        </div>

        <div class="footer">
            <p>Smart Email API ¬© 2025 | Powered by DeepSeek + Perplexity Sonar</p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                <a href="/" style="color: white;">http://localhost:3030</a>
            </p>
        </div>
    </div>

    <script>
        async function clearDatabase() {
            const confirmed = confirm(
                '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n' +
                '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ:\n' +
                '‚Ä¢ –í—Å–µ —Å–µ—Å—Å–∏–∏\n' +
                '‚Ä¢ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã\n' +
                '‚Ä¢ –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏\n' +
                '‚Ä¢ –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏\n' +
                '‚Ä¢ –í–µ—Å—å –∫–µ—à API\n\n' +
                '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n' +
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã?'
            );

            if (!confirmed) return;

            const doubleConfirmed = confirm(
                'üî¥ –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!\n\n' +
                '–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã.\n\n' +
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
            );

            if (!doubleConfirmed) return;

            try {
                const response = await fetch('/api/sessions/clear-all', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞!\n\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function processSession(event) {
            console.log('=== processSession START ===');
            
            const sessionSelect = document.getElementById('processSessionId');
            const sessionId = sessionSelect.value.trim();
            console.log('Session ID:', sessionId);

            if (!sessionId) {
                console.warn('No session ID provided');
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞');
                return;
            }

            // Get button element
            const button = event.target;
            console.log('Button clicked:', button.textContent);

            // Show loading state
            button.classList.add('loading');
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = '‚è≥ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...';

            try {
                console.log('Sending POST request to /api/sessions/' + sessionId + '/process');
                
                const res = await fetch(`/api/sessions/${sessionId}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', res.status);
                const data = await res.json();
                console.log('Response data:', data);

                if (data.success) {
                    alert('‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å...');
                    
                    // Auto-redirect to progress page after 1 second
                    console.log('Redirecting to progress page...');
                    setTimeout(() => {
                        window.location.href = `/progress.html?session=${sessionId}`;
                    }, 1000);
                } else {
                    console.error('Error from API:', data.error);
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                console.error('Exception during processSession:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                // Restore button state
                button.classList.remove('loading');
                button.disabled = false;
                button.textContent = originalText;
                console.log('=== processSession END ===');
            }
        }

        async function loadSessions() {
            console.log('Loading sessions...');
            const select = document.getElementById('processSessionId');
            const sessionInfo = document.getElementById('sessionInfo');
            
            select.innerHTML = '<option value="">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            sessionInfo.style.display = 'none';
            
            try {
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏–∏
                const response = await fetch('/api/sessions?limit=100');
                const data = await response.json();
                
                if (!data.success || data.data.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Å—Å–∏–π</option>';
                    console.warn('No sessions found');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏
                const sessionsWithStats = await Promise.all(
                    data.data.map(async (session) => {
                        try {
                            const companiesRes = await fetch(`/api/debug/companies`);
                            const companiesData = await companiesRes.json();
                            
                            // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
                            const sessionCompanies = companiesData.companies?.filter(
                                c => c.session_id === session.session_id
                            ) || [];
                            
                            // –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ (–±–µ–∑ stage 'completed')
                            const unprocessed = sessionCompanies.filter(
                                c => !c.stage || c.stage !== 'completed'
                            ).length;
                            
                            return {
                                ...session,
                                totalCompanies: sessionCompanies.length,
                                unprocessedCount: unprocessed,
                                processedCount: sessionCompanies.length - unprocessed
                            };
                        } catch (err) {
                            console.error('Failed to load stats for session:', session.session_id, err);
                            return { ...session, totalCompanies: 0, unprocessedCount: 0, processedCount: 0 };
                        }
                    })
                );
                
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é --</option>';
                
                sessionsWithStats.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.session_id;
                    
                    const date = new Date(session.created_at).toLocaleDateString('ru-RU');
                    const status = session.status === 'pending' ? '‚è≥' : 
                                 session.status === 'processing' ? 'üîÑ' :
                                 session.status === 'completed' ? '‚úÖ' : '‚ùå';
                    
                    // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    let displayText = `${status} ${session.search_query} (${date})`;
                    if (session.totalCompanies > 0) {
                        displayText += ` | ${session.unprocessedCount} –Ω–µ–æ–±—Ä–∞–±.`;
                    }
                    
                    option.textContent = displayText;
                    option.dataset.query = session.search_query;
                    option.dataset.status = session.status;
                    option.dataset.date = session.created_at;
                    option.dataset.totalCompanies = session.totalCompanies;
                    option.dataset.unprocessedCount = session.unprocessedCount;
                    option.dataset.processedCount = session.processedCount;
                    
                    select.appendChild(option);
                });
                
                console.log(`Loaded ${sessionsWithStats.length} sessions with stats`);
            } catch (error) {
                console.error('Failed to load sessions:', error);
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }

        async function updateSessionInfo() {
            const select = document.getElementById('processSessionId');
            const sessionInfo = document.getElementById('sessionInfo');
            const companiesStats = document.getElementById('companiesStats');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                sessionInfo.style.display = 'none';
                return;
            }
            
            const sessionId = selectedOption.value;
            
            // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('sessionQuery').textContent = selectedOption.dataset.query || 'N/A';
            
            const statusMap = {
                'pending': '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ',
                'processing': 'üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞',
                'completed': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞',
                'failed': '‚ùå –û—à–∏–±–∫–∞'
            };
            document.getElementById('sessionStatus').textContent = statusMap[selectedOption.dataset.status] || selectedOption.dataset.status;
            
            const date = new Date(selectedOption.dataset.date);
            document.getElementById('sessionDate').textContent = date.toLocaleString('ru-RU');
            
            sessionInfo.style.display = 'block';
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏
            const totalCompanies = parseInt(selectedOption.dataset.totalCompanies) || 0;
            
            if (totalCompanies > 0) {
                companiesStats.style.display = 'block';
                
                const unprocessed = parseInt(selectedOption.dataset.unprocessedCount) || 0;
                const processed = parseInt(selectedOption.dataset.processedCount) || 0;
                
                document.getElementById('totalCompanies').textContent = totalCompanies;
                document.getElementById('unprocessedCompanies').textContent = unprocessed;
                document.getElementById('completedCompanies').textContent = processed;
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–∞–¥–∏–∏ names_found (–∂–¥—É—Ç Stage 2)
                const needsStage2 = await checkCompaniesNeedStage2(sessionId);
                
                if (unprocessed > 0 && needsStage2.hasCompaniesForStage2) {
                    // –ï—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ –æ–∂–∏–¥–∞—é—â–∏–µ Stage 2
                    await loadUnprocessedCompanies(sessionId);
                    document.getElementById('unprocessedList').style.display = 'block';
                    document.getElementById('stage2ButtonContainer').style.display = 'block';
                } else if (unprocessed > 0 && !needsStage2.hasCompaniesForStage2) {
                    // –í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã Stage 2+
                    document.getElementById('unprocessedList').style.display = 'block';
                    document.getElementById('unprocessedList').innerHTML = `
                        <div style="padding: 15px; background: #fef2f2; border-radius: 5px; border-left: 4px solid #ef4444;">
                            <h5 style="margin: 0 0 10px 0; color: #dc2626;">
                                ‚úÖ –í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã Stage 2+
                            </h5>
                            <p style="margin: 0; color: #991b1b; font-size: 14px;">
                                –í—Å–µ ${totalCompanies} –∫–æ–º–ø–∞–Ω–∏–π –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ —É–∂–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —ç—Ç–∞–ø–∞–º–∏ 2, 3 –∏–ª–∏ 4.
                            </p>
                            <p style="margin: 10px 0 0 0; color: #991b1b; font-size: 14px; font-weight: 600;">
                                üìù –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ 
                                <a href="/queries.html" style="color: #dc2626; text-decoration: underline;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏</a>
                            </p>
                        </div>
                    `;
                    document.getElementById('stage2ButtonContainer').style.display = 'none';
                } else {
                    // –í—Å–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
                    document.getElementById('unprocessedList').style.display = 'none';
                    document.getElementById('stage2ButtonContainer').style.display = 'none';
                }
            } else {
                companiesStats.style.display = 'none';
            }
        }

        async function checkCompaniesNeedStage2(sessionId) {
            try {
                const response = await fetch(`/api/debug/companies`);
                const data = await response.json();
                
                // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
                const sessionCompanies = data.companies?.filter(
                    c => c.session_id === sessionId
                ) || [];
                
                // –ö–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ —Å—Ç–∞–¥–∏–∏ names_found (–∂–¥—É—Ç Stage 2)
                const needsStage2 = sessionCompanies.filter(
                    c => c.stage === 'names_found' && !c.website
                );
                
                // –ö–æ–º–ø–∞–Ω–∏–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ Stage 2+ (–∏–º–µ—é—Ç website_found, contacts_found, completed, etc)
                const alreadyProcessed = sessionCompanies.filter(
                    c => c.stage && c.stage !== 'names_found'
                );
                
                return {
                    hasCompaniesForStage2: needsStage2.length > 0,
                    needsStage2Count: needsStage2.length,
                    alreadyProcessedCount: alreadyProcessed.length,
                    totalCount: sessionCompanies.length
                };
            } catch (error) {
                console.error('Failed to check companies stage:', error);
                return {
                    hasCompaniesForStage2: false,
                    needsStage2Count: 0,
                    alreadyProcessedCount: 0,
                    totalCount: 0
                };
            }
        }

        async function loadUnprocessedCompanies(sessionId) {
            try {
                const response = await fetch(`/api/debug/companies`);
                const data = await response.json();
                
                // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç Stage 2
                const needsStage2 = data.companies?.filter(
                    c => c.session_id === sessionId && c.stage === 'names_found' && !c.website
                ) || [];
                
                const container = document.getElementById('unprocessedCompaniesContainer');
                
                if (needsStage2.length === 0) {
                    container.innerHTML = '<p style="color: #666;">–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π –æ–∂–∏–¥–∞—é—â–∏—Ö Stage 2</p>';
                    return;
                }
                
                // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                let html = `
                    <div style="margin-bottom: 10px; padding: 10px; background: #fff7ed; border-radius: 5px;">
                        <strong style="color: #ea580c;">
                            ‚è≥ ${needsStage2.length} –∫–æ–º–ø–∞–Ω–∏–π –æ–∂–∏–¥–∞—é—Ç –ø–æ–∏—Å–∫–∞ —Å–∞–π—Ç–æ–≤ (Stage 2)
                        </strong>
                    </div>
                `;
                
                html += needsStage2.map((company, index) => {
                    const hasEmail = company.email ? 'üìß' : '‚ùå';
                    
                    return `
                        <div style="padding: 8px; margin-bottom: 5px; background: white; border-radius: 5px; border-left: 3px solid #f59e0b;">
                            <div style="font-weight: 600; color: #333;">${index + 1}. ${company.company_name}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                ‚ùå –°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω | ${hasEmail} Email | üéØ –û–∂–∏–¥–∞–µ—Ç: Stage 2
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load unprocessed companies:', error);
                document.getElementById('unprocessedCompaniesContainer').innerHTML = 
                    '<p style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</p>';
            }
        }

        async function runStage2() {
            const select = document.getElementById('processSessionId');
            const sessionId = select.value;
            
            if (!sessionId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é');
                return;
            }
            
            const confirmed = confirm(
                'üåê –ó–∞–ø—É—Å—Ç–∏—Ç—å Stage 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤?\n\n' +
                '–ë—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ–º–ø–∞–Ω–∏–∏ –±–µ–∑ —Å–∞–π—Ç–æ–≤.'
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/process-stage/2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force: false })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Stage 2 –∑–∞–ø—É—â–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å...');
                    setTimeout(() => {
                        window.location.href = `/progress.html?session=${sessionId}`;
                    }, 1000);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function checkStatus() {
            try {
                const res = await fetch('/health');
                const data = await res.json();
                
                if (data.status === 'OK') {
                    document.getElementById('status').textContent = '‚óè –†–∞–±–æ—Ç–∞–µ—Ç';
                    document.getElementById('status').style.background = '#10b981';
                }
            } catch (error) {
                document.getElementById('status').textContent = '‚óè –û—à–∏–±–∫–∞';
                document.getElementById('status').style.background = '#ef4444';
            }
        }

        checkStatus();
        setInterval(checkStatus, 30000);

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, attaching event listeners...');

            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                processBtn.addEventListener('click', async (event) => {
                    console.log('Process button clicked');
                    await processSession(event);
                });
                console.log('Process button listener attached');
            }

            const processSessionSelect = document.getElementById('processSessionId');
            if (processSessionSelect) {
                processSessionSelect.addEventListener('change', updateSessionInfo);
                console.log('Session select listener attached');
            }

            // Load sessions on page load
            loadSessions();

            console.log('All event listeners attached successfully');
        });

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        async function logout() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                return;
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞
                    window.location.href = '/login.html';
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
            }
        }
    </script>
</body>
</html>
