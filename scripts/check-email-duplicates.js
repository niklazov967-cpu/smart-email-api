#!/usr/bin/env node
/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ email Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
 */

require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_KEY = process.env.SUPABASE_ANON_KEY;

if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.error('âŒ Missing SUPABASE_URL or SUPABASE_ANON_KEY in environment');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

async function main() {
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  ğŸ“§ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ email');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ Ñ email
  const { data: companies, error } = await supabase
    .from('pending_companies')
    .select('company_id, company_name, email, website, validation_score, created_at')
    .not('email', 'is', null)
    .neq('email', '');
  
  if (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:', error.message);
    process.exit(1);
  }
  
  console.log(`ğŸ“Š Ğ’ÑĞµĞ³Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹ Ñ email: ${companies.length}\n`);
  
  // 2. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹
  const emailMap = new Map();
  companies.forEach(c => {
    const email = c.email.toLowerCase().trim();
    if (!emailMap.has(email)) {
      emailMap.set(email, []);
    }
    emailMap.get(email).push(c);
  });
  
  // 3. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğµ email ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ°ÑÑ‚ÑÑ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 1 Ñ€Ğ°Ğ·Ğ°
  const duplicates = Array.from(emailMap.entries()).filter(([email, comps]) => comps.length > 1);
  
  console.log(`ğŸ“§ Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… email: ${emailMap.size}`);
  console.log(`ğŸ”„ Email Ñ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ°Ğ¼Ğ¸: ${duplicates.length}`);
  console.log(`ğŸ“Š Ğ’ÑĞµĞ³Ğ¾ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²: ${companies.length - emailMap.size}\n`);
  
  if (duplicates.length > 0) {
    console.log('ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº email Ñ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ°Ğ¼Ğ¸:\n');
    
    duplicates.sort((a, b) => b[1].length - a[1].length); // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ
    
    duplicates.forEach(([email, comps], index) => {
      console.log(`${index + 1}. Email: ${email} (${comps.length} ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹)`);
      comps.forEach((c, i) => {
        console.log(`   ${i + 1}) ${c.company_name}`);
        console.log(`      Score: ${c.validation_score || 'N/A'}, Website: ${c.website ? 'Yes' : 'No'}`);
        console.log(`      Created: ${new Date(c.created_at).toLocaleDateString('ru-RU')}`);
      });
      console.log('');
    });
  }
  
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  ğŸ“Š Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log(`  Ğ’ÑĞµĞ³Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹ Ñ email: ${companies.length}`);
  console.log(`  Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… email: ${emailMap.size}`);
  console.log(`  Email Ñ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ°Ğ¼Ğ¸: ${duplicates.length}`);
  console.log(`  Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹-Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²: ${companies.length - emailMap.size}`);
  console.log(``);
  console.log(`  ĞŸĞ¾ÑĞ»Ğµ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½ĞµÑ‚ÑÑ: ${emailMap.size} ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹`);
  console.log(`  Ğ‘ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾: ${companies.length - emailMap.size} Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
}

main().catch(console.error);

