# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: API –†–∞—Å—Ö–æ–¥—ã –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## –¶–µ–ª—å
–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è API —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏–∑ –≤–µ—Ä—Å–∏–∏ 4.0 –≤ –≤–µ—Ä—Å–∏—é 3.0.

---

## 1. –°–¢–†–£–ö–¢–£–†–ê –ë–î

### 1.1 –¢–∞–±–ª–∏—Ü–∞ `api_credits_log`

```sql
CREATE TABLE IF NOT EXISTS api_credits_log (
    id BIGSERIAL PRIMARY KEY,
    
    -- –í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- –°–µ—Ä–≤–∏—Å –∏ –º–æ–¥–µ–ª—å
    service VARCHAR(50) NOT NULL,           -- 'deepseek', 'tavily', 'perplexity'
    model_name VARCHAR(100) NOT NULL,       -- 'deepseek-chat', 'tavily-basic', 'sonar'
    
    -- –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–∑–æ–≤–∞
    stage VARCHAR(100),                     -- 'stage1', 'stage2', 'stage3', 'query_generation'
    session_id UUID,                        -- ID —Å–µ—Å—Å–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    company_id UUID,                        -- ID –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    
    -- –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è LLM (DeepSeek, Perplexity)
    request_tokens INTEGER DEFAULT 0,       -- –í—Ö–æ–¥—è—â–∏–µ —Ç–æ–∫–µ–Ω—ã
    response_tokens INTEGER DEFAULT 0,      -- –ò—Å—Ö–æ–¥—è—â–∏–µ —Ç–æ–∫–µ–Ω—ã
    total_tokens INTEGER DEFAULT 0,         -- –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤
    
    -- –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö API (Tavily)
    results_count INTEGER DEFAULT 0,        -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    
    -- –°—Ç–æ–∏–º–æ—Å—Ç—å
    cost_usd DECIMAL(12, 8) NOT NULL DEFAULT 0,  -- –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ USD
    
    -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    metadata JSONB DEFAULT '{}'
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_api_credits_log_created_at ON api_credits_log(created_at DESC);
CREATE INDEX idx_api_credits_log_service ON api_credits_log(service);
CREATE INDEX idx_api_credits_log_stage ON api_credits_log(stage);
CREATE INDEX idx_api_credits_log_session_id ON api_credits_log(session_id);
CREATE INDEX idx_api_credits_log_date ON api_credits_log(DATE(created_at));
```

---

## 2. BACKEND API

### 2.1 –§–∞–π–ª: `src/api/credits.js`

#### Endpoints:

| Method | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|-----|----------|
| GET | `/api/credits/summary` | –°–≤–æ–¥–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥ |
| GET | `/api/credits/logs` | –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π |
| GET | `/api/credits/stats/total` | –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| GET | `/api/credits/stats/by-stage` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º |
| GET | `/api/credits/pricing` | –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω API |
| POST | `/api/credits/reset` | –°–±—Ä–æ—Å in-memory —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |

#### 2.1.1 GET `/api/credits/summary`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- `dateFrom` - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (YYYY-MM-DD)
- `dateTo` - –¥–∞—Ç–∞ –∫–æ–Ω—Ü–∞ (YYYY-MM-DD)

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "stats": {
    "deepseek": { "calls": 150, "tokens": 45000, "cost": 0.0234, "formatted": "$0.0234" },
    "tavily": { "calls": 200, "cost": 0.4500, "formatted": "$0.4500" },
    "perplexity": { "calls": 0, "tokens": 0, "cost": 0, "formatted": "$0.0000" },
    "total": { "calls": 350, "cost": 0.4734, "formatted": "$0.47" }
  },
  "source": "memory" // –∏–ª–∏ "database" –µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã
}
```

#### 2.1.2 GET `/api/credits/logs`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `limit` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000)
- `offset` - —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- `stage` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–ø—É (stage1, stage2, stage3...)
- `model` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏ (deepseek-chat, tavily-basic...)
- `service` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–µ—Ä–≤–∏—Å—É (deepseek, tavily, perplexity)
- `dateFrom`, `dateTo` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "logs": [
    {
      "timestamp": "2025-12-03T15:30:45.123Z",
      "service": "deepseek",
      "model_name": "deepseek-chat",
      "stage": "stage3",
      "session_id": "uuid...",
      "request_tokens": 500,
      "response_tokens": 200,
      "total_tokens": 700,
      "results_count": 0,
      "cost_usd": 0.000112
    }
  ],
  "total": 1234,
  "offset": 0,
  "limit": 1000
}
```

#### 2.1.3 GET `/api/credits/pricing`

**–û—Ç–≤–µ—Ç (—Å—Ç–∞—Ç–∏—á–Ω—ã–π):**
```json
{
  "success": true,
  "pricing": {
    "deepseek": {
      "deepseek-chat": { "input": "$0.14/1M", "output": "$0.28/1M" },
      "deepseek-reasoner": { "input": "$0.55/1M", "output": "$2.19/1M" }
    },
    "tavily": {
      "basic": "$0.001/request",
      "advanced": "$0.008/request",
      "extract": "$0.003/request"
    },
    "perplexity": {
      "sonar": { "input": "$1.00/1M", "output": "$1.00/1M" },
      "sonar-pro": { "input": "$3.00/1M", "output": "$15.00/1M" }
    }
  }
}
```

---

## 3. –°–ï–†–í–ò–° CreditsTracker

### 3.1 –§–∞–π–ª: `src/services/CreditsTracker.js`

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:**
```javascript
constructor(database, logger)
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

| –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `logDeepSeekCall(sessionId, stage, inputTokens, outputTokens, model)` | –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ DeepSeek |
| `logTavilyCall(sessionId, stage, method, resultsCount)` | –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ Tavily |
| `logPerplexityCall(sessionId, stage, inputTokens, outputTokens, model)` | –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ Perplexity |
| `getSessionStats(sessionId)` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ—Å—Å–∏–∏ |
| `getGlobalStats()` | –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| `getCallHistory(options)` | –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤ –∏–∑ –ë–î |
| `getStatsFromDb(options)` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –ë–î –∑–∞ –ø–µ—Ä–∏–æ–¥ |
| `getStatsByStage(options)` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º |
| `getSummary()` | –¢–µ–∫—Å—Ç–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ |
| `reset()` | –°–±—Ä–æ—Å in-memory —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |

**–¶–µ–Ω—ã (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è):**
```javascript
this.pricing = {
  'deepseek-chat': { input: 0.14/1000000, output: 0.28/1000000 },
  'deepseek-reasoner': { input: 0.55/1000000, output: 2.19/1000000 },
  'tavily-basic': { perRequest: 0.001 },
  'tavily-advanced': { perRequest: 0.008 },
  'tavily-extract': { perRequest: 0.003 },
  'sonar': { input: 1.0/1000000, output: 1.0/1000000 },
  'sonar-pro': { input: 3.0/1000000, output: 15.0/1000000 }
};
```

---

## 4. FRONTEND (HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞)

### 4.1 –§–∞–π–ª: `public/api-stats.html`

### 4.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìä API –†–∞—Å—Ö–æ–¥—ã –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞                               ‚îÇ
‚îÇ  –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –Ω–∞ API –≤—ã–∑–æ–≤—ã              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å‚îÇ üî¢ –¢–æ–∫–µ–Ω—ã   ‚îÇ üìû –í—ã–∑–æ–≤—ã   ‚îÇ üìä –ü–æ —Å–µ—Ä–≤–∏—Å–∞–º  ‚îÇ
‚îÇ   $0.47     ‚îÇ   45,000    ‚îÇ    350      ‚îÇ DS: $0.02       ‚îÇ
‚îÇ –ó–∞ –≤–µ—Å—å     ‚îÇ DeepSeek +  ‚îÇ  –í—Å–µ–≥–æ      ‚îÇ TV: $0.45       ‚îÇ
‚îÇ –ø–µ—Ä–∏–æ–¥      ‚îÇ Perplexity  ‚îÇ –∑–∞–ø—Ä–æ—Å–æ–≤    ‚îÇ PP: $0.00       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–∞—Å—Ö–æ–¥—ã –ø–æ —ç—Ç–∞–ø–∞–º           ‚îÇ –†–∞—Å—Ö–æ–¥—ã –ø–æ –º–æ–¥–µ–ª—è–º          ‚îÇ
‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà Stage 3 $0.25  ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà DeepSeek Chat $0.02‚îÇ
‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà Stage 2 $0.15        ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà Tavily $0.45   ‚îÇ
‚îÇ ‚ñà‚ñà Stage 1 $0.05            ‚îÇ                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîç –§–∏–ª—å—Ç—Ä—ã                                                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ ‚îÇ –≠—Ç–∞–ø  ‚ñº  ‚îÇ ‚îÇ –ú–æ–¥–µ–ª—å ‚ñº ‚îÇ ‚îÇ –î–∞—Ç–∞ –æ—Ç  ‚îÇ ‚îÇ –î–∞—Ç–∞ –¥–æ  ‚îÇ        ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ [–ü—Ä–∏–º–µ–Ω–∏—Ç—å] [–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å] [–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ] [üì• CSV]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –î–∞—Ç–∞     ‚îÇ –≠—Ç–∞–ø   ‚îÇ –ú–æ–¥–µ–ª—å   ‚îÇ –¢–æ–∫–µ–Ω—ã ‚îÇ –¢–æ–∫–µ–Ω—ã ‚îÇ –°—Ç–æ–∏–º–æ—Å—Ç—å  ‚îÇ
‚îÇ          ‚îÇ        ‚îÇ          ‚îÇ (–≤—Ö–æ–¥) ‚îÇ(–≤—ã—Ö–æ–¥) ‚îÇ            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 03.12.25 ‚îÇStage 3 ‚îÇdeepseek- ‚îÇ  500   ‚îÇ  200   ‚îÇ  $0.0001   ‚îÇ
‚îÇ 15:30    ‚îÇ        ‚îÇchat      ‚îÇ        ‚îÇ        ‚îÇ            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ...      ‚îÇ ...    ‚îÇ ...      ‚îÇ  ...   ‚îÇ  ...   ‚îÇ  ...       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è    –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 10    –°–ª–µ–¥—É—é—â–∞—è ‚Üí           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.3 –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞

**–ì—Ä–∞–¥–∏–µ–Ω—Ç —Ñ–æ–Ω–∞:**
```css
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
```

**–ö–∞—Ä—Ç–æ—á–∫–∏:**
- –ë–µ–ª—ã–π —Ñ–æ–Ω
- –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ 15px
- –¢–µ–Ω—å: `box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);`

**–ë–µ–π–¥–∂–∏ (badges):**
- DeepSeek: `#fce7f3` —Ñ–æ–Ω, `#9f1239` —Ç–µ–∫—Å—Ç
- Tavily: `#d1fae5` —Ñ–æ–Ω, `#065f46` —Ç–µ–∫—Å—Ç  
- Perplexity: `#dbeafe` —Ñ–æ–Ω, `#1e40af` —Ç–µ–∫—Å—Ç
- Stage 1: `#e0e7ff` —Ñ–æ–Ω, `#3730a3` —Ç–µ–∫—Å—Ç
- Stage 2: `#ddd6fe` —Ñ–æ–Ω, `#5b21b6` —Ç–µ–∫—Å—Ç
- Stage 3: `#fce7f3` —Ñ–æ–Ω, `#9f1239` —Ç–µ–∫—Å—Ç
- Stage 4: `#fed7aa` —Ñ–æ–Ω, `#9a3412` —Ç–µ–∫—Å—Ç

### 4.4 JavaScript —Ñ—É–Ω–∫—Ü–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `loadData()` | –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã |
| `updateGlobalSummary()` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ |
| `showLastHour()` | –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø–∏—Å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å |
| `showAllLogs()` | –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ |
| `applyFilters()` | –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã |
| `updateCharts()` | –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ (–ø–æ —ç—Ç–∞–ø–∞–º –∏ –º–æ–¥–µ–ª—è–º) |
| `renderTable()` | –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π |
| `changePage(delta)` | –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã |
| `exportToCSV()` | –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV —Ñ–∞–π–ª |
| `getStageBadge(stage)` | –ü–æ–ª—É—á–∏—Ç—å HTML –±–µ–π–¥–∂–∞ —ç—Ç–∞–ø–∞ |
| `getModelBadge(model)` | –ü–æ–ª—É—á–∏—Ç—å HTML –±–µ–π–¥–∂–∞ –º–æ–¥–µ–ª–∏ |

### 4.5 –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```javascript
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(async () => {
  const response = await fetch('/api/credits/summary');
  const data = await response.json();
  if (data.success) {
    globalStats = data.stats;
    updateGlobalSummary();
  }
}, 30000);
```

---

## 5. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î

### 5.1 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–∞ –≤ `app-simple.js`

```javascript
// –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç
const creditsRouter = require('./api/credits');

// –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ creditsTracker
app.use((req, res, next) => {
  req.creditsTracker = creditsTracker;
  next();
});

// –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç
app.use('/api/credits', creditsRouter);
```

### 5.2 –í—ã–∑–æ–≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–ª–∏–µ–Ω—Ç–∞—Ö API

**DeepSeekClient.js:**
```javascript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ API
if (this.creditsTracker) {
  await this.creditsTracker.logDeepSeekCall(
    sessionId,
    stage,
    inputTokens,
    outputTokens,
    'deepseek-chat'
  );
}
```

**TavilyClient.js:**
```javascript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ API
if (this.creditsTracker) {
  await this.creditsTracker.logTavilyCall(
    sessionId,
    stage,
    'basic', // –∏–ª–∏ 'advanced', 'extract'
    resultsCount
  );
}
```

### 5.3 –ü–µ—Ä–µ–¥–∞—á–∞ creditsTracker –≤ –∫–ª–∏–µ–Ω—Ç—ã

```javascript
// –í app-simple.js –∏–ª–∏ QueryOrchestrator
const creditsTracker = new CreditsTracker(db, logger);
const deepseekClient = new DeepSeekClient(apiKey, logger, creditsTracker);
const tavilyClient = new TavilyClient(apiKey, logger, creditsTracker);
```

---

## 6. –§–ò–õ–¨–¢–†–´ (SELECT OPTIONS)

### 6.1 –§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–ø–∞–º

```html
<select id="stageFilter">
  <option value="">–í—Å–µ —ç—Ç–∞–ø—ã</option>
  <option value="query">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</option>
  <option value="stage1">–≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</option>
  <option value="stage2">–≠—Ç–∞–ø 2: –ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤</option>
  <option value="stage3">–≠—Ç–∞–ø 3: –ü–æ–∏—Å–∫ email</option>
  <option value="stage4">–≠—Ç–∞–ø 4: AI –≤–∞–ª–∏–¥–∞—Ü–∏—è</option>
  <option value="stage5">–≠—Ç–∞–ø 5: –¢–µ–≥–∏</option>
  <option value="stage6">–≠—Ç–∞–ø 6: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è</option>
</select>
```

### 6.2 –§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª—è–º

```html
<select id="modelFilter">
  <option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
  <option value="deepseek-chat">DeepSeek Chat</option>
  <option value="deepseek-reasoner">DeepSeek Reasoner</option>
  <option value="tavily-basic">Tavily Basic</option>
  <option value="tavily-advanced">Tavily Advanced</option>
  <option value="tavily-extract">Tavily Extract</option>
  <option value="sonar">Perplexity Sonar</option>
  <option value="sonar-pro">Perplexity Sonar Pro</option>
</select>
```

---

## 7. –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô

| –ö–Ω–æ–ø–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ | CSS –∫–ª–∞—Å—Å |
|--------|----------|-----------|
| –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã | `applyFilters()` | `btn btn-primary` |
| –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å | `showLastHour()` | `btn btn-secondary` |
| –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ | `showAllLogs()` | `btn btn-secondary` |
| üì• –≠–∫—Å–ø–æ—Ä—Ç CSV | `exportToCSV()` | `btn btn-secondary` |

---

## 8. –≠–ö–°–ü–û–†–¢ –í CSV

```javascript
function exportToCSV() {
  const headers = ['–î–∞—Ç–∞/–í—Ä–µ–º—è', '–≠—Ç–∞–ø', '–ú–æ–¥–µ–ª—å', '–¢–æ–∫–µ–Ω—ã (–ó–∞–ø—Ä–æ—Å)', 
                   '–¢–æ–∫–µ–Ω—ã (–û—Ç–≤–µ—Ç)', '–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤', '–°—Ç–æ–∏–º–æ—Å—Ç—å (USD)'];
  
  const rows = filteredLogs.map(log => [
    new Date(log.timestamp).toLocaleString('ru-RU'),
    log.stage || '',
    log.model_name || '',
    log.request_tokens || 0,
    log.response_tokens || 0,
    log.total_tokens || 0,
    (log.cost_usd || 0).toFixed(4)
  ]);

  const csvContent = [headers, ...rows]
    .map(row => row.map(cell => `"${cell}"`).join(','))
    .join('\n');

  // BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Excel
  const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `api-stats-${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}
```

---

## 9. –ü–ê–ì–ò–ù–ê–¶–ò–Ø

```javascript
const logsPerPage = 50;
let currentPage = 1;

function changePage(delta) {
  const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
  const newPage = currentPage + delta;
  
  if (newPage >= 1 && newPage <= totalPages) {
    currentPage = newPage;
    renderTable();
  }
}
```

---

## 10. CHECKLIST –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é `006-add-api-credits-log.sql`
- [ ] –°–æ–∑–¥–∞—Ç—å `src/services/CreditsTracker.js`
- [ ] –°–æ–∑–¥–∞—Ç—å `src/api/credits.js`
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç –≤ `app-simple.js`
- [ ] –ü–µ—Ä–µ–¥–∞—Ç—å `creditsTracker` –≤ `DeepSeekClient`
- [ ] –ü–µ—Ä–µ–¥–∞—Ç—å `creditsTracker` –≤ `TavilyClient`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–ª–∏–µ–Ω—Ç—ã API
- [ ] –°–æ–∑–¥–∞—Ç—å `public/api-stats.html`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ endpoints
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç CSV

---

## 11. –§–ê–ô–õ–´ –î–õ–Ø –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø

–ò–∑ –≤–µ—Ä—Å–∏–∏ 4.0 –≤ –≤–µ—Ä—Å–∏—é 3.0 –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏:

1. `database/migrations/006-add-api-credits-log.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
2. `src/services/CreditsTracker.js` - —Å–µ—Ä–≤–∏—Å —Ç—Ä–µ–∫–∏–Ω–≥–∞
3. `src/api/credits.js` - API endpoints
4. `public/api-stats.html` - –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## 12. –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

1. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –í—Å–µ –≤—ã–∑–æ–≤—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
2. **In-memory –∫—ç—à**: –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–∫–∂–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
3. **–§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–µ**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç `TIMESTAMPTZ` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
4. **–¢–æ—á–Ω–æ—Å—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç–∏**: `DECIMAL(12, 8)` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Å—É–º–º—ã —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é
5. **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –°–≤–æ–¥–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

