# 🔄 РУКОВОДСТВО ПО АДАПТАЦИИ
## Портирование Smart Email API для поиска услуг/производства в Китае

**Версия:** 2.10.0  
**Целевое использование:** Адаптация системы для поиска компаний, предоставляющих определенные услуги или занимающихся производством в определенной сфере в Китае

---

## 🎯 ЦЕЛЬ ДОКУМЕНТА

Этот документ содержит конкретные рекомендации и примеры для портирования системы Smart Email API на поиск:
- Поставщиков услуг в Китае (юридические, бухгалтерские, консалтинговые и т.д.)
- Производителей в определенной отрасли
- Подрядчиков и исполнителей

---

## 📋 ОБЩИЕ ПРИНЦИПЫ АДАПТАЦИИ

### Что НЕ нужно менять:
✅ Архитектура системы  
✅ База данных (структура таблиц)  
✅ API endpoints  
✅ Frontend структура  
✅ Сервисы (DeepSeekClient, SonarApiClient и т.д.)

### Что НУЖНО менять:
🔧 Промпты для AI (Stage 0, 1, 2, 3, 4)  
🔧 Фильтры (маркетплейсы → агрегаторы услуг)  
🔧 UI тексты (названия этапов, подсказки)  
🔧 Примеры данных в интерфейсе  
🔧 Validation логика (опционально)

---

## 🔍 СЦЕНАРИЙ 1: Поиск поставщиков услуг в Китае

### Примеры ниш:
- Юридические услуги (корпоративное право, IP, M&A)
- Бухгалтерские услуги (аудит, налоги, бухучет)
- HR услуги (рекрутинг, HR-консалтинг)
- IT услуги (разработка, интеграция)
- Маркетинговые услуги (digital, PR, брендинг)
- Логистические услуги (таможня, перевозки)

---

### 📝 STEP 1: Адаптация Stage 0 (Query Expansion)

**Файл:** `src/services/QueryExpander.js`

**Метод:** `_createExpansionPrompt()`

**Было (для производителей):**
```javascript
const prompt = `
你是一个专业的搜索查询生成专家。请根据以下主题生成${targetCount}个相关的搜索查询：

主题：${mainTopic}

要求：
1. 每个查询用中文（简体）
2. 提供俄语翻译
3. 评估相关性(0-100)
4. 多样化角度：同义词、细分类别、应用场景

...
`;
```

**Стало (для услуг):**
```javascript
const prompt = `
你是一个专业的服务查询生成专家。请根据以下服务类型生成${targetCount}个相关的搜索查询。

服务类型：${mainTopic}

要求：
1. 每个查询用中文（简体）
2. 提供俄语翻译
3. 评估相关性(0-100分)
4. 多样化角度：
   - 服务类型（例如：税务咨询、审计服务、代理记账）
   - 行业专注（例如：外资企业、中小企业、跨境电商）
   - 地域（例如：上海、深圳、北京）
   - 客户群体（例如：初创公司、跨国公司、个体户）

负面示例（不要生成）：
- B2B服务平台（猪八戒、威客网等）
- 过于宽泛的查询
- 与主题无关的查询

返回JSON格式：
[
  {
    "query_cn": "上海外资企业税务咨询服务",
    "query_ru": "Налоговый консалтинг для иностранных компаний в Шанхае",
    "relevance": 95
  },
  ...
]

只返回JSON，不要其他文字。
`;
```

**Ключевые изменения:**
- "服务类型" вместо "主题"
- Акцент на **типы услуг**, а не продукты
- Добавлены **специфичные аспекты** (地域, 客户群体, 行业专注)
- Негативные примеры для лучшей фильтрации

---

### 📝 STEP 2: Адаптация Stage 1 (Find Companies)

**Файл:** `src/stages/Stage1FindCompanies.js`

**Метод:** `_createPrompt()`

**Было (для производителей):**
```javascript
const prompt = `
你是一个专门搜索中国企业的专家。请找到至少${minCompanies}家（最多${maxCompanies}家）提供以下服务/产品的公司：

查询：${searchQuery}

严格要求：
1. 只找中国大陆的企业
2. 必须有明确的公司名称
3. 尽量找到公司官方网站
4. 排除B2B平台（阿里巴巴、慧聪网等）
5. 优先选择有自己生产设施的制造商

...
`;
```

**Стало (для услуг):**
```javascript
const prompt = `
你是一个专门搜索中国服务提供商的专家。请找到至少${minCompanies}家（最多${maxCompanies}家）提供以下服务的公司：

查询：${searchQuery}

严格要求：
1. 只找中国大陆的服务提供商
2. 必须有明确的公司名称（中文全称）
3. 必须找到公司官方网站
4. 排除以下类型：
   - B2B服务平台（猪八戒、威客网、任务中国等）
   - 服务聚合平台
   - 招聘网站
   - 纯信息网站（没有实际服务提供）
5. 优先选择：
   - 有专业资质的公司
   - 有实体办公室的公司
   - 有客户案例的公司
   - 成立时间较长的公司

返回格式（纯JSON数组）：
[
  {
    "name": "公司全称",
    "website": "https://example.com",
    "description": "简要描述公司提供的服务（1-2句话）"
  }
]

只返回JSON，不要其他文字。
`;
```

**Ключевые изменения:**
- "服务提供商" вместо "企业"
- **Новые фильтры:** B2B服务平台, 聚合平台, 招聘网站
- Приоритет: 专业资质 (профессиональные лицензии), 客户案例 (кейсы)
- Акцент на **качество услуг**, а не производственные мощности

---

### 📝 STEP 3: Обновить фильтры маркетплейсов

**Файл:** `src/stages/Stage1FindCompanies.js`

**Метод:** `_isMarketplace()`

**Было (для производителей):**
```javascript
_isMarketplace(website, companyName) {
  if (!website) return false;
  
  const marketplaces = [
    'alibaba.com', '1688.com', 'made-in-china.com',
    'globalsources.com', 'hc360.com', 'china.cn',
    'chinasuppliers.com', 'taobao.com', 'tmall.com'
  ];
  
  // ...
}
```

**Стало (для услуг):**
```javascript
_isMarketplace(website, companyName) {
  if (!website) return false;
  
  const serviceAggregators = [
    // B2B сервисы
    'zbj.com', // 猪八戒网
    'taskcn.com', // 任务中国
    'vikecn.com', // 威客网
    'witmart.com', // 威客
    
    // Рекрутинг
    'zhaopin.com', // 智联招聘
    '51job.com', // 前程无忧
    'liepin.com', // 猎聘
    'boss.com', // Boss直聘
    
    // Общие агрегаторы
    'tianyancha.com', // Тяньяньча (информация о компаниях)
    'qichacha.com', // Цичача
    'qcc.com',
    
    // Справочники
    'yellowpage.com',
    '360doc.com',
    'cn114.com'
  ];
  
  const domain = website.toLowerCase();
  return serviceAggregators.some(m => domain.includes(m));
}
```

**Дополнительная проверка по названию:**
```javascript
const blacklistedKeywords = [
  '平台', '网站', '门户', '招聘', '猎聘', 
  '威客', '任务', '外包平台'
];

const hasBlacklistedKeyword = blacklistedKeywords.some(kw => 
  companyName.includes(kw)
);

if (hasBlacklistedKeyword) return true;
```

---

### 📝 STEP 4: Адаптация Stage 2-3 (Find Website/Email)

**Stage 2** и **Stage 3** практически **НЕ требуют изменений**, т.к. поиск сайта и email универсален для любых компаний.

Единственное - можно добавить приоритет email'ов для услуг:

**Файл:** `src/stages/Stage3AnalyzeContacts.js`

```javascript
_prioritizeEmail(email) {
  // Для услуг приоритет:
  // 1. service@ / services@
  // 2. info@
  // 3. contact@
  // 4. sales@
  
  if (email.startsWith('service')) return 1;
  if (email.startsWith('info')) return 2;
  if (email.startsWith('contact')) return 3;
  if (email.startsWith('sales')) return 4;
  return 5;
}
```

---

### 📝 STEP 5: Адаптация Stage 4 (AI Validation)

**Файл:** `src/stages/Stage4AnalyzeServices.js`

**Метод:** промпт для DeepSeek

**Было (для производителей):**
```javascript
const prompt = `
Проанализируй китайскую компанию и оцени её релевантность для темы поиска.

Данные компании:
- Название: ${companyName}
- Сайт: ${website}
- Email: ${email}

Основная тема поиска: ${topicDescription}

Задачи:
1. Определи основную деятельность компании
2. Перечисли основные продукты/услуги
3. Оцени релевантность теме (0-100)
4. Является ли компания производителем?

...
`;
```

**Стало (для услуг):**
```javascript
const prompt = `
Проанализируй китайскую компанию, предоставляющую услуги, и оцени её релевантность для темы поиска.

Данные компании:
- Название: ${companyName}
- Сайт: ${website || 'нет данных'}
- Email: ${email || 'нет данных'}
- Описание: ${description || 'нет данных'}

Тип услуг, который мы ищем: ${topicDescription}

Задачи:
1. Определи **основной вид услуг**, который предоставляет компания
2. Перечисли **конкретные услуги** (до 10 пунктов)
3. Определи **специализацию** (какие отрасли/клиенты)
4. Оцени **релевантность** компании заданному типу услуг (0-100)
5. Определи, **подходит ли** компания (true/false)
6. Объясни **причину** оценки

Критерии релевантности:
- 90-100: Полностью соответствует (прямая специализация)
- 70-89: Хорошее соответствие (предоставляет такие услуги среди прочих)
- 50-69: Частичное соответствие (похожие/смежные услуги)
- 0-49: Низкая релевантность (не те услуги или агрегатор)

Верни ТОЛЬКО валидный JSON:
{
  "main_activity": "Основной вид услуг компании",
  "services": ["Услуга 1", "Услуга 2", "..."],
  "specialization": "Специализация по отраслям/клиентам",
  "validation_score": 85,
  "is_relevant": true,
  "validation_reason": "Подробная причина оценки"
}
`;
```

**Ключевые изменения:**
- Акцент на **услуги**, а не продукты
- Новое поле: **specialization** (специализация)
- Обновленные критерии релевантности для услуг
- Более строгая фильтрация агрегаторов

---

### 📝 STEP 6: Обновить UI тексты

**Файл:** `public/index.html`

**Было:**
```html
<h2>🔍 Шаг 0: Генерация поисковых запросов</h2>
<label>Введите основную тему для генерации под-запросов:</label>
<textarea placeholder="Например: Производители деталей для обработки металла в Китае"></textarea>
```

**Стало:**
```html
<h2>🔍 Шаг 0: Генерация поисковых запросов</h2>
<label>Введите тип услуг для генерации под-запросов:</label>
<textarea placeholder="Например: Налоговый консалтинг для иностранных компаний в Китае"></textarea>
```

**Аналогично для Stage 1-4:**
- "Поиск компаний" → "Поиск поставщиков услуг"
- "Найдено компаний" → "Найдено поставщиков"
- "Производители" → "Компании"

**Файл:** `public/results.html`

Колонки:
- Название компании → без изменений
- Сайт → без изменений
- Email → без изменений
- Основная деятельность → "Основные услуги"

---

## 🏭 СЦЕНАРИЙ 2: Поиск производителей в определенной отрасли

### Примеры отраслей:
- Электроника (смартфоны, компоненты)
- Текстиль (одежда, ткани)
- Мебель (офисная, домашняя)
- Упаковка (картон, пластик, бумага)
- Косметика (OEM/ODM)

---

### 📝 Адаптация для производителей

**Stage 0 промпт:**
```javascript
const prompt = `
你是一个专业的制造业搜索专家。请根据以下产品类别生成${targetCount}个相关的搜索查询。

产品类别：${mainTopic}

要求：
1. 每个查询用中文（简体）
2. 提供俄语翻译
3. 评估相关性(0-100)
4. 多样化角度：
   - 产品类型（例如：智能手机、平板电脑、配件）
   - 制造方式（例如：OEM、ODM、自有品牌）
   - 材料（例如：铝合金、塑料、不锈钢）
   - 应用场景（例如：工业用、民用、医疗用）
   - 规格（例如：大批量、小批量、定制）

负面示例（不要生成）：
- B2B平台（阿里巴巴、中国制造网等）
- 过于宽泛的查询
- 贸易公司（不是制造商）

返回JSON格式：
[
  {
    "query_cn": "深圳智能手机OEM制造商",
    "query_ru": "OEM производители смартфонов в Шэньчжэне",
    "relevance": 95
  }
]
`;
```

**Stage 1 промпт:**
```javascript
const prompt = `
你是一个专门搜索中国制造商的专家。请找到至少${minCompanies}家（最多${maxCompanies}家）生产以下产品的工厂：

产品查询：${searchQuery}

严格要求：
1. 只找中国大陆的制造商（不要贸易公司）
2. 必须有自己的生产设施/工厂
3. 必须有明确的公司名称
4. 尽量找到工厂官网
5. 排除：
   - B2B平台（阿里巴巴、中国制造网等）
   - 纯贸易公司（没有工厂）
   - 批发商和分销商
6. 优先选择：
   - 有ISO认证的工厂
   - 有出口资质的工厂
   - 有自主研发能力的厂商

返回格式（纯JSON数组）：
[
  {
    "name": "工厂全称",
    "website": "https://example.com",
    "description": "生产的主要产品和规模"
  }
]
`;
```

**Validation (Stage 4):**
```javascript
Критерии для производителей:
- Есть ли собственный завод?
- Производственные мощности?
- Сертификаты (ISO, CE, FDA)?
- Экспортный опыт?
- R&D capability?
```

---

## 🌍 СЦЕНАРИЙ 3: Региональная специфика

### Поиск в определенном городе/провинции

**Stage 0 промпт - добавить географию:**
```javascript
const prompt = `
...
主题：${mainTopic}
地域限制：${region || '中国大陆'}  // NEW!

要求：
...
5. 包含地域信息（例如：深圳、上海、广东）
...
`;
```

**Stage 1 промпт:**
```javascript
const prompt = `
...
查询：${searchQuery}
地域：${region || '中国大陆'}  // NEW!

严格要求：
1. 只找${region}地区的企业  // NEW!
...
`;
```

**Frontend - добавить input для региона:**
```html
<div class="input-group">
  <label>Регион (опционально):</label>
  <input id="regionInput" placeholder="Например: 深圳, 上海, 广东省">
</div>
```

---

## 📊 ТАБЛИЦА СРАВНЕНИЯ: Что менять для разных ниш

| Компонент | Производители | Услуги | Торговля |
|-----------|---------------|--------|----------|
| **Stage 0 промпт** | 产品类别 | 服务类型 | 商品类别 |
| **Stage 1 промпт** | 制造商, 工厂 | 服务提供商 | 供应商, 批发商 |
| **Фильтры** | B2B платформы | Агрегаторы услуг | Розница |
| **Validation критерии** | Завод, ISO | Лицензии, кейсы | Ассортимент |
| **UI тексты** | Производители | Поставщики услуг | Поставщики товаров |

---

## ✅ ЧЕКЛИСТ АДАПТАЦИИ

### Before Starting:
- [ ] Определить целевую нишу (услуги/производство/торговля)
- [ ] Составить список типичных запросов (5-10 примеров)
- [ ] Определить ключевые фильтры (какие платформы исключить)

### Stage 0:
- [ ] Обновить промпт Query Expansion
- [ ] Добавить специфичные аспекты (地域, 行业, 客户群体)
- [ ] Протестировать генерацию на 2-3 темах

### Stage 1:
- [ ] Обновить промпт поиска компаний
- [ ] Обновить фильтры маркетплейсов/агрегаторов
- [ ] Добавить приоритеты (что важнее)
- [ ] Протестировать на 1 теме (10 запросов)

### Stage 2-3:
- [ ] (Опционально) Обновить приоритет email'ов
- [ ] Проверить, что поиск работает

### Stage 4:
- [ ] Обновить промпт валидации
- [ ] Обновить критерии релевантности
- [ ] Добавить специфичные поля (если нужно)
- [ ] Протестировать на 5-10 компаниях

### UI:
- [ ] Обновить тексты в index.html
- [ ] Обновить тексты в results.html
- [ ] Обновить placeholder'ы
- [ ] Обновить examples

### Testing:
- [ ] Сгенерировать 1 тему (10 запросов)
- [ ] Запустить Stage 1 → проверить качество
- [ ] Запустить Stage 2-4
- [ ] Проверить результаты в results.html
- [ ] Оценить % релевантных компаний
- [ ] При необходимости - скорректировать промпты

---

## 💡 ТИПИЧНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### Проблема 1: Много нерелевантных компаний

**Причина:** Промпты слишком общие

**Решение:**
1. Добавить больше **негативных примеров** в промпт
2. Ужесточить фильтры (больше blacklist)
3. Увеличить threshold в Stage 4: `validation_score >= 70` → `>= 80`

---

### Проблема 2: Много агрегаторов/платформ в результатах

**Причина:** Недостаточная фильтрация

**Решение:**
1. Расширить список в `_isMarketplace()`
2. Добавить проверку keywords в названии компании
3. Добавить проверку в Stage 4:
```javascript
if (companyName.includes('平台') || companyName.includes('网站')) {
  validation_score = 0;
  is_relevant = false;
}
```

---

### Проблема 3: Не находит нужные компании

**Причина:** Запросы слишком узкие

**Решение:**
1. Увеличить `numQueries` с 10 до 20-30
2. Добавить синонимы в Stage 0 промпт
3. Увеличить temperature в QueryExpander: `0.3` → `0.5`

---

## 📚 ПРИМЕРЫ АДАПТИРОВАННЫХ ПРОМПТОВ

### Пример 1: Юридические услуги в Шанхае

**Stage 0:**
```
主题：上海外资企业法律服务

要求：
- 服务类型：公司法、知识产权、劳动法、税务筹划
- 客户群体：外资企业、合资企业、跨国公司
- 地域：上海及周边地区
```

**Stage 1:**
```
查询：上海外资企业公司法律师事务所

严格要求：
- 只找上海的律师事务所
- 必须有涉外法律服务资质
- 排除法律咨询平台（如找法网、华律网）
```

---

### Пример 2: OEM производители косметики в Гуанчжоу

**Stage 0:**
```
主题：广州化妆品OEM/ODM工厂

要求：
- 产品类型：护肤品、彩妆、洗护用品
- 制造方式：OEM、ODM、代工
- 规格：小批量起订、定制配方
```

**Stage 1:**
```
查询：广州护肤品OEM代工厂

严格要求：
- 只找广州及周边的化妆品工厂
- 必须有化妆品生产许可证
- 必须有自己的生产线
- 排除：纯贸易公司、批发商
```

---

## 🎯 ИТОГОВЫЕ РЕКОМЕНДАЦИИ

### Для поиска услуг:
1. ✅ Акцент на **тип услуг**, а не продукты
2. ✅ Фильтровать **агрегаторы** (猪八戒, 威客网)
3. ✅ Приоритет: **专业资质**, **客户案例**
4. ✅ Validation: оценка **качества услуг**

### Для поиска производителей:
1. ✅ Акцент на **производственные мощности**
2. ✅ Фильтровать **贸易公司** (торговые компании)
3. ✅ Приоритет: **工厂**, **ISO认证**
4. ✅ Validation: наличие **завода**, **экспорт**

### Для региональной специфики:
1. ✅ Добавить поле **地域** в промпты
2. ✅ Frontend input для региона
3. ✅ Проверка в Stage 1: "只找X地区"

---

## 📞 ПОДДЕРЖКА

Для вопросов по адаптации см.:
- **PROJECT-SUMMARY-FOR-PORTING.md** - полное описание системы
- **BUILD-FROM-SCRATCH-GUIDE.md** - пошаговая инструкция

**Время адаптации:** 2-4 часа для опытного разработчика

---

**Дата:** 30 ноября 2025  
**Версия:** 2.10.0  
**Статус:** Production-ready для адаптации
