# Анализ дубликатов по названию компании

**Дата:** 2025-11-30  
**Версия:** v2.4.7  
**Вопрос:** Нужно ли делать `company_name` уникальным полем?

---

## 📊 Результаты анализа

### Общая статистика:
- **Всего компаний:** 461
- **Дубликатов по названию:** 73 (15.8%)
- **Всего записей-дубликатов:** 246

### Топ-10 дубликатов:

| Название | Записей | Email | Сайты |
|----------|---------|-------|-------|
| 东莞正盛 | 11 | 1 (одинаковый) | **4 (РАЗНЫЕ!)** |
| 尼斯快速 | 11 | нет | нет |
| 骏盈精密制造有限公司 | 10 | **5 (РАЗНЫЕ!)** | **4 (РАЗНЫЕ!)** |
| ゲンサン精密機械加工株式会社 | 9 | нет | нет |
| 东莞正盛精密制造有限公司 | 8 | **3 (РАЗНЫЕ!)** | **2 (РАЗНЫЕ!)** |
| 星速 | 7 | **2 (РАЗНЫЕ!)** | **2 (РАЗНЫЕ!)** |
| 俊英制造 | 6 | **3 (РАЗНЫЕ!)** | 1 (одинаковый) |
| 尼斯快速制造有限公司 | 6 | нет | 1 (одинаковый) |
| 星速精密制造有限公司 | 6 | 1 (одинаковый) | 1 (одинаковый) |
| 刀柄精密加工有限公司 | 5 | **2 (РАЗНЫЕ!)** | **2 (РАЗНЫЕ!)** |

### Корреляция с email (топ-10):
- 🔄 **С РАЗНЫМИ email:** 5 компаний (50.0%)
- ✅ **С одинаковым email:** 2 компании (20.0%)
- ❓ **Без email:** 3 компании (30.0%)

### Корреляция с сайтами (топ-10):
- 🔄 **С РАЗНЫМИ сайтами:** 5 компаний (50.0%)
- ✅ **С одинаковым сайтом:** 3 компании (30.0%)
- ❓ **Без сайта:** 2 компании (20.0%)

---

## 💡 ВЫВОДЫ

### ❌ НЕ делать `company_name` уникальным полем!

**Причины:**

1. **Одно название = РАЗНЫЕ компании** (50% случаев)
   ```
   骏盈精密制造有限公司 (10 записей):
   - 5 РАЗНЫХ email
   - 4 РАЗНЫХ сайта
   → Это 10 разных компаний с похожими названиями!
   ```

2. **Общие/типовые названия в Китае**
   - "东莞正盛" - распространенное название
   - Разные юр.лица используют одно название
   - Разные регионы, разные владельцы

3. **Разные контакты для одного названия**
   ```
   俊英制造 (6 записей):
   - junying@junyingmanufacturing.com
   - sales@junyingmfg.com
   - info@junyingmanufacturing.com
   → 3 разных email для "одного" названия
   ```

### ✅ Правильная стратегия дедупликации:

#### 1. **`normalized_domain`** - ОСНОВНОЙ ключ ✅
- Уникальность по домену = уникальность компании
- Уже реализовано с UNIQUE constraint
- Работает идеально!

#### 2. **`email`** - Дедупликация на уровне отображения ✅
- Реализована в `results.html` (v2.4.7)
- Не на уровне БД, а на уровне UI
- Правильный подход!

#### 3. **`company_name`** - НЕ делать уникальным ❌
- Одно название может быть у разных компаний
- UNIQUE constraint будет блокировать легитимные записи

---

## 📋 Примеры из реальных данных

### Пример 1: Одно название, разные компании
```
骏盈精密制造有限公司 (10 компаний):
├─ sales@junying-precision.com → junying-precision.com
├─ sales@junyingjingshi.com → junyingjingshi.com
├─ enquiry@jpmcnc.com → jpmcnc.com
├─ info@junyingprecision.com → (no domain)
└─ sales@junyingjmy.com → junyingjmy.com

ВЫВОД: 5 РАЗНЫХ компаний с одним названием!
```

### Пример 2: Одно название, один email, разные сайты
```
东莞正盛 (11 записей):
├─ yao@dgzes.com → dgzes.com
├─ yao@dgzes.com → dgzhengchen.com
├─ yao@dgzes.com → zhengsheng0769.com
└─ yao@dgzes.com → dg-zs.com

ВЫВОД: Один холдинг с разными брендами/сайтами
```

### Пример 3: Одно название, без контактов
```
尼斯快速 (11 записей):
└─ Все без email и сайта

ВЫВОД: AI не смог найти контакты
```

---

## 🎯 Рекомендации

### ✅ Текущая архитектура правильная:

1. **`pending_companies.normalized_domain`** - UNIQUE ✅
   - Гарантирует уникальность по домену
   - Предотвращает технические дубликаты

2. **Дедупликация по email на уровне UI** ✅
   - Реализована в `results.html`
   - Гибкая, не блокирует запись в БД
   - Пользователь видит только релевантные записи

3. **`company_name`** - БЕЗ UNIQUE ✅
   - Разные компании могут иметь одно название
   - Легитимные дубликаты

### ❌ НЕ делать:

- ❌ UNIQUE constraint на `company_name`
- ❌ Дедупликация по названию в БД
- ❌ Автоматическое удаление записей с одинаковым названием

### 💡 Что можно улучшить (опционально):

1. **Composite UNIQUE constraint:**
   ```sql
   UNIQUE (company_name, normalized_domain)
   ```
   - Одно название + один домен = одна запись
   - Но может блокировать обновления

2. **Мягкая дедупликация:**
   - Помечать возможные дубликаты флагом
   - Давать пользователю выбор
   - Не удалять автоматически

---

## 📈 Статистика по категориям

### Категория A: Легитимные дубликаты (разные компании)
- **50%** дубликатов по названию имеют РАЗНЫЕ email
- **50%** дубликатов по названию имеют РАЗНЫЕ сайты
- **Вывод:** Это РАЗНЫЕ компании, не дубликаты!

### Категория B: Технические дубликаты (один холдинг)
- **20%** дубликатов имеют ОДИНАКОВЫЙ email
- **30%** дубликатов имеют ОДИНАКОВЫЙ сайт
- **Вывод:** Один холдинг с разными брендами
- **Решение:** Дедупликация по `normalized_domain` (уже есть!)

### Категория C: Без контактов (AI не нашел)
- **30%** дубликатов БЕЗ email
- **20%** дубликатов БЕЗ сайта
- **Вывод:** Будут отфильтрованы позже на Stage 3/4

---

## ✅ Итоговое решение

**НЕ делать `company_name` уникальным!**

**Причина:**
- Одно название часто = РАЗНЫЕ компании
- Текущая дедупликация по `normalized_domain` работает отлично
- Дедупликация по `email` реализована на уровне UI

**Текущая система дедупликации оптимальна и не требует изменений!**

---

**Дата анализа:** 2025-11-30  
**Анализировано записей:** 461  
**Найдено дубликатов:** 73 (15.8%)  
**Статус:** ✅ Архитектура подтверждена как правильная

