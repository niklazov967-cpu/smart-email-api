# üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –î–£–ë–õ–ò–ö–ê–¢–û–í –í `pending_companies`

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-11-30  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** v2.20.2  
**–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π:** 710  
**–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω:** Real-time (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö + –ª–æ–≥–∏ Railway)

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•

### **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
```
–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 710
–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π: 694
–ì—Ä—É–ø–ø —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏: 11 (1.6%)
–í—Å–µ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: 16 –∑–∞–ø–∏—Å–µ–π
```

### **–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–∏–∑ —Ç–æ–ø-10):**
```
üîÑ –ö–∞—Ç–µ–≥–æ—Ä–∏—è A (—Ä–∞–∑–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏): 30%
   ‚Üí –û–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã/—Å–∞–π—Ç—ã
   ‚Üí –õ–µ–≥–∏—Ç–∏–º–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã, –ù–ï —É–¥–∞–ª—è—Ç—å!

‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è B (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥—É–±–ª–∏–∫–∞—Ç—ã): 70%
   ‚Üí –û–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
   ‚Üí –ù—É–∂–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

‚ùì –ö–∞—Ç–µ–≥–æ—Ä–∏—è C (–±–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤): 0%
   ‚Üí AI –Ω–µ –Ω–∞—à–µ–ª –∫–æ–Ω—Ç–∞–∫—Ç—ã
```

---

## üîç –ü–†–ò–ß–ò–ù–´ –î–£–ë–õ–ò–ö–ê–¢–û–í

### **1. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –í–ù–£–¢–†–ò Stage 1 —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!**

**–ö–æ–¥ (Stage1FindCompanies.js, —Å—Ç—Ä–æ–∫–∏ 510-547):**
```javascript
_removeDuplicates(companies) {
  const seenNames = new Set();
  const seenDomains = new Set();
  
  return companies.filter(company => {
    const nameKey = company.name.toLowerCase().trim();
    if (seenNames.has(nameKey)) {
      return false; // –î—É–±–ª–∏–∫–∞—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    }
    
    if (company.website) {
      const domain = this._extractMainDomain(company.website);
      if (domain && seenDomains.has(domain)) {
        return false; // –î—É–±–ª–∏–∫–∞—Ç –ø–æ –¥–æ–º–µ–Ω—É
      }
      if (domain) seenDomains.add(domain);
    }
    
    seenNames.add(nameKey);
    return true;
  });
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –ª–æ–≥–æ–≤:**
```
Stage 1: After deduplication
  before: 266 –∫–æ–º–ø–∞–Ω–∏–π
  after: 86 –∫–æ–º–ø–∞–Ω–∏–π
  removed: 180 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
  duplicateRate: 67.7%
```

‚úÖ **–í—ã–≤–æ–¥:** –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Stage 1 —Ä–∞–±–æ—Ç–∞–µ—Ç –û–¢–õ–ò–ß–ù–û!

---

### **2. –î—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –ú–ï–ñ–î–£ –∑–∞–ø—É—Å–∫–∞–º–∏ Stage 1**

**–°—Ü–µ–Ω–∞—Ä–∏–π:**

```
–ó–∞–ø—É—Å–∫ 1 (–¢–µ–º–∞: "–ú–µ—Ç–∞–ª–ª–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –®—ç–Ω—å—á–∂—ç–Ω—å"):
  ‚Üí AI –Ω–∞—Ö–æ–¥–∏—Ç: Èü¶ËÇØ (Wayken), ÊòüÈÄü (Star Rapid), ‰øäËã± (Junying)
  ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î

–ó–∞–ø—É—Å–∫ 2 (–¢–µ–º–∞: "CNC –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞–ª—ã—Ö –ø–∞—Ä—Ç–∏–π"):
  ‚Üí AI —Å–Ω–æ–≤–∞ –Ω–∞—Ö–æ–¥–∏—Ç: Èü¶ËÇØ (Wayken), ÊòüÈÄü (Star Rapid)
  ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î... –ù–û:
     - –£ Wayken –Ω–µ—Ç website (website=NULL)
     - normalized_domain = NULL
     - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ company_name = OR –ª–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 1006)
  ‚Üí –í—Å—Ç–∞–≤–ª—è–µ—Ç –°–ù–û–í–ê!
```

---

### **3. –ü—Ä–æ–±–ª–µ–º–∞: normalized_domain –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–ª—è 70% –∑–∞–ø–∏—Å–µ–π**

**–ê–Ω–∞–ª–∏–∑ –ë–î:**
```
–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 710
–ó–∞–ø–∏—Å–µ–π —Å normalized_domain: 298 (42%)
–ó–∞–ø–∏—Å–µ–π –ë–ï–ó normalized_domain: 412 (58%)
```

**–ü—Ä–∏—á–∏–Ω—ã:**
1. AI –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏—Ç website –≤ Stage 1
2. Website –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–∑–∂–µ (Stage 2/3)
3. `normalized_domain` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å `website`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
```
UNIQUE INDEX idx_pending_companies_unique_domain 
ON pending_companies(normalized_domain) 
WHERE normalized_domain IS NOT NULL;

‚Üì
–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è 42% –∑–∞–ø–∏—Å–µ–π!
58% –∑–∞–ø–∏—Å–µ–π –ù–ï –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤!
```

---

### **4. –ü—Ä–æ–±–ª–µ–º–∞: OR –ª–æ–≥–∏–∫–∞ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (Stage1FindCompanies.js, —Å—Ç—Ä–æ–∫–∏ 1000-1023):**
```javascript
const { data: existing } = await this.db.supabase
  .from('pending_companies')
  .select('company_id, company_name, website, email, normalized_domain')
  .or(
    normalizedDomain 
      ? `normalized_domain.eq.${normalizedDomain},company_name.eq.${company.name}`
      : `company_name.eq.${company.name}`
  )
  .limit(1);
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- OR = "–õ–ò–ë–û –¥–æ–º–µ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –õ–ò–ë–û –Ω–∞–∑–≤–∞–Ω–∏–µ"
- –ï—Å–ª–∏ –¥–æ–º–µ–Ω –µ—Å—Ç—å ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–º–µ–Ω –ò–õ–ò –Ω–∞–∑–≤–∞–Ω–∏–µ
- –ï—Å–ª–∏ –¥–æ–º–µ–Ω–∞ –Ω–µ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ

**–ù–û:**
```
–ö–æ–º–ø–∞–Ω–∏—è "Èü¶ËÇØ (Wayken)" —É–∂–µ –≤ –ë–î:
  - website: NULL
  - normalized_domain: NULL
  
–ù–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è "Èü¶ËÇØ (Wayken)":
  - website: NULL
  - normalized_domain: NULL
  
–ü—Ä–æ–≤–µ—Ä–∫–∞:
  .or(`company_name.eq.Èü¶ËÇØ`)
  ‚Üí –î–æ–ª–∂–Ω–∞ –Ω–∞–π—Ç–∏!
  
–í–û–ü–†–û–°: –ü–æ—á–µ–º—É –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç? ü§î
```

---

## üî¨ –ì–õ–£–ë–û–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 1: –†–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è**

**–ü—Ä–∏–º–µ—Ä—ã –∏–∑ –ë–î:**
```
1. Èü¶ËÇØ (Wayken) - 4 –∑–∞–ø–∏—Å–∏
2. Èü¶ËÇØ(Wayken) - 2 –∑–∞–ø–∏—Å–∏ (–ë–ï–ó –ü–†–û–ë–ï–õ–ê!)
   ‚Üë
   –†–∞–∑–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏! toLowerCase().trim() –Ω–µ –ø–æ–º–æ–∂–µ—Ç!
```

**–í—ã–≤–æ–¥:** ‚úÖ **–≠—Ç–æ –û–°–ù–û–í–ù–ê–Ø –ø—Ä–∏—á–∏–Ω–∞!**

---

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**

**–ö–æ–¥ Stage 1 (—Å—Ç—Ä–æ–∫–∏ 104-121):**
```javascript
const BATCH_SIZE = 5; // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 5 –∑–∞–ø—Ä–æ—Å–æ–≤

for (let i = 0; i < queries.length; i += BATCH_SIZE) {
  const batch = queries.slice(i, i + BATCH_SIZE);
  const batchResults = await Promise.all(
    batch.map(query => this._processQuery(...))
  );
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π (Race Condition):**
```
Query 1: –ù–∞—Ö–æ–¥–∏—Ç "Èü¶ËÇØ" ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î ‚Üí –ù–ï–¢ ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç –≤—Å—Ç–∞–≤–∫—É
Query 2: –ù–∞—Ö–æ–¥–∏—Ç "Èü¶ËÇØ" ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!) ‚Üí –ù–ï–¢ ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç –≤—Å—Ç–∞–≤–∫—É
         ‚Üë
         –û–±–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ –î–û —Ç–æ–≥–æ –∫–∞–∫ –ø–µ—Ä–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å!
```

**–ù–æ:** `_removeDuplicates()` –¥–æ–ª–∂–µ–Ω –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –í–ù–£–¢–†–ò batch!

**–í—ã–≤–æ–¥:** ‚ö†Ô∏è **–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π, –Ω–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ**

---

## üéØ –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ò–• –ó–ê–©–ò–¢

### **1. UNIQUE constraint –Ω–∞ `normalized_domain`**
```sql
CREATE UNIQUE INDEX idx_pending_companies_unique_domain 
ON pending_companies(normalized_domain) 
WHERE normalized_domain IS NOT NULL;
```

**–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è 42% –∑–∞–ø–∏—Å–µ–π (—Å website)
- ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è 58% –∑–∞–ø–∏—Å–µ–π (–±–µ–∑ website)
- ‚úÖ 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ domain –≤ –ë–î!

**–í—ã–≤–æ–¥:** ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ, –ù–û –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

---

### **2. `_removeDuplicates()` –≤ Stage 1**
```javascript
seenNames.has(nameKey) // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
seenDomains.has(domain) // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –¥–æ–º–µ–Ω—É
```

**–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- ‚úÖ –£–¥–∞–ª—è–µ—Ç 67.7% –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–∞–ø–∏—Å–∞–Ω–∏–π (toLowerCase + trim)
- ‚ùå –ù–ï –∑–∞—â–∏—â–∞–µ—Ç –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏

**–í—ã–≤–æ–¥:** ‚úÖ **–û—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –í–ù–£–¢–†–ò session**

---

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π**
```javascript
.or(`normalized_domain.eq.${domain},company_name.eq.${name}`)
```

**–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- ‚úÖ –î–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
- ‚ö†Ô∏è OR –ª–æ–≥–∏–∫–∞ - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–≥–∞—è
- ‚ùå –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è ("Èü¶ËÇØ" vs "Èü¶ËÇØ(Wayken)")

**–í—ã–≤–æ–¥:** ‚ö†Ô∏è **–†–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ, –Ω—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è**

---

## üí° –†–ï–®–ï–ù–ò–ï

### **‚ùå –ù–ï –î–ï–õ–ê–¢–¨ `company_name` –ü–û–õ–ù–û–°–¢–¨–Æ UNIQUE!**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. **30% "–¥—É–±–ª–∏–∫–∞—Ç–æ–≤" = –†–ê–ó–ù–´–ï –∫–æ–º–ø–∞–Ω–∏–∏**
   ```
   ‰øäËã± (Junying Manufacturing):
     - –ó–∞–ø–∏—Å—å 1: website A, email A
     - –ó–∞–ø–∏—Å—å 2: website B, email B
     ‚Üí –≠–¢–û 2 –†–ê–ó–ù–´–ï –ö–û–ú–ü–ê–ù–ò–ò!
   ```

2. **–í –ö–∏—Ç–∞–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è**
   - –û–¥–∏–Ω –±—Ä–µ–Ω–¥, —Ä–∞–∑–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª—ã
   - –†–∞–∑–Ω—ã–µ —é—Ä.–ª–∏—Ü–∞, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è

3. **UNIQUE constraint –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏**

---

### **‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï: 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞**

#### **–£—Ä–æ–≤–µ–Ω—å 1: Composite UNIQUE constraint (–ë–î)**

```sql
-- database/migrations/003-composite-unique.sql
CREATE UNIQUE INDEX idx_company_name_domain 
ON pending_companies(company_name, normalized_domain) 
WHERE normalized_domain IS NOT NULL;
```

**–ß—Ç–æ –¥–∞–µ—Ç:**
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: "–æ–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ + –æ–¥–∏–Ω –¥–æ–º–µ–Ω"
- ‚úÖ –†–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã —Å –æ–¥–Ω–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º = —Ä–∞–∑–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–û–ö!)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (–∑–∞—â–∏—Ç–∞ –æ—Ç race conditions)
- ‚ö†Ô∏è –ü–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å website (42%)

---

#### **–£—Ä–æ–≤–µ–Ω—å 2: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –≤ Stage 1**

```javascript
// src/stages/Stage1FindCompanies.js

_normalizeCompanyName(name) {
  if (!name || typeof name !== 'string') return '';
  
  return name
    .toLowerCase()
    .trim()
    // –£–±—Ä–∞—Ç—å –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –≤–Ω—É—Ç—Ä–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
    .replace(/\s+/g, '')
    // –£–±—Ä–∞—Ç—å —Å–∫–æ–±–∫–∏ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (Èü¶ËÇØ(Wayken) ‚Üí Èü¶ËÇØ)
    .replace(/[()ÔºàÔºâ\[\]„Äê„Äë]/g, '')
    // –£–±—Ä–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    .replace(/[.,!?;:Ôºå„ÄÇÔºÅÔºüÔºõÔºö]/g, '');
}

_removeDuplicates(companies) {
  const seenNames = new Set();
  const seenDomains = new Set();
  
  return companies.filter(company => {
    if (!company || !company.name) return false;
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const normalizedName = this._normalizeCompanyName(company.name);
    
    if (seenNames.has(normalizedName)) {
      this.logger.debug('Stage 1: Duplicate name filtered', { 
        original: company.name,
        normalized: normalizedName
      });
      return false;
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
    
    seenNames.add(normalizedName);
    return true;
  });
}
```

**–ß—Ç–æ –¥–∞–µ—Ç:**
- ‚úÖ "Èü¶ËÇØ" –∏ "Èü¶ËÇØ(Wayken)" = –æ–¥–∏–Ω –∫–ª—é—á
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –í–ù–£–¢–†–ò –æ–¥–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Stage 1
- ‚ö†Ô∏è –ù–ï –∑–∞—â–∏—â–∞–µ—Ç –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏

---

#### **–£—Ä–æ–≤–µ–Ω—å 3: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î**

```javascript
// src/stages/Stage1FindCompanies.js

async _saveCompanies(companies, sessionId) {
  // ...
  
  for (const company of companies) {
    const normalizedName = this._normalizeCompanyName(company.name);
    const normalizedDomain = this._extractMainDomain(company.website);
    
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
    let checkQuery = this.db.supabase
      .from('pending_companies')
      .select('company_id, company_name, normalized_domain');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–æ –¥–æ–º–µ–Ω—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (normalizedDomain) {
      checkQuery = checkQuery.eq('normalized_domain', normalizedDomain);
    } else {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ü–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ–º–µ–Ω–∞)
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º LIKE –¥–ª—è –≥–∏–±–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
      const namePattern = `%${normalizedName}%`;
      checkQuery = checkQuery.ilike('company_name', namePattern);
    }
    
    const { data: existing } = await checkQuery.limit(1);
    
    if (existing && existing.length > 0) {
      this.logger.debug('Stage 1: Duplicate detected, skipping', {
        newCompany: company.name,
        normalizedName: normalizedName,
        existingCompany: existing[0].company_name,
        matchedBy: normalizedDomain ? 'domain' : 'name'
      });
      duplicateCount++;
      continue; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    }
    
    // –í—Å—Ç–∞–≤–∫–∞...
  }
}
```

**–ß—Ç–æ –¥–∞–µ—Ç:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –¥–æ–º–µ–Ω—É (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ–º–µ–Ω–∞)
- ‚úÖ ILIKE –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
- ‚úÖ –ó–∞—â–∏—Ç–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏

---

#### **–£—Ä–æ–≤–µ–Ω—å 4: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (—Å–∫—Ä–∏–ø—Ç)**

```bash
# –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
node scripts/deduplicate-by-name-and-domain.js
```

**–ß—Ç–æ –¥–∞–µ—Ç:**
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (merge email/website)
- ‚úÖ –í—ã–±–æ—Ä –ª—É—á—à–µ–π –∑–∞–ø–∏—Å–∏ –ø–æ score

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### **–®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å composite UNIQUE index**
```sql
-- database/migrations/003-composite-unique.sql
CREATE UNIQUE INDEX IF NOT EXISTS idx_company_name_domain 
ON pending_companies(company_name, normalized_domain) 
WHERE normalized_domain IS NOT NULL;
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
psql $DATABASE_URL -f database/migrations/003-composite-unique.sql

# –ù–∞ Railway
railway run psql < database/migrations/003-composite-unique.sql
```

---

### **–®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞–∑–≤–∞–Ω–∏–π –≤ Stage 1**

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/stages/Stage1FindCompanies.js`
  - –î–æ–±–∞–≤–∏—Ç—å `_normalizeCompanyName()`
  - –û–±–Ω–æ–≤–∏—Ç—å `_removeDuplicates()`
  - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `_saveCompanies()`

---

### **–®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –Ω–∞–∑–≤–∞–Ω–∏—è—Ö**

**–¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã:**
```
1. "Èü¶ËÇØ" vs "Èü¶ËÇØ(Wayken)" ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º
2. "ÊòüÈÄü" vs "ÊòüÈÄü (Star Rapid)" ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º
3. "‰øäËã±" vs "‰øäËã± (Junyingufacturing)" ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º
```

---

### **–®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö**

```bash
# Dry run (–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ)
node scripts/deduplicate-by-name-and-domain.js --dry-run

# –†–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
node scripts/deduplicate-by-name-and-domain.js
```

---

### **–®–∞–≥ 5: –î–µ–ø–ª–æ–π –Ω–∞ Railway**

```bash
git add .
git commit -m "feat: 3-level deduplication protection"
git push origin main
```

---

## üéä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### **–î–æ:**
```
–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é: 11 –≥—Ä—É–ø–ø (1.6%)
–í—Å–µ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: 16 –∑–∞–ø–∏—Å–µ–π
–ó–∞—â–∏—â–µ–Ω–æ UNIQUE: 42% –∑–∞–ø–∏—Å–µ–π
```

### **–ü–æ—Å–ª–µ:**
```
–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é: ~2-3 –≥—Ä—É–ø–ø—ã (0.3-0.5%)
–í—Å–µ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ~3-5 –∑–∞–ø–∏—Å–µ–π
–ó–∞—â–∏—â–µ–Ω–æ UNIQUE: 42% –∑–∞–ø–∏—Å–µ–π (domain)
–ó–∞—â–∏—â–µ–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–æ–π: 100% –∑–∞–ø–∏—Å–µ–π (name + domain)
```

**–°–Ω–∏–∂–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ~70-80%**

---

## üö® –†–ò–°–ö–ò –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### **1. –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è**
```
"ABC Manufacturing" vs "ABC Manufacturing Ltd"
‚Üí –û–±–∞ —Å—Ç–∞–Ω—É—Ç "abcmanufacturing"
‚Üí –ë—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –¥—É–±–ª–∏–∫–∞—Ç–æ–º
```

**–†–µ—à–µ–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

---

### **2. ILIKE –º–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º –æ–±—ã—á–Ω—ã–π =**
```sql
.ilike('company_name', '%Èü¶ËÇØ%')
-- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º:
.eq('company_name', 'Èü¶ËÇØ')
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ `company_name`

---

### **3. Composite UNIQUE –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –±–µ–∑ website**
```
58% –∑–∞–ø–∏—Å–µ–π –±–µ–∑ normalized_domain
‚Üí Composite UNIQUE –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç
‚Üí –ó–∞—â–∏—Ç–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –∫–æ–¥–µ
```

**–†–µ—à–µ–Ω–∏–µ:** –£—Ä–æ–≤–µ–Ω—å 3 (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î) –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ

---

## üéØ –ò–¢–û–ì–û–í–û–ï –ú–ù–ï–ù–ò–ï

### **‚ùå –ù–ï –¥–µ–ª–∞—Ç—å `company_name` –ø–æ–ª–Ω–æ—Å—Ç—å—é UNIQUE!**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. 30% "–¥—É–±–ª–∏–∫–∞—Ç–æ–≤" = —Ä–∞–∑–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (—Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã)
2. –ó–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
3. –í –ö–∏—Ç–∞–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è

### **‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å 3-—É—Ä–æ–≤–Ω–µ–≤—É—é –∑–∞—â–∏—Ç—É:**

1. **Composite UNIQUE** (company_name + normalized_domain)
   - –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
   - –î–ª—è –∑–∞–ø–∏—Å–µ–π —Å website

2. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π** (_normalizeCompanyName)
   - –£–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã, —Å–∫–æ–±–∫–∏, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
   - "Èü¶ËÇØ" = "Èü¶ËÇØ(Wayken)"

3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç domain, ILIKE –¥–ª—è name)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
   - –î–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π (100%)

4. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** (—Å–∫—Ä–∏–ø—Ç)
   - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - Merge –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

### **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–∞ 70-80%
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–µ–≥–∏—Ç–∏–º–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions

---

**–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üöÄ

