# 📊 ОБЪЯСНЕНИЕ: Почему показывается 316 компаний вместо 348?

**Дата:** 2025-11-30  
**Версия:** v2.7.2  
**Вопрос пользователя:** "на странице результаты Найденные компании (316). почему 316? проверь логику"

---

## ✅ Это правильное поведение!

### 📊 Математика:

| Показатель | Количество |
|------------|-----------|
| **Всего компаний в БД** | 348 |
| Компании с email | 321 |
| Компании без email | 27 |
| **Уникальных email** | 289 |
| **Дубликаты по email** | 32 |
| | |
| **После дедупликации:** | |
| Компании с уникальным email | 289 |
| Компании без email | +27 |
| **= Показано на странице** | **316** ✅ |

---

## 🔍 Причина: Автоматическая дедупликация по email

### Где происходит:

**Файл:** `public/results.html`  
**Строки:** 869-870

```javascript
allCompanies = data.companies || [];

// ДЕДУПЛИКАЦИЯ ПО EMAIL
allCompanies = deduplicateByEmail(allCompanies);
```

### Логика дедупликации:

**Функция:** `deduplicateByEmail()` (строки 776-848)

**Что делает:**
1. Проходит по всем компаниям
2. Для каждого **уникального email** сохраняет только **одну** компанию
3. Выбирает "лучшую" запись по критериям:
   - Наивысший `validation_score`
   - Наличие сайта
   - Самая ранняя дата создания

**Компании без email:**
Каждой присваивается уникальный ключ `no-email-${company_id}` → все сохраняются.

---

## 📧 Дубликаты по email (32 компании)

### Топ-5 email с наибольшим количеством дубликатов:

1. **`sales@china-machining.com`** - **5 компаний**
   - 中国机械加工（GENSUN）有限公司
   - Gensun精密加工
   - 东莞市根顺精密机械有限公司
   - ゲンサン精密機械加工株式会社
   - Gensun精密制造公司

2. **`info@waykenrm.com`** - **4 компании**
   - 韦肯精密制造有限公司
   - 韦克快速成型制造
   - 深圳韦克快速成型
   - 韦肯 (Wayken)

3. **`info@3erp.com`** - **4 компании**
   - 3ERP精密加工有限公司
   - 3ERP
   - 3ERP精密加工中心
   - 深圳市3ERP精密加工有限公司

4. **`enquiry@nice-rapidtooling.com`** - **4 компании**
   - NICE Rapid
   - 中山尼斯快速制造有限公司
   - 尼斯快速精密制造有限公司
   - Nice Rapid快速制造有限公司

5. **`info@tuofa-cncmachining.com`** - **3 компании**
   - 中国拓发数控加工有限公司
   - 中国拓发
   - 中国拓发 (Tuofa CNC Machining)

**Всего:** 21 email с дубликатами, 32 записи-дубликата

---

## 🎯 Зачем нужна дедупликация?

### Проблема без дедупликации:

Если компания была найдена в **разных запросах** или **разных языках** (中文, 日本語, English), в базе создаются **отдельные записи** с одним и тем же email.

**Пример:**
```
1. 韦肯精密制造有限公司 (info@waykenrm.com) - из китайского запроса
2. Wayken Precision (info@waykenrm.com) - из английского запроса
3. ウェイケン (info@waykenrm.com) - из японского запроса
4. 韦克快速成型制造 (info@waykenrm.com) - из другого запроса
```

Это **одна и та же компания**, но 4 записи в базе!

### Решение:

✅ **Frontend дедупликация** - показывает только **1 лучшую** запись для каждого email  
✅ Пользователь видит **уникальные компании**  
✅ Нет путаницы с дубликатами

---

## 📊 Детальная статистика

### В базе данных:

```
Всего компаний:          348
├─ С email:              321
│  ├─ Уникальных email:  289
│  └─ Дубликаты:          32
└─ Без email:             27
```

### На странице результатов:

```
Показано компаний:       316
├─ С уникальным email:   289 (выбрана лучшая из дубликатов)
└─ Без email:             27 (все показаны)
```

### Скрыто от пользователя:

```
Дубликаты:                32 компании
Причина: Тот же email, что у других компаний
```

---

## 💡 Альтернативные решения

### Вариант 1: Показывать все дубликаты (текущее - НЕТ)

❌ **Минус:** Путаница, одна компания несколько раз  
❌ **Минус:** Сложно понять сколько реально компаний  
❌ **Минус:** Раздутый список

### Вариант 2: Дедупликация на frontend (текущее - ДА) ✅

✅ **Плюс:** Показаны только уникальные компании  
✅ **Плюс:** Выбрана лучшая запись (с validation_score, website)  
✅ **Плюс:** Чистый список для пользователя  
✅ **Плюс:** Гибкость - можно отключить дедупликацию если нужно

### Вариант 3: Дедупликация в БД

✅ **Плюс:** Данные чище в БД  
❌ **Минус:** Теряется информация (разные названия одной компании)  
❌ **Минус:** Сложнее отладка (откуда компания?)

---

## 🔧 Как увидеть все 348 компаний?

### Опция 1: Отключить дедупликацию (временно)

В `results.html`, закомментировать строку 870:

```javascript
allCompanies = data.companies || [];

// ДЕДУПЛИКАЦИЯ ПО EMAIL
// allCompanies = deduplicateByEmail(allCompanies);  // ← Закомментировать
```

### Опция 2: Использовать API напрямую

```bash
curl https://your-domain.railway.app/api/debug/companies?limit=1000
```

Вернет все 348 компаний без дедупликации.

---

## 🎯 Выводы

✅ **316 - правильное число** после дедупликации по email  
✅ **32 дубликата** скрыты для чистоты списка  
✅ **Логика корректна** - показаны уникальные компании  
✅ **Дедупликация полезна** - убирает повторы одной компании

**Ответ на вопрос:** Показывается **316 вместо 348**, потому что **32 компании - дубликаты по email** и автоматически фильтруются на frontend для удобства пользователя.

---

## 📁 Новый инструмент

**Скрипт:** `scripts/check-email-duplicates.js`

**Использование:**
```bash
node scripts/check-email-duplicates.js
```

**Что показывает:**
- Сколько компаний с email
- Сколько уникальных email
- Список всех email с дубликатами
- Детали каждого дубликата

**Полезно для:** Понимания какие компании дублируются и почему.

---

**Дата анализа:** 2025-11-30  
**Статус:** ✅ Логика проверена и объяснена  
**Вывод:** Все работает корректно!

