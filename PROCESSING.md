# üìò –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (Stage 1-6)

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ Smart Email API —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ 6 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤. –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Perplexity API –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–ø–∞–Ω–∏—è—Ö.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
QueryOrchestrator (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)
    ‚îú‚îÄ‚îÄ Stage 1: FindCompanies (–ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π)
    ‚îú‚îÄ‚îÄ Stage 2: FindWebsites (–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤)
    ‚îú‚îÄ‚îÄ Stage 3: AnalyzeContacts (–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
    ‚îú‚îÄ‚îÄ Stage 4: AnalyzeServices (–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥)
    ‚îú‚îÄ‚îÄ Stage 5: GenerateTags (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤)
    ‚îî‚îÄ‚îÄ Stage 6: Finalize (–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
```

---

## üìã –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏

### Stage 1: –ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π
**–§–∞–π–ª:** `src/stages/Stage1FindCompanies.js`

**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ 8-12 –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Perplexity —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏:
   - –¢–æ–ª—å–∫–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ (–Ω–µ –¥–∏–ª–µ—Ä—ã)
   - –î–µ–π—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
   - –° –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ –≤–µ–±-—Å–∞–π—Ç–∞–º–∏
2. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Sonar API
3. –ü–∞—Ä—Å–∏—Ç JSON —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∫–æ–º–ø–∞–Ω–∏–π
4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ < 8 –∫–æ–º–ø–∞–Ω–∏–π ‚Üí –¥–µ–ª–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –¥—Ä—É–≥–∏–º —É–≥–ª–æ–º
5. –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `pending_companies` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `names_found`

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```
"‰∏çÈîàÈí¢Êï∞ÊéßËΩ¶Èì£Âä†Â∑•" ‚Üí 10 –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "companies": [...],
  "count": 10
}
```

---

### Stage 2: –ü–æ–∏—Å–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
**–§–∞–π–ª:** `src/stages/Stage2FindWebsites.js`

**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ URL –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `names_found`
2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞—Ç—á–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3 –∫–æ–º–ø–∞–Ω–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
3. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏:
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É Perplexity –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–æ–º–µ–Ω (.cn, .com.cn, .net.cn, .com)
   - –ò—Å–∫–ª—é—á–∞–µ—Ç –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã (Alibaba, 1688)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç URL –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `website_found`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- `stage2_concurrent_requests`: –∫–æ–ª-–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3)
- `stage2_batch_delay_ms`: –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2000 –º—Å)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "total": 10,
  "found": 8,
  "notFound": 2
}
```

---

### Stage 3: –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
**–§–∞–π–ª:** `src/stages/Stage3AnalyzeContacts.js`

**–¶–µ–ª—å:** –ò–∑–≤–ª–µ—á—å email –∞–¥—Ä–µ—Å–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `website_found`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∞–π—Ç–∞:
   - –ò—â–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (Contact, About Us)
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ email –∞–¥—Ä–µ—Å–∞
   - –ò—Å–∫–ª—é—á–∞–µ—Ç –æ–±—â–∏–µ –∞–¥—Ä–µ—Å–∞ (info@, admin@, webmaster@)
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: sales@, export@, international@
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤ `contacts_json`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `site_analyzed`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- `stage3_concurrent_requests`: –∫–æ–ª-–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)
- `stage3_batch_delay_ms`: –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3000 –º—Å)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "processed": 8,
  "found": 6
}
```

---

### Stage 4: –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥
**–§–∞–π–ª:** `src/stages/Stage4AnalyzeServices.js`

**–¶–µ–ª—å:** –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥–∏ –∏ –ø—Ä–æ–¥—É–∫—Ü–∏—é –∫–æ–º–ø–∞–Ω–∏–∏.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `site_analyzed`
2. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç:
   - –û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ö–ª—é—á–µ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã
   - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –≤ `services_json`

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:**
```json
{
  "main_activity": "–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Ä–∂–∞–≤–µ—é—â–µ–π —Å—Ç–∞–ª–∏",
  "services": ["CNC –æ–±—Ä–∞–±–æ—Ç–∫–∞", "–¢–æ–∫–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã", "–§—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–∏–µ"],
  "products": ["–î–µ—Ç–∞–ª–∏ –º–∞—à–∏–Ω", "–ö—Ä–µ–ø–µ–∂", "–ü—Ä–µ—Å—Å-—Ñ–æ—Ä–º—ã"],
  "capabilities": ["–ß–ü–£ 5-–æ—Å–µ–≤–æ–µ", "–ü—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞"],
  "advantages": ["ISO 9001", "–ë—ã—Å—Ç—Ä—ã–µ —Å—Ä–æ–∫–∏", "–ù–∏–∑–∫–∏–µ —Ü–µ–Ω—ã"],
  "summary": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Ä–∂–∞–≤–µ—é—â–µ–π —Å—Ç–∞–ª–∏ —Å –ß–ü–£"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "processed": 6
}
```

---

### Stage 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤
**–§–∞–π–ª:** `src/stages/Stage5GenerateTags.js`

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å —Ç–µ–≥–∏ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `site_analyzed`
2. –ù–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ª—É–≥ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ 10 —Ç–µ–≥–æ–≤
3. –¢–µ–≥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ (1-3 —Å–ª–æ–≤–∞)
4. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –º–∞—Å—Å–∏–≤ `tags`
6. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `tags_extracted`

**–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–≥–æ–≤:**
```
cnc-machining, metal-fabrication, stainless-steel,
precision-parts, injection-molding, die-casting,
aluminum-extrusion, sheet-metal, welding
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- `stage5_max_tags`: –º–∞–∫—Å–∏–º—É–º —Ç–µ–≥–æ–≤ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "processed": 6
}
```

---

### Stage 6: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
**–§–∞–π–ª:** `src/stages/Stage6Finalize.js`

**–¶–µ–ª—å:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ `pending_companies` –≤ `company_records`.

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `tags_extracted`
2. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–∞–π—Ç, email)
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ URL
4. –ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
5. –ï—Å–ª–∏ –Ω–æ–≤–∞—è ‚Üí —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `company_records`
6. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `completed`
7. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ `companies_added` –≤ —Å–µ—Å—Å–∏–∏

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–æ–ø—É—Å–∫–∞:**
- –ù–µ—Ç email –∞–¥—Ä–µ—Å–æ–≤ ‚Üí –ø—Ä–æ–ø—É—Å–∫
- –ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π ‚Üí –ø—Ä–æ–ø—É—Å–∫

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "finalized": 5,
  "skipped": 1
}
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ß–µ—Ä–µ–∑ API (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

#### –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é:
```bash
curl -X POST http://localhost:3030/api/sessions \
  -H "Content-Type: application/json" \
  -d '{
    "search_query": "‰∏çÈîàÈí¢Êï∞ÊéßËΩ¶Èì£Âä†Â∑•",
    "target_count": 10,
    "priority": "balanced",
    "auto_start": true
  }'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "search_query": "‰∏çÈîàÈí¢Êï∞ÊéßËΩ¶Èì£Âä†Â∑•",
    "target_count": 10,
    "status": "active",
    "processing_started": true
  }
}
```

#### –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ä—É—á–Ω—É—é:
```bash
curl -X POST http://localhost:3030/api/sessions/{session_id}/process
```

#### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å:
```bash
curl http://localhost:3030/api/sessions/{session_id}/progress
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "session_id": "...",
    "status": "active",
    "progress_percent": 60,
    "companies_found": 10,
    "companies_analyzed": 6,
    "companies_added": 5,
    "stages": {
      "names_found": 10,
      "website_found": 8,
      "site_analyzed": 6,
      "tags_extracted": 6,
      "completed": 5,
      "failed": 1
    },
    "perplexity_api_calls": 32,
    "perplexity_tokens_used": 8540,
    "cache_hits": 5
  }
}
```

### 2. –ß–µ—Ä–µ–∑ Web UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3030
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å"
3. –£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π
4. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é"
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ session_id –∏–∑ –æ—Ç–≤–µ—Ç–∞
6. –í—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"
7. –ù–∞–∂–º–∏—Ç–µ "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ `processing_stages`:

```javascript
{
  // Stage 1
  "stage1_min_companies": 8,
  "stage1_max_companies": 12,
  
  // Stage 2
  "stage2_concurrent_requests": 3,
  "stage2_batch_delay_ms": 2000,
  
  // Stage 3
  "stage3_concurrent_requests": 2,
  "stage3_batch_delay_ms": 3000,
  
  // Stage 4
  "stage4_concurrent_requests": 2,
  "stage4_batch_delay_ms": 3000,
  
  // Stage 5
  "stage5_max_tags": 10
}
```

**–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É:**
```bash
curl -X PUT http://localhost:3030/api/settings/processing_stages/stage2_concurrent_requests \
  -H "Content-Type: application/json" \
  -d '{
    "value": 5,
    "reason": "–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º"
  }'
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
–í—Å–µ —ç—Ç–∞–ø—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Winston:
```
[info] Orchestrator: Starting session processing {sessionId: "..."}
[info] Orchestrator: Stage 1 - Finding companies
[info] Stage 1: Completed {found: 10}
[info] Orchestrator: Stage 2 - Finding websites
[info] Stage 2: Completed {found: 8, notFound: 2}
...
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ API
```bash
curl http://localhost:3030/api/sessions/{session_id}/progress
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —ç—Ç–∞–ø–∞–º
SELECT stage, COUNT(*) 
FROM pending_companies 
WHERE session_id = '...'
GROUP BY stage;

-- –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
SELECT COUNT(*) 
FROM company_records 
WHERE session_id = '...';
```

---

## ‚ö†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
1. **Perplexity API –∫–ª—é—á** - –±–µ–∑ –Ω–µ–≥–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   ```bash
   curl -X PUT http://localhost:3030/api/settings/api/api_key \
     -H "Content-Type: application/json" \
     -d '{"value": "pplx-–≤–∞—à-–∫–ª—é—á", "reason": "Setup"}'
   ```

2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - PostgreSQL –∏–ª–∏ Mock Database

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–∞–±–ª–∏—Ü–∞ `perplexity_cache`)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ rate limiting
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

---

## üîß –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞: Stage 1 –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–º–ø–∞–Ω–∏–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á Perplexity
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º)
- –£–≤–µ–ª–∏—á—å—Ç–µ `stage1_max_companies`

### –ü—Ä–æ–±–ª–µ–º–∞: Stage 2 –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–∞–π—Ç—ã
**–†–µ—à–µ–Ω–∏–µ:**
- –£–º–µ–Ω—å—à–∏—Ç–µ `stage2_concurrent_requests` (–º–æ–∂–µ—Ç –±—ã—Ç—å rate limit)
- –£–≤–µ–ª–∏—á—å—Ç–µ `stage2_batch_delay_ms`

### –ü—Ä–æ–±–ª–µ–º–∞: Stage 3 –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç email
**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–∏—Ç–∞–π—Å–∫–∏–µ —Å–∞–π—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ–æ—Ä–º—ã –≤–º–µ—Å—Ç–æ email

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `stage2_concurrent_requests` –∏ `stage3_concurrent_requests`
- –£–º–µ–Ω—å—à–∏—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (`*_batch_delay_ms`)
- –í–∫–ª—é—á–∏—Ç–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢–∏–ø–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
- **Stage 1:** ~5-10 —Å–µ–∫ (1 –∑–∞–ø—Ä–æ—Å –∫ API)
- **Stage 2:** ~30-60 —Å–µ–∫ (8-12 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
- **Stage 3:** ~20-40 —Å–µ–∫ (6-8 –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Stage 4:** ~20-40 —Å–µ–∫ (6-8 –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Stage 5:** ~15-30 —Å–µ–∫ (6-8 –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Stage 6:** ~1-2 —Å–µ–∫ (—Ä–∞–±–æ—Ç–∞ —Å –ë–î)

**–ò—Ç–æ–≥–æ:** ~2-3 –º–∏–Ω—É—Ç—ã –Ω–∞ 10 –∫–æ–º–ø–∞–Ω–∏–π

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ 30-50%
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ —É—Å–∫–æ—Ä—è–µ—Ç Stage 2-5
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ priority="fast" —É—Å–∫–æ—Ä—è–µ—Ç –Ω–∞ 20%

---

## üéØ Best Practices

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —ç–∫–æ–Ω–æ–º–∏—Ç API —Ç–æ–∫–µ–Ω—ã
2. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/progress` endpoint
3. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏** - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏
4. **–ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π—Ç–µ API** - —Å–æ–±–ª—é–¥–∞–π—Ç–µ rate limits
5. **–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö

---

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ

